<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WordSpark</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0f0e0c; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react,env">
const { useState, useEffect, useRef, useCallback } = React;


/* ═══════════════════════════════════════════════════════════════════════════
   WORD DATABASE — 40 WORDS WITH FULL ETYMOLOGY
   ═══════════════════════════════════════════════════════════════════════════ */
const WORD_BANK = [
  { word:"ephemeral", def:"Lasting for a very short time", pos:"adj", ipa:"/ɪˈfɛm.ər.əl/", origin:"Greek", year:"1560s", etymology:"From Greek ephēmeros — 'lasting only a day'", roots:[{part:"epi-",meaning:"upon",lang:"Greek"},{part:"hēmera",meaning:"day",lang:"Greek"}], evolution:["ephēmeros (Grk)","ephemerus (Lat)","éphémère (Fr)","ephemeral"], relatives:["ephemera","ephemeris"], funFact:"Originally a medical term for fevers lasting only a day. Mayflies (Ephemeroptera) live just 24 hours as adults." },
  { word:"mellifluous", def:"Sweet-sounding; pleasant to hear", pos:"adj", ipa:"/mɛˈlɪf.lu.əs/", origin:"Latin", year:"1400s", etymology:"From Latin mellifluus — 'flowing with honey'", roots:[{part:"mel",meaning:"honey",lang:"Latin"},{part:"fluere",meaning:"to flow",lang:"Latin"}], evolution:["mellifluus (Lat)","mellifluous (Eng)"], relatives:["fluent","fluid","confluence","superfluous"], funFact:"The root 'mel' also gives us 'molasses' (via Portuguese) and 'marmalade' (via Greek melimelon, 'honey apple')." },
  { word:"serendipity", def:"Happy discoveries made by chance", pos:"noun", ipa:"/ˌsɛr.ənˈdɪp.ɪ.ti/", origin:"English (coined)", year:"1754", etymology:"Coined by Horace Walpole from 'The Three Princes of Serendip'", roots:[{part:"Serendip",meaning:"old name for Sri Lanka",lang:"Persian"},{part:"-ity",meaning:"quality of",lang:"Latin suffix"}], evolution:["Sarandīb (Arabic)","Serendip (Persian)","serendipity (1754)"], relatives:["serendipitous"], funFact:"One of few English words with a precise birthday: January 28, 1754, in a letter by Walpole." },
  { word:"sycophant", def:"A person who flatters to gain advantage", pos:"noun", ipa:"/ˈsɪk.ə.fænt/", origin:"Greek", year:"1530s", etymology:"From Greek sykophantēs — literally 'one who shows the fig'", roots:[{part:"sykon",meaning:"fig",lang:"Greek"},{part:"phainein",meaning:"to show",lang:"Greek"}], evolution:["sykophantēs (Grk)","sycophanta (Lat)","sycophant"], relatives:["sycophancy","epiphany","phenomenon","phantom"], funFact:"One theory: exporting figs from Athens was illegal, and informers who reported violators were called 'fig-showers.'" },
  { word:"nostalgia", def:"A sentimental longing for the past", pos:"noun", ipa:"/nɒˈstæl.dʒə/", origin:"Greek (coined)", year:"1688", etymology:"Coined by Swiss physician Johannes Hofer as a medical diagnosis for severe homesickness", roots:[{part:"nostos",meaning:"homecoming",lang:"Greek"},{part:"algos",meaning:"pain",lang:"Greek"}], evolution:["nostos + algos (Grk)","nostalgia (New Latin, 1688)","nostalgia (Eng)"], relatives:["nostalgic","neuralgia","analgesic"], funFact:"Originally a real medical condition! Swiss soldiers abroad were prescribed opium, leeches, and trips to the Alps." },
  { word:"algorithm", def:"A process or set of rules for problem-solving", pos:"noun", ipa:"/ˈæl.ɡə.rɪð.əm/", origin:"Arabic", year:"1200s", etymology:"From the Latinized name of Persian mathematician al-Khwārizmī", roots:[{part:"al-Khwārizmī",meaning:"the one from Khwarezm (Uzbekistan)",lang:"Arabic"}], evolution:["al-Khwārizmī (Arabic)","algorismus (Med. Latin)","algorithm (Eng)"], relatives:["algebra","algorism","arithmetic"], funFact:"Al-Khwārizmī's 9th-century book was so influential his name became the word for mathematical procedures. His other book gave us 'algebra.'" },
  { word:"lunatic", def:"Wildly foolish or mentally unstable", pos:"noun/adj", ipa:"/ˈluː.nə.tɪk/", origin:"Latin", year:"1290s", etymology:"From Latin lunaticus — 'moon-struck'", roots:[{part:"luna",meaning:"the moon",lang:"Latin"},{part:"-aticus",meaning:"pertaining to",lang:"Latin"}], evolution:["luna (Lat)","lunaticus (Lat)","lunatique (OFr)","lunatic"], relatives:["lunar","lunacy","sublunary"], funFact:"English law once defined a lunatic as someone who lost reason 'upon the full of the moon.' Studies show no real correlation." },
  { word:"disaster", def:"A sudden event causing great damage", pos:"noun", ipa:"/dɪˈzæs.tər/", origin:"Italian/Greek", year:"1590s", etymology:"From Italian disastro — literally 'ill-starred'", roots:[{part:"dis-",meaning:"away, negation",lang:"Latin"},{part:"astro",meaning:"star",lang:"Greek"}], evolution:["astron (Grk)","disastro (Ital)","désastre (Fr)","disaster"], relatives:["asteroid","astronomy","astrology","astronaut"], funFact:"Reflects the belief that stars governed fate. Shakespeare's King Lear blames 'these late eclipses' for social chaos." },
  { word:"quarantine", def:"Isolation to prevent spread of disease", pos:"noun", ipa:"/ˈkwɒr.ən.tiːn/", origin:"Italian", year:"1660s", etymology:"From Italian quarantina — 'space of forty days'", roots:[{part:"quaranta",meaning:"forty",lang:"Italian"},{part:"-ina",meaning:"period of",lang:"Italian"}], evolution:["quadraginta (Lat)","quaranta (Ital)","quarantina","quarantine"], relatives:["quarter","quadrant","quaternary"], funFact:"During the Black Death, Venice required ships to anchor 40 days before landing. Why 40? Possibly biblical — Moses, Jesus both had 40-day trials." },
  { word:"sarcasm", def:"Irony used to mock or convey contempt", pos:"noun", ipa:"/ˈsɑːr.kæz.əm/", origin:"Greek", year:"1570s", etymology:"From Greek sarkasmos — 'to tear flesh, gnash teeth'", roots:[{part:"sarx",meaning:"flesh",lang:"Greek"},{part:"sarkazein",meaning:"to strip off flesh",lang:"Greek"}], evolution:["sarkazein (Grk)","sarkasmos (Grk)","sarcasmus (Lat)","sarcasm"], relatives:["sarcastic","sarcophagus","sarcoma"], funFact:"Sarcophagus ('flesh-eater') shares the same root — the limestone was believed to decompose bodies. Sarcasm and sarcophagus: etymological cousins." },
  { word:"clue", def:"Evidence that helps solve a mystery", pos:"noun", ipa:"/kluː/", origin:"Greek myth", year:"1590s", etymology:"From 'clew,' a ball of thread — referencing Theseus and the Minotaur", roots:[{part:"clew",meaning:"ball of yarn",lang:"Old English"}], evolution:["cliwen (OE)","clewe (Mid.Eng)","clew/clue (figurative)"], relatives:["clew (nautical)","unravel"], funFact:"Theseus navigated the Minotaur's labyrinth by unwinding a 'clew' of thread. A 'clue' literally guides you through a maze of confusion." },
  { word:"salary", def:"A fixed regular payment for work", pos:"noun", ipa:"/ˈsæl.ər.i/", origin:"Latin", year:"1300s", etymology:"From Latin salarium — 'salt money' paid to Roman soldiers", roots:[{part:"sal",meaning:"salt",lang:"Latin"},{part:"-arium",meaning:"connected to",lang:"Latin"}], evolution:["sal (Lat)","salarium (Lat)","salaire (OFr)","salary"], relatives:["saline","salad","sauce","sausage"], funFact:"Roman soldiers were partly paid in salt — it was crucial for food preservation. 'Worth his salt' comes from this same idea." },
  { word:"muscle", def:"Fibrous tissue that contracts for movement", pos:"noun", ipa:"/ˈmʌs.əl/", origin:"Latin", year:"1530s", etymology:"From Latin musculus — literally 'little mouse'", roots:[{part:"mus",meaning:"mouse",lang:"Latin"},{part:"-culus",meaning:"little",lang:"Latin"}], evolution:["mus (Lat)","musculus (Lat)","muscle (OFr)","muscle"], relatives:["mussel","mouse","muscular"], funFact:"Romans thought a flexing bicep looked like a mouse running under skin. Greeks agreed — mys meant both 'mouse' and 'muscle.' Mussel the shellfish: also mouse-shaped." },
  { word:"psychology", def:"The study of mind and behavior", pos:"noun", ipa:"/saɪˈkɒl.ə.dʒi/", origin:"Greek", year:"1650s", etymology:"From Greek psykhē (soul/mind) + logos (study)", roots:[{part:"psykhē",meaning:"soul, breath of life",lang:"Greek"},{part:"logos",meaning:"study, reason",lang:"Greek"}], evolution:["psykhē + logos (Grk)","psychologia (New Lat)","psychology"], relatives:["psyche","psychiatry","psychedelic","logic"], funFact:"Psykhē means 'breath' — Greeks equated breath with the soul, since it leaves at death. In myth, Psyche was a mortal whose name became synonymous with the human soul." },
  { word:"toxic", def:"Poisonous; harmful or destructive", pos:"adj", ipa:"/ˈtɒk.sɪk/", origin:"Greek", year:"1660s", etymology:"From Greek toxikon pharmakon — 'poison for arrows'", roots:[{part:"toxon",meaning:"bow (archery)",lang:"Greek"},{part:"-ikon",meaning:"pertaining to",lang:"Greek"}], evolution:["toxon (Grk)","toxikon (Grk)","toxicum (Lat)","toxic"], relatives:["toxin","toxicology","intoxicate"], funFact:"The word for 'poison' comes from 'bow' — Scythians coated arrowheads in poison. 'Intoxicate' literally means 'to put arrow-poison into' someone." },
  { word:"trivial", def:"Of little value or importance", pos:"adj", ipa:"/ˈtrɪv.i.əl/", origin:"Latin", year:"1430s", etymology:"From Latin trivialis — 'found at the crossroads, commonplace'", roots:[{part:"tri-",meaning:"three",lang:"Latin"},{part:"via",meaning:"road",lang:"Latin"}], evolution:["trivium (Lat)","trivialis (Lat)","trivial"], relatives:["trivia","via","deviate","voyage"], funFact:"Where three roads met, people chatted about unimportant things. In medieval universities, the 'trivium' was the 'easy' introductory curriculum." },
  { word:"candidate", def:"A person nominated for a position", pos:"noun", ipa:"/ˈkæn.dɪ.deɪt/", origin:"Latin", year:"1600s", etymology:"From Latin candidatus — 'one dressed in white'", roots:[{part:"candidus",meaning:"white, shining",lang:"Latin"},{part:"-atus",meaning:"clothed in",lang:"Latin"}], evolution:["candere (Lat)","candidus","candidatus","candidate"], relatives:["candid","candle","candor","incandescent","chandelier"], funFact:"Roman politicians wore whitened togas (toga candida) to symbolize purity. 'Candidate' = 'the one in the white toga.' Same root gives us 'candle.'" },
  { word:"companion", def:"A person one spends time with", pos:"noun", ipa:"/kəmˈpæn.jən/", origin:"Latin", year:"1300s", etymology:"From Latin companio — 'one who shares bread'", roots:[{part:"com-",meaning:"together",lang:"Latin"},{part:"panis",meaning:"bread",lang:"Latin"}], evolution:["com + panis (Lat)","companio","compaignon (OFr)","companion"], relatives:["company","accompany","pantry","panini"], funFact:"Your 'companion' is someone you break bread with. Even 'lord' comes from Old English hlāford: 'loaf-guardian.'" },
  { word:"vaccine", def:"A substance stimulating immunity", pos:"noun", ipa:"/ˈvæk.siːn/", origin:"Latin", year:"1799", etymology:"From Latin vaccinus — 'pertaining to cows'", roots:[{part:"vacca",meaning:"cow",lang:"Latin"},{part:"-inus",meaning:"of the nature of",lang:"Latin"}], evolution:["vacca (Lat)","vaccinus","vaccine (coined by Jenner)"], relatives:["vaccinate","vaccination","vaquero"], funFact:"Jenner noticed milkmaids who caught cowpox never got smallpox. Every time we say 'vaccine' we're literally saying 'cow stuff.'" },
  { word:"mortgage", def:"A loan secured against property", pos:"noun", ipa:"/ˈmɔːr.ɡɪdʒ/", origin:"Old French", year:"1390s", etymology:"From Old French mort gage — literally 'death pledge'", roots:[{part:"mort",meaning:"death",lang:"Old French"},{part:"gage",meaning:"pledge",lang:"Old French"}], evolution:["mors (Lat) + wadium (Gmc)","mort gage (OFr)","mortgage"], relatives:["mortal","mortuary","mortify","wage","wager"], funFact:"Called 'death pledge' because the deal 'dies' one way or another: debt paid (pledge dies) or payment fails (deal dies)." },
  { word:"gymnasium", def:"A building for physical exercise", pos:"noun", ipa:"/dʒɪmˈneɪ.zi.əm/", origin:"Greek", year:"1590s", etymology:"From Greek gymnasion — 'a place to exercise naked'", roots:[{part:"gymnos",meaning:"naked",lang:"Greek"},{part:"-asion",meaning:"place for",lang:"Greek"}], evolution:["gymnos (Grk)","gymnasion","gymnasium"], relatives:["gymnastics","gymnast","gymnosperm"], funFact:"Greek athletes trained completely nude. Plato's Academy and Aristotle's Lyceum were both gymnasia. Pine trees are 'gymnosperms' — 'naked seeds.'" },
  { word:"barbarian", def:"A person from an 'uncivilized' culture", pos:"noun", ipa:"/bɑːrˈbɛər.i.ən/", origin:"Greek", year:"1400s", etymology:"From Greek barbaros — imitating incomprehensible speech: 'bar-bar-bar'", roots:[{part:"barbaros",meaning:"foreign, one who babbles",lang:"Greek"}], evolution:["barbaros (Grk)","barbarus (Lat)","barbare (OFr)","barbarian"], relatives:["barbaric","barbarous","Barbary Coast"], funFact:"To Greeks, foreign languages sounded like 'bar bar bar.' Sanskrit barbara also means 'stammering.' One of history's oldest examples of linguistic ethnocentrism." },
  { word:"panic", def:"Sudden uncontrollable fear", pos:"noun", ipa:"/ˈpæn.ɪk/", origin:"Greek myth", year:"1600s", etymology:"From Greek panikos — 'of the god Pan'", roots:[{part:"Pan",meaning:"god of forests and wild nature",lang:"Greek"},{part:"-ikos",meaning:"pertaining to",lang:"Greek"}], evolution:["Pan (god)","panikos (Grk)","panicus (Lat)","panic"], relatives:["pandemic","panorama","panacea"], funFact:"Pan lurked in remote places causing sudden, irrational terror — especially at noon when forests went silent. Greeks blamed Pan for mysterious stampedes of herds." },
  { word:"supercilious", def:"Acting as though superior to others", pos:"adj", ipa:"/ˌsuː.pərˈsɪl.i.əs/", origin:"Latin", year:"1520s", etymology:"From Latin supercilium — literally 'eyebrow'", roots:[{part:"super-",meaning:"above",lang:"Latin"},{part:"cilium",meaning:"eyelid",lang:"Latin"}], evolution:["supercilium (Lat)","superciliosus (Lat)","supercilious"], relatives:["superb","superficial","cilia"], funFact:"The raised eyebrow is a universal gesture of condescension. Romans were so aware of this that 'eyebrow' became their word for arrogance itself." },
  { word:"galaxy", def:"A system of millions of stars", pos:"noun", ipa:"/ˈɡæl.ək.si/", origin:"Greek", year:"1380s", etymology:"From Greek galaxias kyklos — 'milky circle'", roots:[{part:"gala",meaning:"milk",lang:"Greek"},{part:"-xias",meaning:"pertaining to",lang:"Greek"}], evolution:["gala (Grk)","galaxias kyklos","galaxia (Lat)","galaxy"], relatives:["galactic","lactic","lactose","lettuce"], funFact:"In myth, baby Heracles was pushed from Hera's breast, spraying milk across the sky — creating the Milky Way. Greek gala and Latin lac are related, linking 'galaxy' and 'lactose.'" },
  { word:"amnesty", def:"An official pardon for offenses", pos:"noun", ipa:"/ˈæm.nə.sti/", origin:"Greek", year:"1570s", etymology:"From Greek amnēstia — 'forgetfulness, oblivion'", roots:[{part:"a-",meaning:"not, without",lang:"Greek"},{part:"mnēstis",meaning:"remembrance",lang:"Greek"}], evolution:["amnēstia (Grk)","amnestia (Lat)","amnistie (Fr)","amnesty"], relatives:["amnesia","mnemonic","Mnemosyne"], funFact:"Amnesty and amnesia are siblings — both mean 'forgetting.' Mnemosyne (Memory) was mother of the nine Muses — art springs from remembering." },
  { word:"inaugurate", def:"To begin formally or install in office", pos:"verb", ipa:"/ɪˈnɔː.ɡjʊ.reɪt/", origin:"Latin", year:"1600s", etymology:"From Latin inaugurare — 'to take omens from bird flight'", roots:[{part:"in-",meaning:"into",lang:"Latin"},{part:"augurare",meaning:"to divine from birds",lang:"Latin"}], evolution:["augur (Lat)","inaugurare (Lat)","inaugurer (Fr)","inaugurate"], relatives:["augur","augment","august"], funFact:"Romans read bird flight patterns before any important undertaking. Every presidential inauguration etymologically involves checking if the birds say it's okay." },
  { word:"sincere", def:"Free from pretense; genuine", pos:"adj", ipa:"/sɪnˈsɪər/", origin:"Latin", year:"1530s", etymology:"From Latin sincerus — 'clean, pure, whole'", roots:[{part:"sin-",meaning:"one",lang:"Latin"},{part:"-cerus",meaning:"growth",lang:"Latin"}], evolution:["sincerus (Lat)","sincère (Fr)","sincere"], relatives:["sincerity","sincerely"], funFact:"Folk etymology claims it's from 'sine cera' (without wax) — sculptors hiding marble flaws. Almost certainly false but wonderfully persistent." },
  { word:"ubiquitous", def:"Found everywhere", pos:"adj", ipa:"/juːˈbɪk.wɪ.təs/", origin:"Latin", year:"1830s", etymology:"From Latin ubique — 'everywhere'", roots:[{part:"ubi",meaning:"where",lang:"Latin"},{part:"-que",meaning:"universalizing suffix",lang:"Latin"}], evolution:["ubique (Lat)","ubiquitas (Med Lat)","ubiquitous"], relatives:["ubiquity","ubiquitously"], funFact:"In theology, 'ubiquity' described God's omnipresence. Entered everyday English in the 19th century when mass production made goods truly 'everywhere.'" },
  { word:"hippopotamus", def:"A large African semi-aquatic mammal", pos:"noun", ipa:"/ˌhɪp.əˈpɒt.ə.məs/", origin:"Greek", year:"1560s", etymology:"From Greek hippopotamos — 'river horse'", roots:[{part:"hippos",meaning:"horse",lang:"Greek"},{part:"potamos",meaning:"river",lang:"Greek"}], evolution:["hippos + potamos (Grk)","hippopotamus (Lat)","hippopotamus"], relatives:["hippodrome","Philip ('horse-lover')","Mesopotamia ('between rivers')","potable"], funFact:"The name 'Philip' shares the hippo- root — it means 'lover of horses.' Mesopotamia shares potamos — 'between rivers.' A hippodrome is where horses run." },
  { word:"decimate", def:"To destroy a large proportion of", pos:"verb", ipa:"/ˈdɛs.ɪ.meɪt/", origin:"Latin", year:"1600s", etymology:"From Latin decimare — 'to take a tenth'", roots:[{part:"decimus",meaning:"tenth",lang:"Latin"},{part:"-are",meaning:"to do",lang:"Latin"}], evolution:["decem (Lat,'ten')","decimare (Lat)","décimer (Fr)","decimate"], relatives:["decimal","December","decade","dime"], funFact:"Roman military punishment: kill every tenth soldier by lot. The word meant exactly 10% destruction. December was the 10th month before January and February were added." },
  { word:"cynic", def:"A person who distrusts human sincerity", pos:"noun", ipa:"/ˈsɪn.ɪk/", origin:"Greek", year:"1540s", etymology:"From Greek kynikos — 'dog-like'", roots:[{part:"kyon",meaning:"dog",lang:"Greek"}], evolution:["kyon (Grk)","kynikos (Grk)","cynicus (Lat)","cynic"], relatives:["cynical","canine","kennel"], funFact:"The philosopher Diogenes lived like a dog — sleeping in a barrel, eating scraps, performing bodily functions in public. His followers were called 'dog philosophers.' Same root gives us 'canine.'" },
  { word:"enthusiasm", def:"Intense enjoyment or eager interest", pos:"noun", ipa:"/ɪnˈθjuː.zi.æz.əm/", origin:"Greek", year:"1600s", etymology:"From Greek enthousiasmos — 'divine possession, to be inspired by a god'", roots:[{part:"en-",meaning:"in",lang:"Greek"},{part:"theos",meaning:"god",lang:"Greek"}], evolution:["en + theos (Grk)","enthousiasmos","enthusiasm"], relatives:["enthusiast","theology","theocracy","atheist","pantheon"], funFact:"Originally meant 'possessed by a god.' Being enthusiastic was literally having a deity inside you. Initially used negatively — religious fanatics were called 'enthusiasts.'" },
  { word:"diploma", def:"A certificate of academic achievement", pos:"noun", ipa:"/dɪˈploʊ.mə/", origin:"Greek", year:"1640s", etymology:"From Greek diploma — 'a paper folded double'", roots:[{part:"diploun",meaning:"to fold double",lang:"Greek"},{part:"di-",meaning:"two",lang:"Greek"}], evolution:["diploun (Grk)","diploma (Lat)","diploma (Eng)"], relatives:["diplomat","diplomacy","diploid","double"], funFact:"Roman passports and official documents were folded in two and sealed. The word for these folded papers became 'diploma.' A 'diplomat' is literally someone who carries folded papers." },
  { word:"rival", def:"A person competing with another", pos:"noun", ipa:"/ˈraɪ.vəl/", origin:"Latin", year:"1570s", etymology:"From Latin rivalis — 'one using the same stream as another'", roots:[{part:"rivus",meaning:"stream, brook",lang:"Latin"}], evolution:["rivus (Lat)","rivalis (Lat)","rival (Fr)","rival"], relatives:["river","rivulet","derive","arrive"], funFact:"Neighbors sharing a stream (rivus) inevitably argued over water rights, making them 'rivals.' The concept of competition literally flows from disputes over water." },
  { word:"calculate", def:"To determine by mathematical process", pos:"verb", ipa:"/ˈkæl.kjʊ.leɪt/", origin:"Latin", year:"1560s", etymology:"From Latin calculare — 'to reckon by means of pebbles'", roots:[{part:"calculus",meaning:"small stone, pebble",lang:"Latin"}], evolution:["calx (Lat,'limestone')","calculus (Lat,'pebble')","calculare","calculate"], relatives:["calculus","calcium","chalk"], funFact:"Romans used small stones (calculi) on counting boards — an abacus made of pebbles. Higher math is still called 'calculus.' And 'calcium' is theite mineral in those stones." },
  { word:"Antarctica", def:"The southernmost continent", pos:"noun", ipa:"/ænˈtɑːrk.tɪ.kə/", origin:"Greek", year:"1300s", etymology:"From Greek antarktikos — 'opposite the bear (constellation)'", roots:[{part:"anti-",meaning:"opposite",lang:"Greek"},{part:"arktos",meaning:"bear",lang:"Greek"}], evolution:["arktos (Grk,'bear')","arktikos (Grk)","antarktikos","Antarctica"], relatives:["Arctic","Ursa Major","Arthur (possibly)"], funFact:"The Arctic is named for the Great Bear constellation (Ursa Major) visible in the north. Antarctica is 'anti-Arctic' — opposite the bear. The name King Arthur may also derive from arktos." },
  { word:"vaccine", def:"A substance stimulating immunity", pos:"noun", ipa:"/ˈvæk.siːn/", origin:"Latin", year:"1799", etymology:"From Latin vaccinus — 'pertaining to cows'", roots:[{part:"vacca",meaning:"cow",lang:"Latin"},{part:"-inus",meaning:"of the nature of",lang:"Latin"}], evolution:["vacca (Lat)","vaccinus","vaccine"], relatives:["vaccinate","vaccination","vaquero"], funFact:"Jenner noticed milkmaids who caught cowpox never got smallpox. 'Vaccine' literally means 'cow stuff.'" },
  { word:"helicopter", def:"An aircraft with rotating blades", pos:"noun", ipa:"/ˈhɛl.ɪˌkɒp.tər/", origin:"Greek", year:"1861", etymology:"From Greek helix + pteron — 'spiral wing'", roots:[{part:"helix",meaning:"spiral",lang:"Greek"},{part:"pteron",meaning:"wing",lang:"Greek"}], evolution:["helix + pteron (Grk)","hélicoptère (Fr)","helicopter"], relatives:["helix","pterodactyl","pteranodon","archaeopteryx","diptera"], funFact:"Most people split it as 'heli-copter' but etymologically it's 'helico-pter' — spiral wing. Pteron also gives us pterodactyl ('wing finger') and all the -ptera insect orders." },
  { word:"dandelion", def:"A yellow wildflower with toothed leaves", pos:"noun", ipa:"/ˈdæn.dɪˌlaɪ.ən/", origin:"French", year:"1300s", etymology:"From French dent de lion — 'lion's tooth'", roots:[{part:"dent",meaning:"tooth",lang:"French/Latin"},{part:"de",meaning:"of",lang:"French"},{part:"lion",meaning:"lion",lang:"French/Latin"}], evolution:["dens leonis (Lat)","dent de lion (Fr)","dandelion"], relatives:["dental","dentist","trident","Leo","lion"], funFact:"Named for the jagged, tooth-shaped leaves, not the flower. In nearly every European language it references teeth: German Löwenzahn ('lion tooth'), Italian dente di leone." },
  { word:"checkmate", def:"A winning position in chess", pos:"noun", ipa:"/ˈtʃɛk.meɪt/", origin:"Persian/Arabic", year:"1300s", etymology:"From Persian shāh māt — 'the king is dead/helpless'", roots:[{part:"shāh",meaning:"king",lang:"Persian"},{part:"māt",meaning:"dead, helpless",lang:"Arabic"}], evolution:["shāh māt (Persian)","escec mat (OFr)","checkmate"], relatives:["check","chess","shah","exchequer"], funFact:"Chess traveled from India to Persia to Arabia to Europe. 'Check' itself comes from shāh (king). The Exchequer (British treasury) is named for a checkered counting cloth." }
];

// Deduplicate
const seen = new Set();
const WORDS = WORD_BANK.filter(w => { if (seen.has(w.word)) return false; seen.add(w.word); return true; });

/* ═══════════════════════════════════════════════════════════════════════════
   VOCAB BUILDER WORD BANK — 30 VIVID, EXPRESSIVE WORDS
   ═══════════════════════════════════════════════════════════════════════════ */
const VB_WORD_BANK = [
  { word:"petrichor", def:"The pleasant smell that accompanies the first rain after a dry spell", pos:"noun", ipa:"/ˈpɛt.rɪ.kɔːr/", tone:"Nostalgic", sentence:"She stepped outside and inhaled the petrichor rising from the warm pavement — childhood summers came flooding back.", mnemonic:"PETRIfied rock + icHOR (Greek for the fluid of the gods): the earth's ancient blood waking up with rain.", synonyms:["earthy scent","rain smell"], options:["petrichor","geosmin","ozone","pluvial"] },
  { word:"liminal", def:"Relating to a transitional stage between two states or conditions", pos:"adj", ipa:"/ˈlɪm.ɪ.nəl/", tone:"Mysterious", sentence:"There's something magical about airports at 3 a.m. — purely liminal spaces where ordinary life is suspended.", mnemonic:"LIMINal → threshold. Like the limen (Latin for doorstep): you're on neither side.", synonyms:["threshold","transitional","in-between"], options:["liminal","peripheral","temporal","marginal"] },
  { word:"ineffable", def:"Too great or extreme to be expressed in words", pos:"adj", ipa:"/ɪˈnɛf.ə.bəl/", tone:"Awe-struck", sentence:"He tried to describe what seeing his newborn felt like and gave up — the love was simply ineffable.", mnemonic:"IN (not) + EFFABLE (utterable, from Latin effari: to speak out). Can't be spoken out.", synonyms:["indescribable","inexpressible","unutterable"], options:["ineffable","inaudible","imperceptible","intangible"] },
  { word:"susurrus", def:"A whispering or rustling sound", pos:"noun", ipa:"/suːˈsɜr.əs/", tone:"Serene", sentence:"She fell asleep to the susurrus of rain against the window and wind through the birch leaves.", mnemonic:"SuSuRRuS sounds exactly like what it means — whispering S's all the way through.", synonyms:["murmur","whisper","rustle","sibilance"], options:["susurrus","clamour","stridency","resonance"] },
  { word:"numinous", def:"Having a strong spiritual quality; evoking a sense of the divine or supernatural", pos:"adj", ipa:"/ˈnjuː.mɪ.nəs/", tone:"Reverent", sentence:"Standing inside the empty cathedral at dusk, she felt something numinous — as if the stones themselves were alive with meaning.", mnemonic:"NUMEN (Latin: divine will/spirit) → numinous. The numen of a place is its invisible divine presence.", synonyms:["sacred","transcendent","sublime","otherworldly"], options:["numinous","ominous","luminous","voluminous"] },
  { word:"sonder", def:"The realisation that each passing stranger has a life as vivid and complex as your own", pos:"noun", ipa:"/ˈsɒn.dər/", tone:"Melancholic", sentence:"Watching the city from the rooftop, she was struck by sonder — every lit window a whole universe of private sorrows and joys.", mnemonic:"SONDER (German: particular/special). Each person is a sonderfall — a special case. Coined by John Koenig.", synonyms:["empathy","perspective","interconnectedness"], options:["sonder","wonder","ponder","wander"] },
  { word:"laconic", def:"Using very few words; remarkably brief and concise", pos:"adj", ipa:"/ləˈkɒn.ɪk/", tone:"Dry", sentence:"His reply was characteristically laconic: when asked how his surgery went, he said simply, 'Fine.'", mnemonic:"LACONIC comes from Laconia (Sparta). When Philip of Macedon threatened 'If I enter Sparta, I will raze it,' the Spartans replied: 'If.'", synonyms:["terse","succinct","pithy","curt"], options:["laconic","chronic","ironic","iconic"] },
  { word:"ebullient", def:"Cheerful and full of energy; bubbling with enthusiasm", pos:"adj", ipa:"/ɪˈbʊl.jənt/", tone:"Joyful", sentence:"Her ebullient laughter filled the whole restaurant — you couldn't help smiling even if you didn't know the joke.", mnemonic:"EBULLIENT → ebullition (boiling). Boiling over with enthusiasm. E-BULL-ient: charging forward like a bull.", synonyms:["exuberant","effervescent","buoyant","vivacious"], options:["ebullient","emollient","resilient","salient"] },
  { word:"sanguine", def:"Optimistic, especially in a difficult situation; blood-red in colour", pos:"adj", ipa:"/ˈsæŋ.ɡwɪn/", tone:"Optimistic", sentence:"Remarkably sanguine about the delays, she used the extra hour to finish her novel.", mnemonic:"SANGUINE = blood (Latin sanguis). Medieval medicine: 'blood' humour made you warm, rosy, and cheerful. Rosy cheeks = optimism.", synonyms:["optimistic","hopeful","buoyant","confident"], options:["sanguine","mundane","pungent","languid"] },
  { word:"lugubrious", def:"Looking or sounding sad and dismal; mournful in an exaggerated way", pos:"adj", ipa:"/luːˈɡjuː.bri.əs/", tone:"Mournful", sentence:"The basset hound sat by the window with its lugubrious eyes fixed on the empty driveway.", mnemonic:"LUGUBRIOUS → lugubris (Latin: mournful). LUG something heavy and you trudge with that sad, weary gait.", synonyms:["mournful","doleful","woeful","melancholy"], options:["lugubrious","luxurious","laborious","illustrious"] },
  { word:"poignant", def:"Evoking a keen sense of sadness or regret; sharply affecting", pos:"adj", ipa:"/ˈpɔɪ.njənt/", tone:"Bittersweet", sentence:"The film's most poignant moment wasn't the dramatic climax — it was a single close-up of an empty chair at Christmas dinner.", mnemonic:"POIGNANT → pungent/prick (Latin pungere). A poignant moment pricks your heart. 'POI' like being poked.", synonyms:["moving","touching","bittersweet","affecting"], options:["poignant","buoyant","pungent","flagrant"] },
  { word:"diaphanous", def:"(Especially of fabric) light, delicate, and translucent", pos:"adj", ipa:"/daɪˈæf.ə.nəs/", tone:"Delicate", sentence:"The diaphanous curtains billowed inward as the sea breeze pushed through, blurring the room with pale light.", mnemonic:"DIA (through) + PHANOUS (light, Greek phaínein: to show). Light shines right through it.", synonyms:["sheer","gossamer","translucent","gauzy"], options:["diaphanous","dilapidated","phosphorescent","simultaneous"] },
  { word:"quixotic", def:"Exceedingly idealistic; unrealistic and impractical", pos:"adj", ipa:"/kwɪkˈsɒt.ɪk/", tone:"Wistful", sentence:"His quixotic plan to cycle solo across the Sahara somehow worked — not because it was sensible, but because he refused to know that.", mnemonic:"QUIXOTIC from Don Quixote — the knight who charged windmills thinking they were giants. Noble madness.", synonyms:["idealistic","romantic","impractical","visionary"], options:["quixotic","hypnotic","chaotic","narcotic"] },
  { word:"melancholy", def:"A feeling of pensive sadness, typically with no obvious cause", pos:"noun/adj", ipa:"/ˈmɛl.ən.kɒl.i/", tone:"Pensive", sentence:"A certain Sunday-evening melancholy settled over him as the light faded — not grief, just the weight of beautiful things ending.", mnemonic:"MELAN (black) + KHOLÉ (bile, Greek). Medieval medicine: 'black bile' made you pensive and sad. Dark fluid = dark mood.", synonyms:["wistfulness","pensiveness","sadness","despondency"], options:["melancholy","magnanimity","malediction","malcontent"] },
  { word:"mercurial", def:"Subject to sudden or unpredictable changes of mood or mind", pos:"adj", ipa:"/mɜːˈkjʊər.i.əl/", tone:"Electric", sentence:"Her mercurial temper kept the whole office on edge — she could go from laughing to furious in seconds.", mnemonic:"MERCURY (the planet and god) moves fastest across the sky. Mercury/quicksilver is liquid, fast, unpredictable.", synonyms:["volatile","capricious","protean","quicksilver"], options:["mercurial","memorial","immersorial","imperial"] },
  { word:"languid", def:"Weak or faint from illness or fatigue; having or showing a disinclination for exertion", pos:"adj", ipa:"/ˈlæŋ.ɡwɪd/", tone:"Dreamy", sentence:"The afternoon heat made everything languid — even the ceiling fan turned as if thinking about it.", mnemonic:"LANGUID → languish → langue (French: tongue). When your tongue is too heavy to speak, you're languid.", synonyms:["lethargic","listless","languorous","torpid"], options:["languid","avid","vapid","lucid"] },
  { word:"incandescent", def:"Emitting light as a result of being heated; filled with strong emotion, especially anger or passion", pos:"adj", ipa:"/ˌɪn.kænˈdɛs.ənt/", tone:"Intense", sentence:"He was incandescent with rage — the kind that makes you calm and dangerous, not loud.", mnemonic:"INCANDESCENT → candere (Latin: to glow). In + candle: glowing from within. White-hot.", synonyms:["radiant","blazing","luminous","fervent"], options:["incandescent","iridescent","fluorescent","phosphorescent"] },
  { word:"vertiginous", def:"Causing or experiencing a feeling of dizziness or disorientation, often from great heights", pos:"adj", ipa:"/vɜːˈtɪdʒ.ɪ.nəs/", tone:"Unsettling", sentence:"The vertiginous drop on either side of the ridge path made each step feel like a negotiation.", mnemonic:"VERTIGO → vertere (Latin: to turn). Everything spinning and turning — the world won't hold still.", synonyms:["dizzying","giddy","disorienting","precipitous"], options:["vertiginous","indigenous","ambiguous","prestigious"] },
  { word:"ethereal", def:"Extremely delicate and light; seeming to belong to another world; heavenly", pos:"adj", ipa:"/ɪˈθɪər.i.əl/", tone:"Otherworldly", sentence:"Her voice had an ethereal quality — not quite of this world, like music heard through thin walls.", mnemonic:"ETHEREAL → ether (the substance filling the heavens in ancient philosophy). Above the earthly, in the upper air.", synonyms:["celestial","gossamer","unearthly","transcendent"], options:["ethereal","material","ephemeral","literal"] },
  { word:"equanimity", def:"Calm and composure, especially in difficult situations; mental steadiness", pos:"noun", ipa:"/ˌiː.kwəˈnɪm.ɪ.ti/", tone:"Steady", sentence:"She faced the diagnosis with equanimity — not denial, not collapse, just a quiet steadiness that helped everyone around her.", mnemonic:"EQUA (equal, Latin) + ANIMUS (mind/spirit). An equal, level mind. The mental equivalent of a spirit level.", synonyms:["composure","serenity","steadiness","poise"], options:["equanimity","unanimity","magnanimity","parsimony"] },
  { word:"tendentious", def:"Expressing or promoting a particular cause or point of view; biased", pos:"adj", ipa:"/tɛnˈdɛn.ʃəs/", tone:"Critical", sentence:"The documentary was brilliantly made but tendentious — every fact was real, yet the whole thing skewed.", mnemonic:"TENDENTIOUS → tendency → tend. The argument tends heavily in one direction and won't stop tending.", synonyms:["biased","partisan","slanted","polemical"], options:["tendentious","contentious","pretentious","conscientious"] },
  { word:"perspicacious", def:"Having a ready insight into things; shrewd and sharp in understanding", pos:"adj", ipa:"/ˌpɜː.spɪˈkeɪ.ʃəs/", tone:"Sharp", sentence:"A perspicacious observer would have noticed the slight hesitation before his answer — the real story lived in that pause.", mnemonic:"PERSPICACIOUS → perspicere (Latin: to see through). PER-SPIC: to see clearly through things. Spectacles help you see.", synonyms:["perceptive","astute","shrewd","discerning"], options:["perspicacious","loquacious","pugnacious","rapacious"] },
  { word:"redolent", def:"Strongly suggestive or reminiscent of something; having a strong, pleasant smell", pos:"adj", ipa:"/ˈrɛd.ə.lənt/", tone:"Evocative", sentence:"The old study was redolent of her grandfather — pipe smoke, leather, and something she couldn't name but always knew.", mnemonic:"REDOLENT → olere (Latin: to smell). RE-DOLE-nt: dole out smells again and again, releasing memories.", synonyms:["evocative","reminiscent","fragrant","suggestive"], options:["redolent","insolent","turbulent","succulent"] },
  { word:"magnanimous", def:"Generous and forgiving, especially towards a rival or enemy; nobly generous in spirit", pos:"adj", ipa:"/mæɡˈnæn.ɪ.məs/", tone:"Noble", sentence:"In victory, she was magnanimous — she thanked her competitors publicly and meant every word.", mnemonic:"MAGNUS (great, Latin) + ANIMUS (spirit/mind). A great-spirited person. Big enough not to be petty.", synonyms:["generous","noble","charitable","gracious"], options:["magnanimous","autonomous","anonymous","unanimous"] },
  { word:"cacophony", def:"A harsh, discordant mixture of sounds; a loud, unpleasant noise", pos:"noun", ipa:"/kəˈkɒf.ə.ni/", tone:"Chaotic", sentence:"The market at midday was a cacophony — vendors, pigeons, two competing radio stations, and somewhere a very angry goat.", mnemonic:"KAKOS (bad, Greek) + PHONE (sound). Bad sound. Kakos gives us 'cacophony' and 'kakorrhaphiophobia' (fear of failure).", synonyms:["discord","din","clamour","dissonance"], options:["cacophony","symphony","euphony","resonance"] },
  { word:"dulcet", def:"Sweet and soothing, especially to the ear (often used ironically)", pos:"adj", ipa:"/ˈdʌl.sɪt/", tone:"Wry", sentence:"She was awoken by the dulcet tones of her neighbour's 6 a.m. lawnmower.", mnemonic:"DULCET → dulcis (Latin: sweet). Dulce de leche. Duke's sweet melody. Often used with irony — the sweetness is sarcastic.", synonyms:["melodious","mellifluous","harmonious","sweet"], options:["dulcet","musket","bracket","basket"] },
  { word:"umbra", def:"The fully shaded inner region of a shadow; the darkest part of a shadow", pos:"noun", ipa:"/ˈʌm.brə/", tone:"Contemplative", sentence:"During the eclipse, those in the umbra experienced total darkness at noon — a moment outside ordinary time.", mnemonic:"UMBRA (Latin: shadow). Umbrella = shadow tool. Penumbra = almost-shadow. The umbra is the shadow's shadow.", synonyms:["shadow","shade","darkness"], options:["umbra","aurora","aura","acra"] },
  { word:"penumbra", def:"A partial or uncertain shadow; the transitional zone between full shadow and full light", pos:"noun", ipa:"/pɪˈnʌm.brə/", tone:"Contemplative", sentence:"The room was lit by a single candle, and she sat in the penumbra at the edge of its reach — present but unreadable.", mnemonic:"PEN (almost, Latin paene) + UMBRA (shadow). Almost-shadow. The not-quite-dark zone at the edge.", synonyms:["partial shadow","half-shadow","fringe"], options:["penumbra","panorama","peninsula","parabola"] },
  { word:"ephemeral", def:"Lasting for a very short time; transitory", pos:"adj", ipa:"/ɪˈfɛm.ər.əl/", tone:"Wistful", sentence:"She photographed everything obsessively, trying to hold onto experiences she already knew were ephemeral.", mnemonic:"EPI (upon) + HEMERA (day, Greek). Lasting only a day. Mayflies are ephemeral; their whole adult lives are one sunrise to sunset.", synonyms:["fleeting","transient","momentary","evanescent"], options:["ephemeral","empirical","equivocal","emotional"] },
  { word:"loquacious", def:"Tending to talk a great deal; garrulous", pos:"adj", ipa:"/ləˈkweɪ.ʃəs/", tone:"Wry", sentence:"She was loquacious in person but wrote emails of two words or fewer — her medium changed everything.", mnemonic:"LOQUI (Latin: to speak). Loquacious = eloquent on overdrive. Loc-ACIOUS — a mouth that's aciously, voraciously speaking.", synonyms:["talkative","garrulous","voluble","verbose"], options:["loquacious","ferocious","atrocious","precocious"] },
];

/* ═══════════════════════════════════════════════════════════════════════════
   UTILITIES
   ═══════════════════════════════════════════════════════════════════════════ */
const getDayKey = () => { const d = new Date(); return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`; };
const getPrevDayKey = () => { const d = new Date(); d.setDate(d.getDate()-1); return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`; };

const seededRng = (seed) => {
  let s = 0;
  for (let i = 0; i < seed.length; i++) s = ((s << 5) - s + seed.charCodeAt(i)) | 0;
  return () => { s = (s * 16807) % 2147483647; return (s & 0x7fffffff) / 0x7fffffff; };
};

const shuffle = (arr, rng) => {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(rng() * (i + 1));[a[i], a[j]] = [a[j], a[i]]; }
  return a;
};

const speak = (text) => {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.8; window.speechSynthesis.speak(u);
};

/* ═══════════════════════════════════════════════════════════════════════════
   SOUND FX (Web Audio API)
   ═══════════════════════════════════════════════════════════════════════════ */
let audioCtx = null;
const getAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return audioCtx; };

const playSound = (type) => {
  try {
    const ctx = getAudio();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    gain.gain.value = 0.12;

    if (type === "correct") {
      osc.type = "sine"; osc.frequency.value = 520;
      osc.frequency.setValueAtTime(520, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(780, ctx.currentTime + 0.08);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.2);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.2);
    } else if (type === "wrong") {
      osc.type = "sawtooth"; osc.frequency.value = 180;
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.25);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.25);
    } else if (type === "combo") {
      osc.type = "sine"; osc.frequency.value = 600;
      osc.frequency.setValueAtTime(600, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(1200, ctx.currentTime + 0.15);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.3);
    } else if (type === "levelup") {
      [0, 0.1, 0.2].forEach((t, i) => {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = "sine"; o.frequency.value = 500 + i * 200; g.gain.value = 0.1;
        g.gain.linearRampToValueAtTime(0, ctx.currentTime + t + 0.15);
        o.start(ctx.currentTime + t); o.stop(ctx.currentTime + t + 0.15);
      });
    } else if (type === "tick") {
      osc.type = "sine"; osc.frequency.value = 900;
      gain.gain.value = 0.06;
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.04);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.04);
    } else if (type === "timeup") {
      osc.type = "square"; osc.frequency.value = 300;
      osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.4);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.4);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.4);

    } else if (type === "learn_start") {
      // Warm drone triad — A2 + E3 + A3, slow swell, meditative
      [110, 165, 220].forEach((freq) => {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = "sine"; o.frequency.value = freq;
        g.gain.setValueAtTime(0, ctx.currentTime);
        g.gain.linearRampToValueAtTime(0.052, ctx.currentTime + 0.4);
        g.gain.linearRampToValueAtTime(0.032, ctx.currentTime + 0.75);
        g.gain.linearRampToValueAtTime(0, ctx.currentTime + 1.2);
        o.start(ctx.currentTime); o.stop(ctx.currentTime + 1.2);
      });
    } else if (type === "learn_card") {
      // Soft papery page-turn flick
      osc.type = "sine"; osc.frequency.value = 300;
      osc.frequency.linearRampToValueAtTime(460, ctx.currentTime + 0.055);
      gain.gain.value = 0.042;
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.085);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.085);

    } else if (type === "quiz_start") {
      // Ascending C-major arpeggio: C4 → E4 → G4 → C5
      [262, 330, 392, 524].forEach((freq, i) => {
        const t = ctx.currentTime + i * 0.09;
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = "sine"; o.frequency.value = freq;
        g.gain.setValueAtTime(i === 3 ? 0.1 : 0.07, t);
        g.gain.linearRampToValueAtTime(0, t + (i === 3 ? 0.28 : 0.14));
        o.start(t); o.stop(t + 0.3);
      });

    } else if (type === "speed_go") {
      // Energetic rising sawtooth sweep then a bright ping
      osc.type = "sawtooth"; osc.frequency.value = 150;
      osc.frequency.linearRampToValueAtTime(700, ctx.currentTime + 0.16);
      gain.gain.value = 0.07;
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.2);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.2);
      // Bright ping on top
      const o2 = ctx.createOscillator(); const g2 = ctx.createGain();
      o2.connect(g2); g2.connect(ctx.destination);
      o2.type = "sine"; o2.frequency.value = 1046;
      g2.gain.setValueAtTime(0.09, ctx.currentTime + 0.14);
      g2.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.32);
      o2.start(ctx.currentTime + 0.14); o2.stop(ctx.currentTime + 0.32);

    } else if (type === "results") {
      // Warm sustained A-major chord — A3 C#4 E4 A4 — gentle swell
      [220, 277, 330, 440].forEach((freq) => {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = "sine"; o.frequency.value = freq;
        g.gain.setValueAtTime(0, ctx.currentTime);
        g.gain.linearRampToValueAtTime(0.052, ctx.currentTime + 0.3);
        g.gain.linearRampToValueAtTime(0.038, ctx.currentTime + 0.9);
        g.gain.linearRampToValueAtTime(0, ctx.currentTime + 1.5);
        o.start(ctx.currentTime); o.stop(ctx.currentTime + 1.5);
      });
    }
  } catch (e) {}
};

/* ═══════════════════════════════════════════════════════════════════════════
   XP & LEVEL SYSTEM
   ═══════════════════════════════════════════════════════════════════════════ */

/* XP — slower progression so levels feel earned */
const XP_PER_CORRECT  = 8;
const XP_COMBO_BONUS  = 4;
const XP_SPEED_BONUS  = 12;
const XP_PERFECT_BONUS = 40;
const xpForLevel = (lvl) => 180 + (lvl - 1) * 80;  // was 50+(lvl-1)*30

/* ═══════════════════════════════════════════════════════════════════════════
   THEME ENGINE — 6 distinct moods, all warm and consonant
   ─────────────────────────────────────────────────────────────────────────
   1. LEXICON  — Uplifting / Joy of Discovery  (E major, marimba + harp)
   2. CODEX    — Curious / Ancient Library     (A minor pentatonic, koto + low organ)
   3. ORIGINS  — Adventure / Setting Off       (G major, xylophone + koto)
   4. ORACLE   — Deep Peace / Meditative       (C pentatonic, singing bowls)
   5. SCHOLAR  — Warm / Cosy Library           (F major, piano + cello)
   6. VERSE    — Wonder / Fairy-tale Magic     (B major, glass bells + music box)

   HARMONY RULES (no dissonance):
   • All pads: root + perfect fifth only
   • All melodies: strict pentatonic or major — zero chromatic notes
   • No tritones anywhere
   • All reverbs bright-to-medium; Oracle longest but calm, not eerie
   ═══════════════════════════════════════════════════════════════════════════ */
let droneNodes = null;
let _dTimers = [];
const _dt = (fn, ms) => { const id = setTimeout(fn, ms); _dTimers.push({ k:"t", id }); };
const BASE_VOL = 0.44;
const BREATH_D = 0.030;

/* ── NOISE BUFFER ──────────────────────────────────────────────────────── */
const _makeNoise = (ctx, secs) => {
  const sz = Math.ceil(ctx.sampleRate * secs);
  const buf = ctx.createBuffer(1, sz, ctx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < sz; i++) d[i] = Math.random() * 2 - 1;
  return buf;
};

/* ── REVERB FACTORY ────────────────────────────────────────────────────── */
const _makeReverb = (ctx, comp, cfg) => {
  const d0 = ctx.createDelay(2.0); d0.delayTime.value = cfg.taps[0];
  const d1 = ctx.createDelay(2.0); d1.delayTime.value = cfg.taps[1];
  const d2 = ctx.createDelay(2.0); d2.delayTime.value = cfg.taps[2];
  const fb = ctx.createGain(); fb.gain.value = cfg.fb;
  const lp = ctx.createBiquadFilter(); lp.type = "lowpass"; lp.frequency.value = cfg.lpHz; lp.Q.value = 0.3;
  const wet = ctx.createGain(); wet.gain.value = cfg.wet;
  d0.connect(lp); lp.connect(d1); d1.connect(d2); d2.connect(fb); fb.connect(d0);
  d1.connect(wet); wet.connect(comp);
  return (g, amt) => { const s = ctx.createGain(); s.gain.value = amt; g.connect(s); s.connect(d0); };
};

/* ══════════════════════════════════════════════════════════════════════════
   VOICE SYNTHESISERS
   ══════════════════════════════════════════════════════════════════════════ */

/* MARIMBA — warm wood, inharmonic 1×/3.93×/9.46× */
const _marimba = (ctx, bus, send, f, pk, dur, t) => {
  [[1.00,1.00,dur],[3.93,0.08,dur*.12],[9.46,0.025,dur*.05]].forEach(([h,r,d])=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type="sine"; o.frequency.value=f*h;
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk*r,t+.007);
    g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.connect(g); g.connect(bus); if(h===1)send(g,.52);
    o.start(t); o.stop(t+d+.05);
  });
};

/* HARP — gentle pitch glide up on attack */
const _harp = (ctx, bus, send, f, pk, dur, t) => {
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type="sine"; o.frequency.setValueAtTime(f*1.008,t); o.frequency.exponentialRampToValueAtTime(f,t+.05);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk,t+.011);
  g.gain.exponentialRampToValueAtTime(.0001,t+dur);
  o.connect(g); g.connect(bus); send(g,.48);
  o.start(t); o.stop(t+dur+.06);
  const o2=ctx.createOscillator(),g2=ctx.createGain();
  o2.type="sine"; o2.frequency.value=f*2;
  g2.gain.setValueAtTime(0,t); g2.gain.linearRampToValueAtTime(pk*.18,t+.009);
  g2.gain.exponentialRampToValueAtTime(.0001,t+dur*.30);
  o2.connect(g2); g2.connect(bus); o2.start(t); o2.stop(t+dur*.30+.05);
};

/* KOTO — pitch glide DOWN (like plucking a taut string that relaxes) */
const _koto = (ctx, bus, send, f, pk, dur, t) => {
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type="sine"; o.frequency.setValueAtTime(f*1.020,t); o.frequency.exponentialRampToValueAtTime(f,t+.10);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk,t+.006);
  g.gain.exponentialRampToValueAtTime(.0001,t+dur);
  o.connect(g); g.connect(bus); send(g,.44);
  o.start(t); o.stop(t+dur+.06);
  // Koto shimmer (2.85× — metallic but soft)
  const o2=ctx.createOscillator(),g2=ctx.createGain();
  o2.type="sine"; o2.frequency.value=f*2.85;
  g2.gain.setValueAtTime(0,t); g2.gain.linearRampToValueAtTime(pk*.11,t+.005);
  g2.gain.exponentialRampToValueAtTime(.0001,t+dur*.14);
  o2.connect(g2); g2.connect(bus); o2.start(t); o2.stop(t+dur*.16+.04);
};

/* XYLOPHONE — bright, short, punchy */
const _xyl = (ctx, bus, send, f, pk, dur, t) => {
  [[1.00,1.00,dur*.9],[2.76,.10,dur*.16],[5.40,.03,dur*.06]].forEach(([h,r,d])=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type="sine"; o.frequency.value=f*h;
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk*r,t+.004);
    g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.connect(g); g.connect(bus); if(h===1)send(g,.30);
    o.start(t); o.stop(t+d+.04);
  });
};

/* FLUTE — breath noise + sine body + growing vibrato */
const _flute = (ctx, bus, send, f, pk, dur, t, noise) => {
  const ns=ctx.createBufferSource(); ns.buffer=noise;
  const hp=ctx.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=f*.75;
  const ng=ctx.createGain(); ng.gain.setValueAtTime(pk*.14,t); ng.gain.exponentialRampToValueAtTime(.0001,t+.10);
  ns.connect(hp); hp.connect(ng); ng.connect(bus); ns.start(t); ns.stop(t+.13);
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type="sine"; o.frequency.value=f;
  const vl=ctx.createOscillator(),vg=ctx.createGain();
  vl.type="sine"; vl.frequency.value=5.3; vg.gain.setValueAtTime(0,t+.03); vg.gain.linearRampToValueAtTime(f*.007,t+.40);
  vl.connect(vg); vg.connect(o.frequency);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk,t+.08);
  g.gain.setValueAtTime(pk,t+dur-.65); g.gain.linearRampToValueAtTime(0,t+dur);
  o.connect(g); g.connect(bus); send(g,.46);
  vl.start(t); vl.stop(t+dur+.1); o.start(t); o.stop(t+dur+.1);
};

/* PIPE ORGAN — sawtooth drawbars (8' + 4' + 2⅔'), slow attack */
const _organ = (ctx, bus, send, f, pk, dur, t) => {
  [[1.00,.55],[2.00,.26],[2.667,.13]].forEach(([h,r])=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type="sawtooth"; o.frequency.value=f*h; o.detune.value=(Math.random()-.5)*3;
    const hp=ctx.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=60;
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk*r,t+.18);
    g.gain.setValueAtTime(pk*r,t+dur-.20); g.gain.linearRampToValueAtTime(0,t+dur);
    o.connect(hp); hp.connect(g); g.connect(bus); if(h===1)send(g,.36);
    o.start(t); o.stop(t+dur+.1);
  });
};

/* SINGING BOWL — long ring, real inharmonic partials, gentle wobble */
const _bowl = (ctx, bus, send, f, pk, dur, t) => {
  [[1.000,1.00,dur],[2.756,.30,dur*.7],[5.404,.10,dur*.42]].forEach(([h,r,d])=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type="sine"; o.frequency.value=f*h;
    const wl=ctx.createOscillator(),wg=ctx.createGain();
    wl.type="sine"; wl.frequency.value=.8+Math.random()*.4; wg.gain.value=f*h*.003;
    wl.connect(wg); wg.connect(o.frequency);
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk*r,t+.04);
    g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.connect(g); g.connect(bus); if(h===1)send(g,.60);
    wl.start(t); o.start(t); wl.stop(t+d+.1); o.stop(t+d+.1);
  });
};

/* PIANO — 3 detuned triangle strings + hammer transient */
const _piano = (ctx, bus, send, f, pk, dur, t) => {
  [[0,1.00],[-4,.82],[+3,.68]].forEach(([det,r])=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type="triangle"; o.frequency.value=f; o.detune.value=det;
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk*r,t+.008);
    g.gain.exponentialRampToValueAtTime(pk*r*.50,t+.28); g.gain.exponentialRampToValueAtTime(.0001,t+dur);
    o.connect(g); g.connect(bus); if(det===0)send(g,.40);
    o.start(t); o.stop(t+dur+.1);
  });
  // Bright hammer click
  const hi=ctx.createOscillator(),hg=ctx.createGain();
  hi.type="sine"; hi.frequency.value=f*6.1;
  hg.gain.setValueAtTime(0,t); hg.gain.linearRampToValueAtTime(pk*.06,t+.003);
  hg.gain.exponentialRampToValueAtTime(.0001,t+.07);
  hi.connect(hg); hg.connect(bus); hi.start(t); hi.stop(t+.10);
};

/* PIZZ CELLO — warm pluck, gut-string character */
const _pizz = (ctx, bus, send, f, pk, dur, t) => {
  [[1.0,1.00,dur*.68],[2.0,.26,dur*.32],[3.0,.09,dur*.18]].forEach(([h,r,d])=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type=h===1?"triangle":"sine"; o.frequency.value=f*h;
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk*r,t+.011);
    g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.connect(g); g.connect(bus); if(h===1)send(g,.36);
    o.start(t); o.stop(t+d+.06);
  });
};

/* GLASS BELL — shimmer beating pair + long overtones */
const _bell = (ctx, bus, send, f, pk, dur, t) => {
  [[f,1.00,dur],[f*1.003,.52,dur],[f*2.756,.26,dur*.52],[f*5.404,.09,dur*.28]].forEach(([fr,r,d],i)=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type="sine"; o.frequency.value=fr;
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk*r,t+.003);
    g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.connect(g); g.connect(bus); if(i===0)send(g,.58);
    o.start(t); o.stop(t+d+.06);
  });
};

/* MUSIC BOX TINE — instant bright attack, very fast decay */
const _mbox = (ctx, bus, send, f, pk, dur, t) => {
  [[1.00,1.00,Math.min(dur,1.3)],[4.05,.20,.16],[8.80,.05,.06]].forEach(([h,r,d])=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type="sine"; o.frequency.value=f*h;
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(pk*r,t+.002);
    g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.connect(g); g.connect(bus); if(h===1)send(g,.38);
    o.start(t); o.stop(t+d+.04);
  });
};

/* PAD VOICE — open fifth, triangle, micro-vibrato */
const _padVoice = (ctx, bus, f, det, tGain, t) => {
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type="triangle"; o.frequency.value=f; o.detune.value=det;
  const vl=ctx.createOscillator(),vg=ctx.createGain();
  vl.type="sine"; vl.frequency.value=.055+Math.random()*.05; vg.gain.value=f*.004;
  vl.connect(vg); vg.connect(o.detune); vl.start();
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(tGain,t+4.5);
  o.connect(g); g.connect(bus); o.start();
  return [o,vl];
};

/* ══════════════════════════════════════════════════════════════════════════
   6 THEME DEFINITIONS
   All pads: root + perfect 5th only (zero dissonance)
   All melodies: strict major or pentatonic
   ══════════════════════════════════════════════════════════════════════════ */

/* Freq helpers */
const _n = (semi) => 440 * Math.pow(2, semi/12); // semitones from A4

const THEME_DEFS = [
  /* ── 1. LEXICON  ——  Joy of Discovery  ·  E major ─────────────────────
     Uplifting, bright, forward momentum. Like the moment you understand
     something for the first time. Marimba melody, harp fills, airy flute.
     Reverb: medium hall — open and clear, not huge.                      */
  {
    name:"Lexicon", sym:"✦", sub:"Uplifting",
    loopS: 22.0,
    reverb: { taps:[.55,.34,.22], fb:.42, lpHz:2600, wet:.30 },
    padFreqs: [[82.4,-6,.28],[82.4,6,.14],[123.5,-5,.16],[164.8,-4,.09]],
    padLpHz: 220,
    score: [
      // Piano leads — smooth, lyrical, gently uplifting arc
      // E major: E(329.6) F#(370) G#(415) B(494) C#(554) E5(659)
      ["piano",  329.6, 0.00, 2.80, .068],  // E4 — opens on the root, warm
      ["piano",  415.3, 3.00, 2.20, .062],  // G#4
      ["piano",  493.9, 5.40, 1.80, .066],  // B4
      ["piano",  554.4, 7.40, 2.40, .064],  // C#5 — peak of phrase
      ["piano",  493.9, 9.90, 1.60, .060],  // B4
      ["piano",  415.3,11.70, 1.20, .056],  // G#4
      ["piano",  329.6,13.10, 3.60, .064],  // E4 — return to root, long
      ["piano",  493.9,16.80, 1.40, .058],  // B4
      ["piano",  415.3,18.50, 3.20, .054],  // G#4 → seam
      // Harp adds gentle sparkle between piano phrases
      ["harp",   659.3, 1.20, 1.60, .046],  // E5 — high shimmer
      ["harp",   554.4, 4.20, 1.40, .042],  // C#5
      ["harp",   659.3, 6.80, 1.50, .044],  // E5
      ["harp",   493.9,10.40, 1.20, .040],  // B4
      ["harp",   659.3,14.80, 1.80, .038],  // E5
      ["harp",   493.9,17.20, 1.40, .036],  // B4
      // Flute sings the peak of the second phrase
      ["flute",  659.3,12.50, 2.60, .046],  // E5
      ["flute",  554.4,15.30, 1.20, .040],  // C#5
      ["flute",  493.9,16.70, 4.80, .034],  // B4 → seam
    ],
  },

  /* ── 2. CODEX  ——  Mysterious / Ancient Library  (harp drones + koto melody)
     Intriquing and atmospheric. Harp provides soft drone-like plucks;
     koto carries the melody. No organ — keeps everything airy and warm.   */
  {
    name:"Codex", sym:"◆", sub:"Mysterious",
    loopS: 24.0,
    reverb: { taps:[.90,.58,.38], fb:.46, lpHz:1400, wet:.36 },
    padFreqs: [[55.0,-5,.26],[55.0,5,.13],[82.4,-4,.16],[110.0,-3,.08]],
    padLpHz: 180,
    score: [
      // A minor pentatonic: A(220) C(261.6) D(293.7) E(329.6) G(392)
      // Harp provides soft atmospheric drones — quiet, felt not heard
      ["harp",   220.0,  0.00, 5.50, .052],  // A3
      ["harp",   164.8,  5.80, 5.00, .048],  // E3
      ["harp",   196.0, 11.00, 4.50, .050],  // G3
      ["harp",   220.0, 15.80, 4.00, .050],  // A3 return
      ["harp",   261.6, 20.20, 3.50, .046],  // C4
      // High harp shimmer
      ["harp",   440.0,  2.20, 2.80, .036],  // A4
      ["harp",   329.6,  8.20, 2.60, .034],  // E4
      ["harp",   392.0, 13.40, 2.40, .036],  // G4
      // Koto is the main melodic voice — lyrical and expressive
      ["koto",   440.0,  1.00, 2.20, .068],  // A4
      ["koto",   523.3,  3.40, 1.60, .062],  // C5
      ["koto",   587.3,  5.20, 0.80, .058],  // D5 brief peak
      ["koto",   440.0,  6.20, 2.60, .066],  // A4
      ["koto",   392.0,  9.00, 1.40, .060],  // G4
      ["koto",   329.6, 10.60, 2.60, .064],  // E4
      ["koto",   293.7, 13.40, 0.90, .056],  // D4
      ["koto",   220.0, 14.50, 3.50, .065],  // A3 — drops to root
      ["koto",   440.0, 18.20, 0.80, .058],  // A4
      ["koto",   523.3, 19.20, 1.60, .060],  // C5
      ["koto",   440.0, 21.00, 2.80, .054],  // A4 → seam
    ],
  },

    /* ── 3. ORIGINS  ——  Adventure / Setting Off  ·  G major ──────────────
     Bouncy, energetic, like the start of a journey. Xylophone plays a
     quick dance-like figure; koto provides a lyrical counter-melody.
     Faster note rhythm than any other theme. Lively spring reverb.       */
  {
    name:"Origins", sym:"◇", sub:"Adventurous",
    loopS: 17.5,
    reverb: { taps:[.22,.14,.09], fb:.26, lpHz:3500, wet:.18 },
    padFreqs: [[49.0,-5,.26],[49.0,5,.13],[73.4,-4,.17],[98.0,-2,.08]], // G2×2, D3, G3
    padLpHz: 200,
    score: [
      // G major: G A B C D E F# G  (196 220 246.9 261.6 293.7 329.6 369.9 392)
      // Fast bouncy rhythm — xylophone leads
      ["xyl",   392.0, 0.00, 0.55, .088],  // G4
      ["xyl",   440.0, 0.65, 0.50, .080],  // A4
      ["xyl",   493.9, 1.20, 0.50, .082],  // B4
      ["xyl",   392.0, 1.80, 0.45, .085],  // G4
      ["xyl",   293.7, 2.35, 0.60, .078],  // D4
      ["xyl",   329.6, 3.05, 0.50, .076],  // E4
      ["xyl",   392.0, 3.65, 0.50, .082],  // G4
      ["xyl",   493.9, 4.25, 0.50, .080],  // B4
      ["xyl",   587.3, 4.85, 0.55, .085],  // D5
      ["xyl",   392.0, 5.50, 0.50, .082],  // G4 rest beat
      ["xyl",   440.0, 6.10, 0.48, .078],  // A4
      ["xyl",   493.9, 6.68, 0.48, .080],  // B4
      ["xyl",   392.0, 7.30, 1.20, .084],  // G4 — little hold
      ["xyl",   329.6, 8.70, 0.50, .076],  // E4
      ["xyl",   293.7, 9.30, 0.50, .074],  // D4
      ["xyl",   246.9, 9.90, 0.48, .072],  // B3
      ["xyl",   196.0,10.50, 1.40, .080],  // G3 — drops to low root
      // Koto counter-melody — slower, lyrical
      ["koto",  587.3, 2.00, 1.60, .062],  // D5
      ["koto",  493.9, 3.80, 1.40, .056],  // B4
      ["koto",  440.0, 5.40, 1.20, .058],  // A4
      ["koto",  392.0, 6.80, 2.00, .060],  // G4
      ["koto",  329.6, 9.00, 1.40, .054],  // E4
      ["koto",  392.0,10.60, 2.00, .058],  // G4
      // Flute soars above the second half
      ["flute", 587.3,12.00, 2.40, .055],  // D5
      ["flute", 493.9,14.60, 1.20, .048],  // B4
      ["flute", 392.0,16.00, 1.30, .040],  // G4 → seam
    ],
  },

  /* ── 4. ORACLE  ——  Deep Peace / Meditation  ·  C pentatonic ──────────
     Slow, spacious, contemplative. Like a temple at dawn. Bowls ring
     into long silence, gong resonates at the octave (perfect consonance),
     gentle choir. NOT eerie — C major pentatonic is purely warm and open.
     Reverb: vast but the melody is simple so it doesn't blur.            */
  {
    name:"Oracle", sym:"⬡", sub:"Meditative",
    loopS: 30.0,
    reverb: { taps:[1.60,.98,.64], fb:.55, lpHz:700, wet:.50 },
    padFreqs: [[65.4,-5,.28],[65.4,5,.14],[98.0,-3,.18],[130.8,-2,.09]], // C2×2, G2, C3
    padLpHz: 160,
    score: [
      // C major pentatonic: C D E G A (261.6 293.7 329.6 392 440) — all warm
      // Very slow — each bowl note is an event
      ["bowl",  261.6,  0.00,10.00, .082],  // C4
      ["bowl",  392.0,  6.00, 9.00, .072],  // G4 (fifth of C — perfect consonance)
      ["bowl",  329.6, 12.00, 9.00, .070],  // E4 (major third — warm)
      ["bowl",  261.6, 20.00,10.00, .078],  // C4 return
      // Gong hits — always at the octave below a bowl (perfect consonance)
      ["bowl",  130.8,  0.00,14.00, .055],  // C3 gong-like (low bowl = gong substitute)
      ["bowl",  98.00, 12.00,14.00, .048],  // G2
      // Choir hums gently underneath — very quiet, pure sustained tone
      // Using bowl at C3+E3+G3 for a quiet major chord
      ["bowl",  164.8,  2.00,16.00, .038],  // E3 (softer choir-like)
      ["bowl",  196.0,  8.00,14.00, .034],  // G3
    ],
  },

  /* ── 5. SCHOLAR  ——  Warm Study  ·  F major ────────────────────────────
     Cosy, academic, fireplace-warm. Piano leads a gentle lyrical melody,
     pizzicato cello grounds it, flute provides a counter-voice.
     F major is the warmest-feeling key — slightly darker than C or G.
     Reverb: wood room — intimate, mid-forward.                           */
  {
    name:"Scholar", sym:"◉", sub:"Warm",
    loopS: 22.0,
    reverb: { taps:[.38,.24,.16], fb:.34, lpHz:1800, wet:.24 },
    padFreqs: [[43.7,-5,.26],[43.7,5,.13],[65.4,-4,.17],[87.3,-2,.08]], // F2×2, C2, F2
    padLpHz: 210,
    score: [
      // F major: F G A Bb C D E F  (174.6 196 220 233.1 261.6 293.7 329.6 349.2)
      // Lyrical melody — unhurried
      ["piano",  261.6, 0.00, 3.00, .076],  // C4
      ["piano",  329.6, 3.20, 2.20, .070],  // E4
      ["piano",  349.2, 5.60, 1.00, .066],  // F4
      ["piano",  293.7, 6.80, 3.50, .073],  // D4
      ["piano",  261.6,10.60, 3.00, .076],  // C4 return
      ["piano",  220.0,14.00, 2.00, .068],  // A3
      ["piano",  174.6,16.20, 4.60, .063],  // F3 (root) — long final phrase
      // Pizz cello — plucks on the downbeats
      ["pizz",   87.3,  1.80, 2.20, .074],  // F2
      ["pizz",   130.8, 4.50, 1.70, .066],  // C3
      ["pizz",   87.3,  7.00, 2.40, .072],  // F2
      ["pizz",   116.5, 9.80, 1.80, .065],  // Bb2
      ["pizz",   87.3, 12.20, 2.40, .070],  // F2
      ["pizz",   130.8,15.00, 1.60, .062],  // C3
      // Flute sings a gentle counter-line in second half
      ["flute",  523.3,11.00, 3.00, .052],  // C5
      ["flute",  440.0,14.40, 1.30, .046],  // A4
      ["flute",  349.2,16.00, 5.50, .038],  // F4 → seam
    ],
  },

  /* ── 6. VERSE  ——  Wonder & Magic  ·  B major ──────────────────────────
     Fairy-tale shimmer. Glass bells ring into silence; music box tines
     dance between them. Delicate and sparkling. B major is very bright.
     Each bell note is given time to ring fully — sparse, deliberate.
     Reverb: plate — medium length, glassy bright reflection.             */
  {
    name:"Verse", sym:"✧", sub:"Magical",
    loopS: 21.0,
    reverb: { taps:[.50,.32,.21], fb:.40, lpHz:4000, wet:.42 },
    padFreqs: [[61.7,-5,.24],[61.7,5,.12],[92.5,-4,.16],[123.5,-2,.08]], // B2×2, F#3, B2
    padLpHz: 200,
    score: [
      // B major: B C# D# E F# G# A# B  (246.9 277.2 311.1 329.6 369.9 415.3 466.2 493.9)
      // B major pentatonic: B C# D# F# G# — shimmering and bright
      ["bell",  493.9, 0.00, 4.50, .072],  // B4 — first bell, held long
      ["bell",  369.9, 5.20, 4.00, .065],  // F#4
      ["bell",  277.2, 9.60, 3.80, .068],  // C#4
      ["bell",  493.9,14.00, 4.00, .070],  // B4 return
      // Music box dances in the spaces
      ["mbox",  987.8, 1.40, 0.60, .065],  // B5 — high, delicate
      ["mbox",  739.9, 2.20, 0.55, .060],  // F#5
      ["mbox",  554.4, 3.00, 0.55, .062],  // C#5
      ["mbox",  493.9, 3.70, 0.60, .060],  // B4
      ["mbox",  369.9, 4.40, 0.55, .058],  // F#4 — descending into bell
      ["mbox",  987.8, 6.40, 0.55, .062],  // B5 restart
      ["mbox",  830.6, 7.20, 0.52, .058],  // G#5
      ["mbox",  739.9, 8.00, 0.55, .060],  // F#5
      ["mbox",  554.4, 8.80, 0.52, .056],  // C#5
      ["mbox",  493.9, 9.50, 0.60, .060],  // B4
      // Flute enters late, floats above
      ["flute", 987.8,14.50, 2.80, .050],  // B5 — high flute
      ["flute", 739.9,17.60, 1.20, .044],  // F#5
      ["flute", 493.9,19.00, 1.80, .037],  // B4 → seam
    ],
  },
];

/* ══════════════════════════════════════════════════════════════════════════
   SCHEDULER + LOOP
   ══════════════════════════════════════════════════════════════════════════ */
const _schedulePhrase = (ctx, bus, send, noise, t0, def) => {
  def.score.forEach(([voice, freq, off, dur, pk]) => {
    const t = t0 + off;
    if      (voice==="marimba") _marimba(ctx,bus,send,freq,pk,dur,t);
    else if (voice==="harp")    _harp(ctx,bus,send,freq,pk,dur,t);
    else if (voice==="koto")    _koto(ctx,bus,send,freq,pk,dur,t);
    else if (voice==="xyl")     _xyl(ctx,bus,send,freq,pk,dur,t);
    else if (voice==="flute")   _flute(ctx,bus,send,freq,pk,dur,t,noise);
    else if (voice==="organ")   _organ(ctx,bus,send,freq,pk,dur,t);
    else if (voice==="bowl")    _bowl(ctx,bus,send,freq,pk,dur,t);
    else if (voice==="piano")   _piano(ctx,bus,send,freq,pk,dur,t);
    else if (voice==="pizz")    _pizz(ctx,bus,send,freq,pk,dur,t);
    else if (voice==="bell")    _bell(ctx,bus,send,freq,pk,dur,t);
    else if (voice==="mbox")    _mbox(ctx,bus,send,freq,pk,dur,t);
  });
};

const _loopTheme = (ctx, bus, send, noise, t0, def) => {
  if (!droneNodes) return;
  _schedulePhrase(ctx, bus, send, noise, t0, def);
  _dt(() => _loopTheme(ctx, bus, send, noise, t0 + def.loopS, def),
      Math.max(50, (def.loopS - .40) * 1000));
};

const THEMES = THEME_DEFS;

/* ══════════════════════════════════════════════════════════════════════════
   MAIN ENGINE
   ══════════════════════════════════════════════════════════════════════════ */
const startDroneEngine = (userVolume, themeId) => {
  if (droneNodes) return;
  const vol = userVolume !== undefined ? userVolume : 0.65;
  const tid = themeId !== undefined ? Math.max(0,Math.min(5,themeId)) : 0;
  const def = THEME_DEFS[tid];
  try {
    const ctx = getAudio();
    if (ctx.state==="suspended") ctx.resume();
    const t = ctx.currentTime;
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value=-10; comp.ratio.value=3.0; comp.knee.value=12;
    comp.attack.value=.05; comp.release.value=1.6;
    const volCtrl = ctx.createGain();
    volCtrl.gain.setValueAtTime(0,t);
    comp.connect(volCtrl); volCtrl.connect(ctx.destination);
    const brLFO=ctx.createOscillator(),brG=ctx.createGain();
    brLFO.type="sine"; brLFO.frequency.value=.052; brG.gain.value=vol*BREATH_D;
    brLFO.connect(brG); brG.connect(volCtrl.gain); brLFO.start();
    const send = _makeReverb(ctx, comp, def.reverb);
    // Pad
    const padLP=ctx.createBiquadFilter(); padLP.type="lowpass"; padLP.frequency.value=def.padLpHz;
    const padBus=ctx.createGain(); padBus.gain.value=.09;
    padBus.connect(padLP); padLP.connect(comp);
    const padLFO=ctx.createOscillator(),padLFOG=ctx.createGain();
    padLFO.type="sine"; padLFO.frequency.value=.024; padLFOG.gain.value=.06;
    padLFO.connect(padLFOG); padLFOG.connect(padBus.gain); padLFO.start();
    const padOscs = def.padFreqs.map(([f,det,g]) => _padVoice(ctx,padBus,f,det,g,t));
    const noise = _makeNoise(ctx, .5);
    _dt(() => _loopTheme(ctx, comp, send, noise, t+2.0, def), 2000);
    volCtrl.gain.cancelScheduledValues(t);
    volCtrl.gain.setValueAtTime(0,t);
    volCtrl.gain.linearRampToValueAtTime(vol*BASE_VOL, t+1.5);
    droneNodes = { ctx, volCtrl, brG, oscs:[...padOscs.flat(),brLFO,padLFO] };
  } catch(e) { console.error("Theme engine:",e); }
};

const setDroneVolume = (v) => {
  if (!droneNodes) return;
  const {ctx,volCtrl,brG} = droneNodes;
  volCtrl.gain.cancelScheduledValues(ctx.currentTime);
  volCtrl.gain.setTargetAtTime(v*BASE_VOL, ctx.currentTime, .12);
  brG.gain.setTargetAtTime(v*BREATH_D, ctx.currentTime, .12);
};

const stopDroneEngine = (instant) => {
  _dTimers.forEach(({k,id}) => k==="t" ? clearTimeout(id) : clearInterval(id));
  _dTimers = [];
  if (!droneNodes) return;
  try {
    const {ctx,volCtrl,oscs} = droneNodes;
    const fade = instant ? .06 : 2.5;
    volCtrl.gain.cancelScheduledValues(ctx.currentTime);
    volCtrl.gain.setValueAtTime(volCtrl.gain.value, ctx.currentTime);
    volCtrl.gain.linearRampToValueAtTime(0, ctx.currentTime+fade);
    setTimeout(() => { oscs.forEach(o=>{try{o.stop();}catch(e){}}); }, (fade+.15)*1000);
  } catch(e) {}
  droneNodes = null;
};


/* ══════════════════════════════════════════════════════════════════════════
   SPLASH EMBLEM — WordSpark central logo (distinct from level glyphs)
   A radiant spark: 8-pointed star with inner diamond, orbiting arcs,
   pulsing glow rings. Different from level glyphs which are geometric
   progressions; this is an iconic spark/crown of knowledge.
   ══════════════════════════════════════════════════════════════════════════ */
const SplashEmblem = ({ size = 260, animated = true }) => {
  const C = size / 2;
  const gold = "#c4a46a";
  const amber = "#d4b47a";
  const dim = "rgba(196,164,106,0.18)";
  const dim2 = "rgba(196,164,106,0.08)";
  const anim = animated ? "splashPulse 3.2s ease-in-out infinite" : "none";
  const anim2 = animated ? "splashSpin 28s linear infinite" : "none";
  const anim3 = animated ? "splashSpin2 18s linear infinite reverse" : "none";

  // 8-pointed star path around center C
  const starPath = () => {
    const pts = [];
    const R1 = size * 0.28, R2 = size * 0.14;
    for (let i = 0; i < 16; i++) {
      const a = (i * Math.PI / 8) - Math.PI / 2;
      const r = i % 2 === 0 ? R1 : R2;
      pts.push(`${C + r * Math.cos(a)},${C + r * Math.sin(a)}`);
    }
    return `M${pts.join("L")}Z`;
  };

  // Inner diamond
  const D = size * 0.11;
  const diaPath = `M${C},${C-D} L${C+D*0.6},${C} L${C},${C+D} L${C-D*0.6},${C}Z`;

  return (
    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={{overflow:"visible",display:"block"}}>
      <defs>
        <radialGradient id="sg1" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stopColor={amber} stopOpacity=".22"/>
          <stop offset="100%" stopColor={gold} stopOpacity="0"/>
        </radialGradient>
        <radialGradient id="sg2" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stopColor={amber} stopOpacity=".55"/>
          <stop offset="60%" stopColor={gold} stopOpacity=".3"/>
          <stop offset="100%" stopColor={gold} stopOpacity="0"/>
        </radialGradient>
        <filter id="sglow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="6" result="blur"/>
          <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
        <filter id="ssoft" x="-20%" y="-20%" width="140%" height="140%">
          <feGaussianBlur stdDeviation="2.5"/>
        </filter>
      </defs>

      {/* Outer glow rings */}
      <circle cx={C} cy={C} r={size*.44} fill={dim2} style={{animation:anim}}/>
      <circle cx={C} cy={C} r={size*.36} fill={dim} style={{animation:anim}}/>

      {/* Outer rotating arc ring */}
      <g style={{transformOrigin:`${C}px ${C}px`,animation:anim2}}>
        {[0,45,90,135,180,225,270,315].map((a,i) => (
          <line key={i}
            x1={C + size*.34*Math.cos(a*Math.PI/180)}
            y1={C + size*.34*Math.sin(a*Math.PI/180)}
            x2={C + size*.42*Math.cos(a*Math.PI/180)}
            y2={C + size*.42*Math.sin(a*Math.PI/180)}
            stroke={gold} strokeWidth={i%2===0?1.5:.8} strokeOpacity={i%2===0?.6:.35}
          />
        ))}
        <circle cx={C} cy={C} r={size*.38} fill="none" stroke={gold} strokeWidth=".8" strokeOpacity=".22"
          strokeDasharray={`${size*.06} ${size*.12}`}/>
      </g>

      {/* Inner rotating arc ring */}
      <g style={{transformOrigin:`${C}px ${C}px`,animation:anim3}}>
        <circle cx={C} cy={C} r={size*.22} fill="none" stroke={gold} strokeWidth=".7" strokeOpacity=".28"
          strokeDasharray={`${size*.04} ${size*.08}`}/>
        {[22.5,67.5,112.5,157.5,202.5,247.5,292.5,337.5].map((a,i) => (
          <circle key={i}
            cx={C + size*.22*Math.cos(a*Math.PI/180)}
            cy={C + size*.22*Math.sin(a*Math.PI/180)}
            r={2.2} fill={gold} fillOpacity=".45"
          />
        ))}
      </g>

      {/* Star glow (blurred) */}
      <path d={starPath()} fill={gold} opacity=".22" filter="url(#ssoft)"/>

      {/* 8-pointed star */}
      <path d={starPath()} fill="none" stroke={gold} strokeWidth="1.2" strokeOpacity=".75" filter="url(#sglow)"/>
      <path d={starPath()} fill={`url(#sg2)`}/>

      {/* Central circle */}
      <circle cx={C} cy={C} r={size*.075} fill="none" stroke={amber} strokeWidth="1.5" strokeOpacity=".8"/>
      <circle cx={C} cy={C} r={size*.055} fill={amber} fillOpacity=".35"/>

      {/* Inner diamond */}
      <path d={diaPath} fill="none" stroke={amber} strokeWidth="1.2" strokeOpacity=".7"/>
      <path d={diaPath} fill={amber} fillOpacity=".2"/>

      {/* Center spark dot */}
      <circle cx={C} cy={C} r={size*.022} fill={amber} fillOpacity=".9"/>
    </svg>
  );
};

const TITLES = [
  "Novice Etymologist", "Word Apprentice", "Root Seeker", "Lexicon Scout",
  "Language Archaeologist", "Etymology Adept", "Philological Scholar",
  "Word Origin Master", "Linguistic Sage", "Grandmaster Etymologist"
];

const getTitle = (level) => TITLES[Math.min(level - 1, TITLES.length - 1)];

/* ═══════════════════════════════════════════════════════════════════════════
   QUIZ GENERATION
   ═══════════════════════════════════════════════════════════════════════════ */
const ROOT_MEANINGS_POOL = [
  "war, conflict","water, sea","fire, heat","stone, rock","love, desire","king, ruler",
  "earth, land","time, age","life, living","death, dying","light, bright","dark, shadow",
  "hand, touch","eye, sight","voice, speak","tree, wood","blood, red","wind, breath",
  "gold, wealth","child, young","field, plain","song, sing","ship, sail","fear, dread",
  "truth, real","sleep, dream","city, town","law, rule","write, mark","eat, devour"
];

const generateRounds = (todaysWords, rng) => {
  const rounds = [];
  const all = WORDS;

  todaysWords.forEach(w => {
    // 1: Root meaning
    if (w.roots.length > 0) {
      const r = w.roots[Math.floor(rng() * w.roots.length)];
      const wrongs = ROOT_MEANINGS_POOL.filter(m => m !== r.meaning);
      rounds.push({ type:"root_meaning", wordObj:w, q:`What does "${r.part}" mean?`, sub:`Root found in "${w.word}"`,
        choices: shuffle([r.meaning, ...shuffle(wrongs, rng).slice(0,3)], rng), answer: r.meaning,
        explain:`"${r.part}" = "${r.meaning}" (${r.lang})` });
    }

    // 2: Language of origin
    const origins = [...new Set(all.map(x=>x.origin))];
    rounds.push({ type:"origin", wordObj:w, q:`What language does "${w.word}" come from?`, sub:"Trace it back to its oldest root",
      choices: shuffle([w.origin, ...shuffle(origins.filter(o=>o!==w.origin), rng).slice(0,3)], rng), answer: w.origin,
      explain: w.etymology });

    // 3: Word relatives
    if (w.relatives.length >= 2) {
      const correct = w.relatives[Math.floor(rng() * w.relatives.length)];
      const unrelated = shuffle(all.filter(x=>x.word!==w.word), rng).flatMap(x=>x.relatives).filter(r=>!w.relatives.includes(r));
      if (unrelated.length >= 3) {
        rounds.push({ type:"relatives", wordObj:w, q:`Which word is an etymological cousin of "${w.word}"?`, sub:"They share an ancient root",
          choices: shuffle([correct, ...shuffle(unrelated, rng).slice(0,3)], rng), answer: correct,
          explain:`Both trace back to: ${w.roots.map(r=>r.part+' ('+r.meaning+')').join(', ')}` });
      }
    }

    // 4: Fun fact / True etymology
    const wrongEtys = shuffle(all.filter(x=>x.word!==w.word), rng).slice(0,3).map(x => x.etymology);
    rounds.push({ type:"etymology_match", wordObj:w, q:`Which origin story is correct for "${w.word}"?`, sub:"Pick the true etymology",
      choices: shuffle([w.etymology, ...wrongEtys], rng).slice(0,4), answer: w.etymology,
      explain: w.funFact });

    // 5: Reverse — given the etymology, name the word
    const wrongWords = shuffle(all.filter(x=>x.word!==w.word), rng).slice(0,3).map(x=>x.word);
    rounds.push({ type:"reverse", wordObj:w, q:`Which word comes from: "${w.etymology}"?`, sub:"Match the origin to the word",
      choices: shuffle([w.word, ...wrongWords], rng), answer: w.word, explain: w.funFact });

    // 6: Fun Fact Match — given the fun fact, name the word
    const wrongWordsFf = shuffle(all.filter(x=>x.word!==w.word), rng).slice(0,3).map(x=>x.word);
    rounds.push({ type:"funfact_match", wordObj:w,
      q: w.funFact,
      sub:"Which word does this describe?",
      choices: shuffle([w.word, ...wrongWordsFf], rng), answer: w.word,
      explain:`${w.etymology} — ${w.def}` });
  });

  return shuffle(rounds, rng).slice(0, 20);
};

/* ═══════════════════════════════════════════════════════════════════════════
   STORAGE
   ═══════════════════════════════════════════════════════════════════════════ */
const SKEY = "wordspark-ety-v2";
const load = async () => { try { const r = await window.storage.get(SKEY); return r ? JSON.parse(r.value) : null; } catch { return null; } };
const save = async (s) => { try { await window.storage.set(SKEY, JSON.stringify(s)); } catch {} };
const INIT_STATE = { dayKey:null, streak:0, bestStreak:0, totalWords:0, completedToday:false, todayScore:0, todayTotal:0, todayXP:0, xp:0, level:1, lastDay:null, seenIdx:[], soundOn:true };

/* ═══════════════════════════════════════════════════════════════════════════
   LANG ICONS
   ═══════════════════════════════════════════════════════════════════════════ */
const LANG_ICONS = {"Greek":"🏛️","Latin":"🏛️","Arabic":"🕌","Arabic/Persian":"🕌","Persian/Arabic":"🕌","Italian":"🇮🇹","Italian/Greek":"🇮🇹","Old French":"⚜️","French":"⚜️","English (coined)":"🇬🇧","English":"🇬🇧","Old English":"🗡️","Greek myth":"🏛️","Greek (coined)":"🏛️","Persian":"🕌","Persian/Arabic":"🕌"};
const langIcon = l => LANG_ICONS[l] || "📜";

/* ═══════════════════════════════════════════════════════════════════════════
   PARTICLE SYSTEM
   ═══════════════════════════════════════════════════════════════════════════ */
const Particles = ({ active, type }) => {
  const canvasRef = useRef(null);
  const particles = useRef([]);
  const animRef = useRef(null);

  useEffect(() => {
    if (!active || !canvasRef.current) return;
    const canvas = canvasRef.current;
    const ctx = canvas.getContext("2d");
    canvas.width = canvas.offsetWidth * 2;
    canvas.height = canvas.offsetHeight * 2;
    ctx.scale(2, 2);
    const W = canvas.offsetWidth, H = canvas.offsetHeight;

    const colors = type === "correct"
      ? ["#c4a46a","#e8a849","#7eb87e","#d4b87a","#fff"]
      : type === "combo" ? ["#ff6b6b","#ffd93d","#6bcb77","#4d96ff","#ff6b6b","#fff"]
      : type === "levelup" ? ["#ffd700","#ff6b00","#ff0","#fff","#ffd700"]
      : ["#c4a46a"];

    const count = type === "combo" ? 40 : type === "levelup" ? 60 : 20;
    particles.current = Array.from({ length: count }, () => ({
      x: W / 2 + (Math.random() - 0.5) * 80,
      y: H / 2,
      vx: (Math.random() - 0.5) * (type === "levelup" ? 12 : 8),
      vy: -Math.random() * (type === "levelup" ? 14 : 10) - 2,
      size: Math.random() * 4 + 2,
      color: colors[Math.floor(Math.random() * colors.length)],
      life: 1,
      decay: 0.01 + Math.random() * 0.02,
      gravity: 0.15
    }));

    const animate = () => {
      ctx.clearRect(0, 0, W, H);
      let alive = false;
      particles.current.forEach(p => {
        if (p.life <= 0) return;
        alive = true;
        p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.life -= p.decay;
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
      });
      ctx.globalAlpha = 1;
      if (alive) animRef.current = requestAnimationFrame(animate);
    };
    animate();
    return () => { if (animRef.current) cancelAnimationFrame(animRef.current); };
  }, [active, type]);

  if (!active) return null;
  return <canvas ref={canvasRef} style={{ position:"absolute", inset:0, pointerEvents:"none", zIndex:50 }} />;
};

/* ══════════════════════════════════════════════════════════════════════════
   LEVEL GLYPHS — 10 unique emblems, each level visually distinct
   L1: Seed (single point + orbit)          L2: Duality (vesica piscis)
   L3: Trinity (triangle portal)            L4: Compass (double square star)
   L5: Pentagram (5-star)                   L6: Hexagram (Star of David)
   L7: Septagram (7-fold star)              L8: Octagram mandala
   L9: Enneagram (9-fold wheel)             L10: Metatron (full mandala)
   ═══════════════════════════════════════════════════════════════════════════ */
const LevelGlyph = ({ level, xpPct, size = 200 }) => {
  const svgRef = useRef(null);
  const frameRef = useRef(null);

  useEffect(() => {
    const el = svgRef.current;
    if (!el) return;
    let rot = 0;
    const tick = () => {
      rot += 0.0025;
      el.querySelectorAll("[data-spin]").forEach(g => {
        const dir = g.dataset.spin === "cw" ? 1 : -1;
        const speed = parseFloat(g.dataset.speed || "1");
        g.style.transform = `rotate(${rot * dir * speed}rad)`;
      });
      frameRef.current = requestAnimationFrame(tick);
    };
    frameRef.current = requestAnimationFrame(tick);
    return () => cancelAnimationFrame(frameRef.current);
  }, [level]);

  const C = size / 2;
  const R = C - 12;

  // Color tokens
  const gold  = "rgba(196,164,106,0.90)";
  const goldD = "rgba(196,164,106,0.22)";
  const amb   = "rgba(232,168,73,0.70)";
  const ambD  = "rgba(232,168,73,0.18)";
  const glow  = "rgba(232,168,73,0.35)";

  // Helpers
  const pt = (cx, cy, r, a) => [cx + r*Math.cos(a), cy + r*Math.sin(a)];
  const poly = (cx, cy, r, n, off=0) =>
    Array.from({length:n},(_,i) => pt(cx,cy,r,(i*2*Math.PI/n)+off)).map(p=>p.join(",")).join(" ");
  const star = (cx, cy, ro, ri, n, off=0) =>
    Array.from({length:n*2},(_,i) => {
      const r2 = i%2===0?ro:ri;
      return pt(cx,cy,r2,(i*Math.PI/n)+off).join(",");
    }).join(" ");

  // XP ring (common to all levels)
  const circ = 2*Math.PI*R;
  const dash = circ*(1 - xpPct/100);
  const XpRing = () => (
    <g>
      <circle cx={C} cy={C} r={R} fill="none" stroke={goldD} strokeWidth="2"/>
      <circle cx={C} cy={C} r={R} fill="none" stroke={amb} strokeWidth="2.5"
        strokeDasharray={circ} strokeDashoffset={dash} strokeLinecap="round"
        transform={`rotate(-90 ${C} ${C})`}
        style={{transition:"stroke-dashoffset .8s ease",filter:`drop-shadow(0 0 5px ${glow})`}}/>
    </g>
  );
  const Center = ({n}) => {
    // Wider backing for two-digit numbers
    const backR = String(n).length > 1 ? R * 0.30 : R * 0.24;
    return (
      <>
        {/* Frosted dark disc — isolates the number from the geometry behind it */}
        <circle cx={C} cy={C} r={backR}
          fill="rgba(8,6,4,0.78)"
          stroke="rgba(196,164,106,0.18)" strokeWidth="1" />
        <text x={C} y={C - 4} textAnchor="middle"
          fontFamily="'Cormorant Garamond',serif" fontSize={R * 0.34} fontWeight="700"
          fill="rgba(235,205,145,1.0)" letterSpacing="-1">{n}</text>
        <text x={C} y={C + 14} textAnchor="middle"
          fontFamily="'Outfit',sans-serif" fontSize="8" fontWeight="500"
          fill="rgba(196,164,106,0.55)" letterSpacing="2">LEVEL</text>
      </>
    );
  };

  const defs = (
    <defs>
      <radialGradient id="rg" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stopColor={ambD}/>
        <stop offset="100%" stopColor="transparent"/>
      </radialGradient>
      <filter id="gf" x="-30%" y="-30%" width="160%" height="160%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="2.5" result="b"/>
        <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
      <filter id="gf2" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="b"/>
        <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
  );

  const base = {overflow:"visible", display:"block", margin:"0 auto"};

  // ── L1: SEED — a single luminous point with two orbiting rings ──
  if (level === 1) return (
    <svg ref={svgRef} width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={base}>
      {defs}
      <circle cx={C} cy={C} r={R*0.72} fill="url(#rg)"/>
      <XpRing/>
      <g data-spin="cw" data-speed="0.6" style={{transformOrigin:`${C}px ${C}px`}}>
        <circle cx={C} cy={C} r={R*0.52} fill="none" stroke={goldD} strokeWidth="1" strokeDasharray="4 8"/>
      </g>
      <g data-spin="ccw" data-speed="1.0" style={{transformOrigin:`${C}px ${C}px`}}>
        <circle cx={C+R*0.28} cy={C} r={5} fill={amb} filter="url(#gf)"/>
      </g>
      <circle cx={C} cy={C} r={R*0.22} fill="none" stroke={goldD} strokeWidth="1"/>
      <circle cx={C} cy={C} r={7} fill={amb} filter="url(#gf2)"/>
      <circle cx={C} cy={C} r={3} fill={gold}/>
      <Center n={1}/>
    </svg>
  );

  // ── L2: DUALITY — vesica piscis, two interlocking circles ──
  if (level === 2) return (
    <svg ref={svgRef} width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={base}>
      {defs}
      <circle cx={C} cy={C} r={R*0.72} fill="url(#rg)"/>
      <XpRing/>
      <g data-spin="cw" data-speed="0.4" style={{transformOrigin:`${C}px ${C}px`}}>
        <circle cx={C-R*0.22} cy={C} r={R*0.44} fill="none" stroke={goldD} strokeWidth="1.2"/>
        <circle cx={C+R*0.22} cy={C} r={R*0.44} fill="none" stroke={goldD} strokeWidth="1.2"/>
      </g>
      <circle cx={C-R*0.22} cy={C} r={R*0.44} fill="none" stroke={gold} strokeWidth="1.5" filter="url(#gf)" opacity="0.6"/>
      <circle cx={C+R*0.22} cy={C} r={R*0.44} fill="none" stroke={gold} strokeWidth="1.5" filter="url(#gf)" opacity="0.6"/>
      <g data-spin="ccw" data-speed="0.8" style={{transformOrigin:`${C}px ${C}px`}}>
        <line x1={C-R*0.6} y1={C} x2={C+R*0.6} y2={C} stroke={goldD} strokeWidth="0.8"/>
        <circle cx={C-R*0.38} cy={C} r={3.5} fill={amb}/>
        <circle cx={C+R*0.38} cy={C} r={3.5} fill={amb}/>
      </g>
      <circle cx={C} cy={C} r={4} fill={amb} filter="url(#gf2)"/>
      <Center n={2}/>
    </svg>
  );

  // ── L3: TRINITY — triangle portal with inner triangle ──
  if (level === 3) return (
    <svg ref={svgRef} width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={base}>
      {defs}
      <circle cx={C} cy={C} r={R*0.72} fill="url(#rg)"/>
      <XpRing/>
      <g data-spin="cw" data-speed="0.5" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.82,3,-Math.PI/2)} fill="none" stroke={goldD} strokeWidth="1"/>
      </g>
      <polygon points={poly(C,C,R*0.65,3,-Math.PI/2)} fill="none" stroke={gold} strokeWidth="1.8" filter="url(#gf)"/>
      <g data-spin="ccw" data-speed="0.9" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.38,3,Math.PI/6)} fill={ambD} stroke={amb} strokeWidth="1.2" filter="url(#gf)"/>
      </g>
      {/* Vertices */}
      {[0,1,2].map(i => {
        const a = -Math.PI/2 + i*2*Math.PI/3;
        const [x,y] = pt(C,C,R*0.65,a);
        return <circle key={i} cx={x} cy={y} r={4} fill={amb} filter="url(#gf)"/>;
      })}
      <circle cx={C} cy={C} r={5} fill={amb} filter="url(#gf2)"/>
      <circle cx={C} cy={C} r={2.5} fill={gold}/>
      <Center n={3}/>
    </svg>
  );

  // ── L4: COMPASS STAR — overlapping square + rotated square (8-pointed star) ──
  if (level === 4) return (
    <svg ref={svgRef} width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={base}>
      {defs}
      <circle cx={C} cy={C} r={R*0.72} fill="url(#rg)"/>
      <XpRing/>
      <g data-spin="cw" data-speed="0.4" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.78,4,0)} fill="none" stroke={goldD} strokeWidth="1"/>
        <polygon points={poly(C,C,R*0.78,4,Math.PI/4)} fill="none" stroke={goldD} strokeWidth="1"/>
      </g>
      <polygon points={star(C,C,R*0.60,R*0.28,8,0)} fill={ambD} stroke={gold} strokeWidth="1.5" filter="url(#gf)"/>
      <g data-spin="ccw" data-speed="1.2" style={{transformOrigin:`${C}px ${C}px`}}>
        <circle cx={C} cy={C} r={R*0.28} fill="none" stroke={goldD} strokeWidth="1"/>
        {[0,1,2,3].map(i => {
          const a = i*Math.PI/2; const [x,y]=pt(C,C,R*0.28,a);
          return <circle key={i} cx={x} cy={y} r={3} fill={amb}/>;
        })}
      </g>
      <circle cx={C} cy={C} r={6} fill={amb} filter="url(#gf2)"/>
      <circle cx={C} cy={C} r={2.5} fill={gold}/>
      <Center n={4}/>
    </svg>
  );

  // ── L5: PENTAGRAM — 5-star with inner pentagon ──
  if (level === 5) return (
    <svg ref={svgRef} width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={base}>
      {defs}
      <circle cx={C} cy={C} r={R*0.72} fill="url(#rg)"/>
      <XpRing/>
      <g data-spin="cw" data-speed="0.35" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.82,5,-Math.PI/2)} fill="none" stroke={goldD} strokeWidth="1"/>
      </g>
      <polygon points={star(C,C,R*0.65,R*0.27,5,-Math.PI/2)} fill="rgba(196,164,106,0.06)" stroke={gold} strokeWidth="1.8" filter="url(#gf)"/>
      <g data-spin="ccw" data-speed="0.7" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.30,5,Math.PI/10)} fill={ambD} stroke={amb} strokeWidth="1.2" filter="url(#gf)"/>
      </g>
      {/* Star tips */}
      {[0,1,2,3,4].map(i => {
        const a = -Math.PI/2+i*2*Math.PI/5; const [x,y]=pt(C,C,R*0.65,a);
        return <circle key={i} cx={x} cy={y} r={3.5} fill={amb} filter="url(#gf)"/>;
      })}
      <circle cx={C} cy={C} r={6} fill={amb} filter="url(#gf2)"/>
      <circle cx={C} cy={C} r={2.5} fill={gold}/>
      <Center n={5}/>
    </svg>
  );

  // ── L6: HEXAGRAM — Star of David + inner hexagon ring ──
  if (level === 6) return (
    <svg ref={svgRef} width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={base}>
      {defs}
      <circle cx={C} cy={C} r={R*0.72} fill="url(#rg)"/>
      <XpRing/>
      <g data-spin="cw" data-speed="0.3" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.80,6,0)} fill="none" stroke={goldD} strokeWidth="1"/>
      </g>
      {/* Hexagram = two triangles */}
      <polygon points={poly(C,C,R*0.60,3,-Math.PI/2)} fill="rgba(196,164,106,0.05)" stroke={gold} strokeWidth="1.6" filter="url(#gf)"/>
      <polygon points={poly(C,C,R*0.60,3,Math.PI/6)} fill="rgba(196,164,106,0.05)" stroke={gold} strokeWidth="1.6" filter="url(#gf)"/>
      <g data-spin="ccw" data-speed="0.8" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.30,6,0)} fill={ambD} stroke={amb} strokeWidth="1.4" filter="url(#gf)"/>
      </g>
      {/* 6 tip dots */}
      {[0,1,2,3,4,5].map(i => {
        const a = -Math.PI/2+i*Math.PI/3; const [x,y]=pt(C,C,R*0.60,a+(i%2?Math.PI/6:0));
        return <circle key={i} cx={x} cy={y} r={3} fill={amb} filter="url(#gf)"/>;
      })}
      <circle cx={C} cy={C} r={7} fill={amb} filter="url(#gf2)"/>
      <circle cx={C} cy={C} r={2.5} fill={gold}/>
      <Center n={6}/>
    </svg>
  );

  // ── L7: SEPTAGRAM — 7-pointed star + inner circle web ──
  if (level === 7) return (
    <svg ref={svgRef} width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={base}>
      {defs}
      <circle cx={C} cy={C} r={R*0.72} fill="url(#rg)"/>
      <XpRing/>
      <g data-spin="cw" data-speed="0.28" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.82,7,-Math.PI/2)} fill="none" stroke={goldD} strokeWidth="1"/>
        {/* Web: every vertex connects to vertex+2 */}
        {[0,1,2,3,4,5,6].map(i => {
          const [x1,y1]=pt(C,C,R*0.82,(i*2*Math.PI/7)-Math.PI/2);
          const [x2,y2]=pt(C,C,R*0.82,((i+2)*2*Math.PI/7)-Math.PI/2);
          return <line key={i} x1={x1} y1={y1} x2={x2} y2={y2} stroke={goldD} strokeWidth="0.6"/>;
        })}
      </g>
      <polygon points={star(C,C,R*0.62,R*0.26,7,-Math.PI/2)} fill="rgba(196,164,106,0.06)" stroke={gold} strokeWidth="1.7" filter="url(#gf)"/>
      <g data-spin="ccw" data-speed="1.1" style={{transformOrigin:`${C}px ${C}px`}}>
        <circle cx={C} cy={C} r={R*0.28} fill="none" stroke={amb} strokeWidth="1" strokeDasharray="3 5"/>
      </g>
      <circle cx={C} cy={C} r={7} fill={amb} filter="url(#gf2)"/>
      <circle cx={C} cy={C} r={3} fill={gold}/>
      <Center n={7}/>
    </svg>
  );

  // ── L8: OCTAGRAM MANDALA — 8-star + 3 concentric rings + spokes ──
  if (level === 8) return (
    <svg ref={svgRef} width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={base}>
      {defs}
      <circle cx={C} cy={C} r={R*0.72} fill="url(#rg)"/>
      <XpRing/>
      <g data-spin="cw" data-speed="0.25" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.82,8,0)} fill="none" stroke={goldD} strokeWidth="1"/>
        {[0,1,2,3,4,5,6,7].map(i => {
          const a=i*Math.PI/4; const [x,y]=pt(C,C,R*0.82,a);
          return <line key={i} x1={C} y1={C} x2={x} y2={y} stroke={goldD} strokeWidth="0.5"/>;
        })}
      </g>
      <polygon points={star(C,C,R*0.60,R*0.28,8,Math.PI/8)} fill="rgba(196,164,106,0.07)" stroke={gold} strokeWidth="1.6" filter="url(#gf)"/>
      <g data-spin="ccw" data-speed="0.9" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.40,8,Math.PI/8)} fill="none" stroke={amb} strokeWidth="1.2" filter="url(#gf)"/>
      </g>
      <g data-spin="cw" data-speed="1.8" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.22,8,0)} fill={ambD} stroke={amb} strokeWidth="1.2" filter="url(#gf)"/>
      </g>
      {/* 8 tip diamonds */}
      {[0,1,2,3,4,5,6,7].map(i=>{
        const [x,y]=pt(C,C,R*0.60,i*Math.PI/4+Math.PI/8);
        return <circle key={i} cx={x} cy={y} r={3} fill={amb} filter="url(#gf)"/>;
      })}
      <circle cx={C} cy={C} r={8} fill={amb} filter="url(#gf2)"/>
      <circle cx={C} cy={C} r={3} fill={gold}/>
      <Center n={8}/>
    </svg>
  );

  // ── L9: ENNEAGRAM WHEEL — 9-fold geometry with 3-layer rings ──
  if (level === 9) return (
    <svg ref={svgRef} width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={base}>
      {defs}
      <circle cx={C} cy={C} r={R*0.72} fill="url(#rg)"/>
      <XpRing/>
      <g data-spin="cw" data-speed="0.22" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.82,9,-Math.PI/2)} fill="none" stroke={goldD} strokeWidth="1"/>
        {/* 9-web: every vertex to vertex+3 */}
        {[0,1,2,3,4,5,6,7,8].map(i=>{
          const [x1,y1]=pt(C,C,R*0.82,(i*2*Math.PI/9)-Math.PI/2);
          const [x2,y2]=pt(C,C,R*0.82,((i+3)*2*Math.PI/9)-Math.PI/2);
          return <line key={i} x1={x1} y1={y1} x2={x2} y2={y2} stroke={goldD} strokeWidth="0.6"/>;
        })}
      </g>
      <polygon points={star(C,C,R*0.62,R*0.24,9,-Math.PI/2)} fill="rgba(196,164,106,0.06)" stroke={gold} strokeWidth="1.7" filter="url(#gf)"/>
      <g data-spin="ccw" data-speed="0.7" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.42,9,Math.PI/18)} fill="none" stroke={goldD} strokeWidth="1"/>
      </g>
      <g data-spin="cw" data-speed="1.5" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.24,3,-Math.PI/2)} fill={ambD} stroke={amb} strokeWidth="1.5" filter="url(#gf)"/>
        <polygon points={poly(C,C,R*0.24,3,Math.PI/6)} fill={ambD} stroke={amb} strokeWidth="1.5" filter="url(#gf)"/>
      </g>
      {/* 9 outer dots */}
      {[0,1,2,3,4,5,6,7,8].map(i=>{
        const [x,y]=pt(C,C,R*0.62,(i*2*Math.PI/9)-Math.PI/2);
        return <circle key={i} cx={x} cy={y} r={3} fill={amb} filter="url(#gf)"/>;
      })}
      <circle cx={C} cy={C} r={9} fill={amb} filter="url(#gf2)"/>
      <circle cx={C} cy={C} r={3.5} fill={gold}/>
      <Center n={9}/>
    </svg>
  );

  // ── L10: METATRON — 13-circle Fruit of Life + 6-fold star web (maximum) ──
  return (
    <svg ref={svgRef} width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={base}>
      {defs}
      <circle cx={C} cy={C} r={R*0.72} fill="url(#rg)"/>
      <XpRing/>
      {/* Outer 12-circle flower ring (fixed) */}
      {[0,1,2,3,4,5,6,7,8,9,10,11].map(i=>{
        const a=i*Math.PI/6; const r2=R*0.62;
        const [x,y]=pt(C,C,r2,a);
        return <circle key={i} cx={x} cy={y} r={R*0.20} fill="none" stroke={goldD} strokeWidth="0.8"/>;
      })}
      {/* First slow ring */}
      <g data-spin="cw" data-speed="0.18" style={{transformOrigin:`${C}px ${C}px`}}>
        {[0,1,2,3,4,5].map(i=>{
          const a=i*Math.PI/3; const [x1,y1]=pt(C,C,R*0.62,a);
          const [x2,y2]=pt(C,C,R*0.62,a+Math.PI);
          return <line key={i} x1={x1} y1={y1} x2={x2} y2={y2} stroke={goldD} strokeWidth="0.7"/>;
        })}
        <polygon points={poly(C,C,R*0.80,6,0)} fill="none" stroke={goldD} strokeWidth="1"/>
      </g>
      {/* Hexagram double triangle */}
      <polygon points={poly(C,C,R*0.58,3,-Math.PI/2)} fill="rgba(196,164,106,0.05)" stroke={gold} strokeWidth="1.5" filter="url(#gf)"/>
      <polygon points={poly(C,C,R*0.58,3,Math.PI/6)} fill="rgba(196,164,106,0.05)" stroke={gold} strokeWidth="1.5" filter="url(#gf)"/>
      {/* Counter-rotating inner star */}
      <g data-spin="ccw" data-speed="0.6" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={star(C,C,R*0.40,R*0.18,12,0)} fill="rgba(196,164,106,0.05)" stroke={amb} strokeWidth="1.2" filter="url(#gf)"/>
      </g>
      {/* Fast inner diamond ring */}
      <g data-spin="cw" data-speed="1.4" style={{transformOrigin:`${C}px ${C}px`}}>
        <polygon points={poly(C,C,R*0.22,6,0)} fill={ambD} stroke={amb} strokeWidth="1.6" filter="url(#gf)"/>
        <polygon points={poly(C,C,R*0.22,6,Math.PI/6)} fill={ambD} stroke={amb} strokeWidth="1.0" filter="url(#gf)"/>
      </g>
      {/* 12 outer orbit dots */}
      {[0,1,2,3,4,5,6,7,8,9,10,11].map(i=>{
        const [x,y]=pt(C,C,R*0.82,i*Math.PI/6);
        return <circle key={i} cx={x} cy={y} r={2.5} fill={amb} filter="url(#gf)"/>;
      })}
      {/* 6 inner ring dots */}
      {[0,1,2,3,4,5].map(i=>{
        const [x,y]=pt(C,C,R*0.44,i*Math.PI/3+Math.PI/6);
        return <circle key={`i${i}`} cx={x} cy={y} r={3.5} fill={amb} filter="url(#gf)"/>;
      })}
      <circle cx={C} cy={C} r={12} fill={amb} filter="url(#gf2)"/>
      <circle cx={C} cy={C} r={5} fill={gold}/>
      <Center n={10}/>
    </svg>
  );
};

/* ═══════════════════════════════════════════════════════════════════════════
   MAIN COMPONENT
   ═══════════════════════════════════════════════════════════════════════════ */
function WordSparkEtymology() {
  const [st, setSt] = useState(null);
  const [phase, setPhase] = useState("loading");
  const [gameMode, setGameMode] = useState(null); // null=home, "etymology","lexicon","kids"
  const [words, setWords] = useState([]);
  const [learnIdx, setLearnIdx] = useState(0);
  const [rounds, setRounds] = useState([]);
  const [rIdx, setRIdx] = useState(0);
  const [score, setScore] = useState(0);
  const [xpGained, setXpGained] = useState(0);
  const [combo, setCombo] = useState(0);
  const [maxCombo, setMaxCombo] = useState(0);
  const [selected, setSelected] = useState(null);
  const [showExplain, setShowExplain] = useState(false);
  const [particles, setParticles] = useState({ active: false, type: "correct" });
  const [shake, setShake] = useState(false);
  const [comboPopup, setComboPopup] = useState(null);
  const [xpPopup, setXpPopup] = useState(null);
  const [speedMode, setSpeedMode] = useState(false);
  const [speedTimer, setSpeedTimer] = useState(0);
  const [speedPhase, setSpeedPhase] = useState("off"); // off, active, done
  const [speedScore, setSpeedScore] = useState(0);
  const [speedTotal, setSpeedTotal] = useState(0);
  const [soundOn, setSoundOn] = useState(true);
  const [musicVolume, setMusicVolume] = useState(0.65);
  const [musicTheme, setMusicTheme] = useState(0);
  const [showVolPanel, setShowVolPanel] = useState(false);
  const [isBonusRound, setIsBonusRound] = useState(false);
  const [bonusRoundNum, setBonusRoundNum] = useState(0);
  const [bonusScore, setBonusScore] = useState(0);
  const [bonusTotal, setBonusTotal] = useState(0);
  const [quizScore, setQuizScore] = useState(0);
  const [quizTotal, setQuizTotal] = useState(0);
  const [profileWordFilter, setProfileWordFilter] = useState("");
  const [profileSortBy, setProfileSortBy] = useState("recent");
  const [prevPhase, setPrevPhase] = useState("welcome");
  const [expandedLexWord, setExpandedLexWord] = useState(null);
  const [scoreShared, setScoreShared] = useState(false);

  // ── Vocab Builder state ───────────────────────────────────────
  const [vbPhase, setVbPhase] = useState("welcome");
  const [vbWords, setVbWords] = useState([]);
  const [vbLearnIdx, setVbLearnIdx] = useState(0);
  const [vbRounds, setVbRounds] = useState([]);
  const [vbRIdx, setVbRIdx] = useState(0);
  const [vbSelected, setVbSelected] = useState(null);
  const [vbScore, setVbScore] = useState(0);
  const [vbXpGained, setVbXpGained] = useState(0);
  const [vbShowAnchor, setVbShowAnchor] = useState(false);

  const timerRef = useRef(null);
  const styleRef = useRef(null);
  const appRef = useRef(null);

  const playFx = useCallback((type) => { if (soundOn) playSound(type); }, [soundOn]);

  // CSS injection
  useEffect(() => {
    if (!styleRef.current) {
      styleRef.current = document.createElement("style");
      styleRef.current.textContent = CSS;
      document.head.appendChild(styleRef.current);
    }
    return () => { if (styleRef.current) { styleRef.current.remove(); styleRef.current = null; } };
  }, []);

  // Ambient drone — starts immediately on mount, resumes on first interaction if browser blocked
  useEffect(() => {
    if (soundOn) {
      // Try to start immediately (works if user already interacted)
      startDroneEngine(musicVolume, musicTheme);
      // Also attach a one-time click/touch handler to resume after browser autoplay block
      const resume = () => {
        if (!droneNodes) startDroneEngine(musicVolume, musicTheme);
        else { try { droneNodes.ctx.resume(); } catch(e) {} }
        document.removeEventListener("click", resume);
        document.removeEventListener("touchstart", resume);
        document.removeEventListener("pointerdown", resume);
        document.removeEventListener("keydown", resume);
      };
      document.addEventListener("click", resume);
      document.addEventListener("touchstart", resume);
      document.addEventListener("pointerdown", resume);
      document.addEventListener("keydown", resume);
      return () => {
        document.removeEventListener("click", resume);
        document.removeEventListener("touchstart", resume);
        document.removeEventListener("pointerdown", resume);
        document.removeEventListener("keydown", resume);
        stopDroneEngine(true);
      };
    } else {
      stopDroneEngine();
    }
  }, [soundOn]);

  // Keyboard shortcuts: 1-4 for quiz choices
  useEffect(() => {
    const handler = (e) => {
      if (phase !== "quiz" || selected !== null || !rounds[rIdx]) return;
      const n = parseInt(e.key);
      if (n >= 1 && n <= rounds[rIdx].choices.length) {
        handleAnswer(rounds[rIdx].choices[n - 1]);
      }
    };
    window.addEventListener("keydown", handler);
    return () => window.removeEventListener("keydown", handler);
  }, [phase, selected, rounds, rIdx]);

  // Load
  useEffect(() => {
    (async () => {
      const saved = await load();
      const today = getDayKey();
      if (saved && saved.dayKey === today) {
        setSt(saved);
        setSoundOn(true); // always start with sound on
        if (saved.completedToday) { setupWords(saved, today); setPhase("results"); }
        else setPhase("welcome");
      } else {
        const prev = saved || INIT_STATE;
        const consecutive = saved && saved.lastDay === getPrevDayKey();
        const ns = { ...INIT_STATE, dayKey:today, streak:consecutive?prev.streak:0, bestStreak:prev.bestStreak||0, totalWords:prev.totalWords||0, xp:prev.xp||0, level:prev.level||1, seenIdx:prev.seenIdx||[], soundOn:true }; // always start muted-off
        setSt(ns); setSoundOn(true); setPhase("welcome");
      }
    })();
  }, []);

  const setupWords = useCallback((s, today) => {
    const rng = seededRng(today + "-ety2");
    const seenSet = new Set(s.seenIdx || []);
    let avail = WORDS.map((_,i) => i).filter(i => !seenSet.has(i));
    if (avail.length < 5) avail = WORDS.map((_,i) => i);
    const picked = shuffle(avail, rng).slice(0, 5);
    const w = picked.map(i => WORDS[i]);
    setWords(w);
    const r = generateRounds(w, rng);
    setRounds(r);
    return { picked, w, r };
  }, []);

  const triggerParticles = (type) => {
    setParticles({ active: false, type });
    requestAnimationFrame(() => setParticles({ active: true, type }));
    setTimeout(() => setParticles({ active: false, type }), 1200);
  };

  const triggerShake = () => { setShake(true); setTimeout(() => setShake(false), 400); };

  const showComboPopup = (c) => { setComboPopup(c); setTimeout(() => setComboPopup(null), 1000); };
  const showXpPopup = (xp) => { setXpPopup(xp); setTimeout(() => setXpPopup(null), 1000); };

  const handleStart = () => {
    const today = getDayKey();
    setupWords(st, today);
    setLearnIdx(0); setRIdx(0); setScore(0); setXpGained(0); setCombo(0); setMaxCombo(0);
    setSpeedMode(false); setSpeedPhase("off"); setSpeedScore(0); setSpeedTotal(0);
    setQuizScore(0); setQuizTotal(0);
    setIsBonusRound(false);
    playFx("learn_start");
    setPhase("learn");
  };

  const handlePlayMore = () => {
    const newRoundNum = bonusRoundNum + 1;
    setBonusRoundNum(newRoundNum);
    const seed = getDayKey() + "-bonus-" + newRoundNum;
    const rng = seededRng(seed);
    // Pick words not yet seen in this session if possible
    const seenSet = new Set(st.seenIdx || []);
    let avail = WORDS.map((_,i) => i).filter(i => !seenSet.has(i));
    if (avail.length < 5) avail = WORDS.map((_,i) => i); // cycle through all
    const picked = shuffle(avail, rng).slice(0, 5);
    const w = picked.map(i => WORDS[i]);
    setWords(w);
    const r = generateRounds(w, rng);
    setRounds(r);
    setLearnIdx(0); setRIdx(0); setScore(0); setXpGained(0); setCombo(0); setMaxCombo(0);
    setSpeedMode(false); setSpeedPhase("off"); setSpeedScore(0); setSpeedTotal(0);
    setQuizScore(0); setQuizTotal(0);
    setIsBonusRound(true);
    playFx("learn_start");
    setPhase("learn");
  };

  const handleLearnNext = () => {
    if (learnIdx < words.length - 1) { playFx("learn_card"); setLearnIdx(learnIdx + 1); }
    else { playFx("quiz_start"); setPhase("quiz"); }
  };

  const handleAnswer = (choice) => {
    if (selected !== null) return;
    setSelected(choice);
    const correct = choice === rounds[rIdx].answer;
    let earnedXP = 0;

    if (correct) {
      const newCombo = combo + 1;
      setCombo(newCombo);
      setMaxCombo(m => Math.max(m, newCombo));
      setScore(s => s + 1);
      earnedXP = XP_PER_CORRECT + Math.min(newCombo - 1, 10) * XP_COMBO_BONUS;
      if (speedPhase === "active") { earnedXP += XP_SPEED_BONUS; setSpeedScore(s => s + 1); }
      setXpGained(x => x + earnedXP);
      playFx(newCombo >= 3 ? "combo" : "correct");
      triggerParticles(newCombo >= 5 ? "combo" : "correct");
      if (newCombo >= 3) showComboPopup(newCombo);
      showXpPopup(earnedXP);
    } else {
      setCombo(0);
      playFx("wrong");
      triggerShake();
    }
    if (speedPhase === "active") setSpeedTotal(t => t + 1);
    setShowExplain(true);
  };

  const handleNext = async () => {
    setSelected(null); setShowExplain(false);
    if (rIdx < rounds.length - 1) {
      setRIdx(rIdx + 1);
    } else if (speedPhase !== "done" && speedPhase !== "active") {
      // ← Save regular quiz stats NOW before startSpeedRound replaces rounds[]
      setQuizScore(score);
      setQuizTotal(rounds.length);
      setSpeedPhase("pre");
    } else {
      await finishGame();
    }
  };

  const startSpeedRound = () => {
    // Generate quick-fire rounds from today's words
    const rng = seededRng(getDayKey() + "-speed");
    const speedRounds = [];
    words.forEach(w => {
      if (w.roots.length > 0) {
        const r = w.roots[0];
        const wrongs = ROOT_MEANINGS_POOL.filter(m => m !== r.meaning);
        speedRounds.push({ type:"speed_root", wordObj:w, q:`"${r.part}" = ?`, sub:w.word,
          choices: shuffle([r.meaning, ...shuffle(wrongs, rng).slice(0,3)], rng), answer: r.meaning,
          explain:`${r.part} = "${r.meaning}"` });
      }
      const origins = [...new Set(WORDS.map(x=>x.origin))];
      speedRounds.push({ type:"speed_origin", wordObj:w, q:`${w.word}`, sub:"Which language?",
        choices: shuffle([w.origin, ...shuffle(origins.filter(o=>o!==w.origin), rng).slice(0,3)], rng), answer: w.origin,
        explain: w.etymology });
    });
    const sr = shuffle(speedRounds, rng).slice(0, 10);
    setRounds(sr); setRIdx(0); setSpeedPhase("active"); setSpeedTimer(30); setSpeedScore(0); setSpeedTotal(0);
    playFx("speed_go");

    // Timer — ticks only, timeup handled in effect
    if (timerRef.current) clearInterval(timerRef.current);
    timerRef.current = setInterval(() => {
      setSpeedTimer(t => {
        if (t <= 1) { clearInterval(timerRef.current); timerRef.current = null; return 0; }
        if (t <= 6) playFx("tick");
        return t - 1;
      });
    }, 1000);
  };

  // Handle speed timer hitting 0 — play timeup here so it's guaranteed clear of interval
  useEffect(() => {
    if (speedPhase === "active" && speedTimer === 0) {
      if (timerRef.current) { clearInterval(timerRef.current); timerRef.current = null; }
      playFx("timeup");
      setSpeedPhase("done");
    }
  }, [speedTimer, speedPhase]);

  useEffect(() => { return () => { if (timerRef.current) clearInterval(timerRef.current); }; }, []);

  // Close volume panel on outside click
  useEffect(() => {
    if (!showVolPanel) return;
    const close = () => setShowVolPanel(false);
    const id = setTimeout(() => document.addEventListener("click", close), 10);
    return () => { clearTimeout(id); document.removeEventListener("click", close); };
  }, [showVolPanel]);
  useEffect(() => {
    const onKey = (e) => {
      if (phase !== "quiz" || speedPhase === "pre" || speedPhase === "done") return;
      if (!rounds[rIdx]) return;
      if (selected !== null && (e.key === " " || e.key === "Enter")) {
        e.preventDefault(); handleNext(); return;
      }
      const idx = parseInt(e.key) - 1;
      if (idx >= 0 && idx < rounds[rIdx].choices.length && selected === null) {
        handleAnswer(rounds[rIdx].choices[idx]);
      }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [phase, speedPhase, rounds, rIdx, selected, handleNext]);

  const finishGame = async () => {
    // Always kill timer first — prevents ticks/timeup bleeding into results screen
    if (timerRef.current) { clearInterval(timerRef.current); timerRef.current = null; }
    // quizScore/quizTotal saved in handleNext before speed round replaced rounds[]
    // Fall back to live score/rounds if speed round never ran
    const qScore = quizTotal > 0 ? quizScore : score;
    const qTotal = quizTotal > 0 ? quizTotal : rounds.length;
    const pct = qScore / (qTotal || 1);
    let bonusXP = 0;
    if (pct === 1) bonusXP = XP_PERFECT_BONUS;
    const totalXP = xpGained + bonusXP;

    let newXP = (st.xp || 0) + totalXP;
    let newLevel = st.level || 1;
    let leveledUp = false;
    while (newXP >= xpForLevel(newLevel)) { newXP -= xpForLevel(newLevel); newLevel++; leveledUp = true; }
    if (leveledUp) { playFx("levelup"); triggerParticles("levelup"); }
    else { setTimeout(() => playFx("results"), 350); }

    const pickedIdx = words.map(w => WORDS.indexOf(w)).filter(i => i >= 0);
    const newSeen = [...new Set([...(st.seenIdx || []), ...pickedIdx])];

    if (isBonusRound) {
      setBonusScore(s => s + qScore);
      setBonusTotal(t => t + qTotal);
      const ns = { ...st, xp:newXP, level:newLevel, totalWords:(st.totalWords||0)+words.length,
        seenIdx:newSeen, soundOn:true,
        todayQuizScore:qScore, todayQuizTotal:qTotal,
        todaySpeedScore:speedScore, todaySpeedTotal:speedTotal, todayXP:totalXP };
      setSt(ns); await save(ns); setXpGained(totalXP); setPhase("results");
    } else {
      const newStreak = (st.streak || 0) + 1;
      const ns = { ...st, completedToday:true,
        todayQuizScore:qScore, todayQuizTotal:qTotal,
        todaySpeedScore:speedScore, todaySpeedTotal:speedTotal, todayXP:totalXP,
        streak:newStreak, bestStreak:Math.max(newStreak, st.bestStreak||0),
        totalWords:(st.totalWords||0)+words.length,
        xp:newXP, level:newLevel, lastDay:getDayKey(), seenIdx:newSeen, soundOn:true };
      setSt(ns); await save(ns); setXpGained(totalXP); setPhase("results");
    }
  };

  const toggleSound = async () => {
    if (!soundOn) {
      // Unmute: turn on and show panel
      setSoundOn(true);
      setShowVolPanel(true);
      if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
      startDroneEngine(musicVolume, musicTheme);
    } else {
      // Already on — toggle volume panel
      setShowVolPanel(v => !v);
    }
  };

  const handleMute = () => {
    // Mute is session-only — never saved to storage so music always starts fresh on reload
    setSoundOn(false);
    setShowVolPanel(false);
  };

  const handleVolumeChange = (v) => {
    setMusicVolume(v);
    setDroneVolume(v);
  };

  const handleThemeChange = (idx) => {
    if (idx === musicTheme) return;
    setMusicTheme(idx);
    if (soundOn) {
      stopDroneEngine(true);
      startDroneEngine(musicVolume, idx);
    }
  };

  // Round type labels
  const roundLabel = (type) => {
    const map = { root_meaning:"🌱 Root Meaning", origin:"🗺️ Language Origin", relatives:"🌳 Word Family",
      etymology_match:"📜 True Etymology", reverse:"🔄 Reverse Match", speed_root:"⚡ Speed Root", speed_origin:"⚡ Speed Origin",
      funfact_match:"💡 Fun Fact Detective" };
    return map[type] || "📖 Etymology";
  };

  const getMsg = () => {
    const pct = (st?.todayQuizScore || 0) / (st?.todayQuizTotal || 1);
    if (pct >= 0.9) return "Etymologist extraordinaire!";
    if (pct >= 0.7) return "A fine philological mind.";
    if (pct >= 0.5) return "Solid roots taking hold.";
    return "Every master was once a beginner.";
  };

  /* ── Vocab Builder helpers ──────────────────────────────────────────── */
  const setupVbWords = () => {
    const rng = seededRng(getDayKey() + "-vb");
    const picked = shuffle([...VB_WORD_BANK], rng).slice(0, 5);
    setVbWords(picked);
    setVbLearnIdx(0);
    setVbScore(0);
    setVbXpGained(0);
    setVbShowAnchor(false);
    // Build quiz rounds: 2 rounds per word (def + blank/tone alternating)
    const rounds = [];
    picked.forEach((w, wi) => {
      // Round 1: definition match
      const dOpts = shuffle([...VB_WORD_BANK].filter(x => x.word !== w.word), rng).slice(0, 3).map(x => x.def);
      rounds.push({ type:"def", word:w, opts: shuffle([w.def, ...dOpts], rng), answer: w.def });
      // Round 2: fill-in-the-blank — which word fits the sentence?
      const blankOpts = shuffle([...picked].filter(x => x.word !== w.word), rng).slice(0, 3);
      rounds.push({ type:"blank", word:w, blankSentence: w.sentence.replace(new RegExp(w.word,"i"), "___________"), opts: shuffle([w.word, ...blankOpts.map(x=>x.word)], rng), answer: w.word });
    });
    setVbRounds(shuffle(rounds, rng));
    setVbRIdx(0);
    setVbSelected(null);
  };

  const handleVbAnswer = (choice) => {
    if (vbSelected !== null) return;
    setVbSelected(choice);
    const correct = choice === vbRounds[vbRIdx].answer;
    playFx(correct ? "correct" : "wrong");
    if (correct) setVbScore(s => s + 1);
  };

  const handleVbNext = () => {
    if (vbRIdx + 1 < vbRounds.length) {
      setVbRIdx(i => i + 1);
      setVbSelected(null);
    } else {
      const xp = Math.round((vbScore / vbRounds.length) * 60) + 20;
      setVbXpGained(xp);
      setVbPhase("results");
      playFx("level_up");
    }
  };

  if (phase === "loading") return (
    <div className="ey-app"><div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"60vh",flexDirection:"column"}}>
      <div className="ey-logo">Word<span style={{color:"var(--warmWhite)"}}>Spark</span></div><div className="ey-logo-sub">Etymology</div>
      <div style={{color:"var(--tx3)",marginTop:16,fontSize:".85rem",animation:"eyPulse 1.5s infinite"}}>Loading...</div>
    </div></div>
  );

  const level = st?.level || 1;
  const xp = st?.xp || 0;
  const xpNeeded = xpForLevel(level);
  const xpPct = Math.min(xp / xpNeeded * 100, 100);

  return (
    <div className={`ey-app ${shake ? "ey-shake" : ""}`} ref={appRef}>
      <Particles active={particles.active} type={particles.type} />

      {/* Floating popups */}
      {comboPopup && <div className="ey-combo-popup" key={comboPopup}>🔥 {comboPopup}x COMBO!</div>}
      {xpPopup && <div className="ey-xp-popup" key={`xp-${Date.now()}`}>+{xpPopup} XP</div>}

      {/* HEADER */}
      <div className="ey-header">
        <div className="ey-header-top">
          <div>
            <div className="ey-logo">Word<span style={{color:"var(--warmWhite)"}}>Spark</span></div>
            <div className="ey-logo-sub">{gameMode === "kids" ? "Kids Edition" : gameMode === "lexicon" ? "Vocab Builder" : "Etymology"}</div>
          </div>
          <div style={{display:"flex",gap:8,alignItems:"center"}}>
            <button className="ey-sound-btn ey-home-btn" title="Home — change mode"
              onClick={() => { setShowVolPanel(false); setGameMode(null); }}>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style={{display:"block"}}>
                <path d="M8 1.5L1 7.5H3V14H7V10H9V14H13V7.5H15L8 1.5Z"/>
              </svg>
            </button>
            <button className={"ey-sound-btn ey-profile-btn" + (phase === "profile" ? " active" : "")} title="Your Profile"
              onClick={() => { setShowVolPanel(false); if (phase !== "profile") { setPrevPhase(phase); setPhase("profile"); } else setPhase(prevPhase); }}>
              {phase === "profile" ? "✕" :
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style={{display:"block"}}>
                  <circle cx="8" cy="5" r="3.2"/>
                  <path d="M1.5,15 C1.5,10.8 4.5,8.2 8,8.2 C11.5,8.2 14.5,10.8 14.5,15 Z"/>
                </svg>
              }
            </button>
            {/* Volume + Theme panel */}
            <div style={{position:"relative"}}>
              <button className={`ey-sound-btn ${showVolPanel ? "active" : ""}`}
                onClick={toggleSound}>
                {soundOn ? (musicVolume > 0.5 ? "🔊" : musicVolume > 0.15 ? "🔉" : "🔈") : "🔇"}
              </button>
              {showVolPanel && soundOn && (
                <div className="ey-vol-panel" onClick={e => e.stopPropagation()}>
                  <div className="ey-vol-label">Volume</div>
                  <div className="ey-vol-slider-wrap">
                    <span className="ey-vol-icon">🔈</span>
                    <input type="range" min="0" max="1" step="0.01"
                      value={musicVolume}
                      onChange={e => handleVolumeChange(parseFloat(e.target.value))}
                      className="ey-vol-slider"
                      style={{background:`linear-gradient(90deg,var(--gold) ${Math.round(musicVolume*100)}%,var(--sf3) ${Math.round(musicVolume*100)}%)`}} />
                    <span className="ey-vol-icon">🔊</span>
                  </div>
                  <div className="ey-vol-label" style={{marginTop:10}}>Theme</div>
                  <div className="ey-theme-grid">
                    {THEMES.map((th, i) => (
                      <button key={i}
                        className={"ey-theme-tile" + (i === musicTheme ? " active" : "")}
                        onClick={() => handleThemeChange(i)}>
                        <span className="ey-theme-sym">{th.sym}</span>
                        <span className="ey-theme-name">{th.name}</span>
                        <span className="ey-theme-sub">{th.sub}</span>
                      </button>
                    ))}
                  </div>
                  <button className="ey-vol-mute-btn" style={{marginTop:10}} onClick={handleMute}>Mute</button>
                </div>
              )}
            </div>
          </div>
        </div>
        <div className="ey-xp-bar-wrap">
          <div className="ey-xp-bar-bg">
            <div className="ey-xp-bar-fill" style={{ width: `${xpPct}%` }} />
          </div>
          <div className="ey-xp-info">
            <span className="ey-level-badge">Lv.{level}</span>
            <span className="ey-xp-text">{xp}/{xpNeeded} XP</span>
            <span className="ey-title">{getTitle(level)}</span>
          </div>
        </div>
      </div>

      {/* ─── SPLASH / MODE SELECTION ─────────────────────────────────── */}
      {gameMode === null && (
        <div className="ey-splash">
          <div className="ey-splash-emblem">
            <SplashEmblem size={220} animated={true} />
          </div>
          <div className="ey-splash-title">Word<span style={{color:"var(--warmWhite)"}}>Spark</span></div>
          <div className="ey-splash-tagline">Choose your learning adventure</div>
          <div className="ey-mode-grid">
            {/* Etymology Mode */}
            <button className="ey-mode-card mode-etymology" onClick={() => setGameMode("etymology")}>
              <div className="ey-mode-icon">📜</div>
              <div className="ey-mode-name">Etymology</div>
              <div className="ey-mode-desc">Uncover the hidden history buried inside everyday words — roots, origins, and the stories that shaped language</div>
              <div className="ey-mode-tags">
                <span>Word Origins</span><span>Root Analysis</span><span>Fun Facts</span>
              </div>
              <div className="ey-mode-cta">Explore →</div>
            </button>
            {/* Vocab Builder Mode */}
            <button className="ey-mode-card mode-lexicon" onClick={() => setGameMode("lexicon")}>
              <div className="ey-mode-icon">🔭</div>
              <div className="ey-mode-name">Vocab Builder</div>
              <div className="ey-mode-desc">Expand your vocabulary with vivid definitions, usage in context, and memory techniques for unfamiliar words</div>
              <div className="ey-mode-tags">
                <span>New Words</span><span>Usage</span><span>Memory</span>
              </div>
              <div className="ey-mode-cta">Discover →</div>
            </button>
            {/* Kids Mode */}
            <button className="ey-mode-card mode-kids" onClick={() => setGameMode("kids")}>
              <div className="ey-mode-icon">🌟</div>
              <div className="ey-mode-name">Kids Corner</div>
              <div className="ey-mode-desc">Fun word adventures for young learners — playful quizzes, emoji clues, and stories that make words come alive</div>
              <div className="ey-mode-tags">
                <span>Ages 6–12</span><span>Playful</span><span>Stories</span>
              </div>
              <div className="ey-mode-cta">Play →</div>
            </button>
          </div>
        </div>
      )}

      {/* ─── LEXICON / VOCAB BUILDER MODE ──────────────────────────────── */}
      {/* ═══════════════════════════════════════════════════════════════
          VOCAB BUILDER MODE
          ═══════════════════════════════════════════════════════════════ */}
      {gameMode === "lexicon" && (<>

      {/* ── VB WELCOME ───────────────────────────────────────────────── */}
      {vbPhase === "welcome" && (
        <div className="vb-welcome">
          <div className="vb-welcome-emblem">🔭</div>
          <h2 className="vb-title">Vocab Builder</h2>
          <p className="vb-subtitle">Five vivid, expressive words you wish you'd known earlier — each with a sentence, a mnemonic, and quizzes that test real usage.</p>
          <div className="vb-feature-row">
            <div className="vb-feat"><span className="vb-feat-icon">💬</span><span>Real sentences</span></div>
            <div className="vb-feat"><span className="vb-feat-icon">🧠</span><span>Memory anchors</span></div>
            <div className="vb-feat"><span className="vb-feat-icon">🎯</span><span>Usage quizzes</span></div>
          </div>
          <button className="vb-start-btn" onClick={() => { setupVbWords(); setVbPhase("learn"); }}>
            Begin Today's Words →
          </button>
        </div>
      )}

      {/* ── VB LEARN ─────────────────────────────────────────────────── */}
      {vbPhase === "learn" && vbWords[vbLearnIdx] && (() => {
        const w = vbWords[vbLearnIdx];
        return (
          <div className="vb-learn-card" key={w.word}>
            <div className="vb-learn-progress">
              <span className="vb-phase-label">Word {vbLearnIdx + 1} of {vbWords.length}</span>
              <div className="vb-progress-dots">
                {vbWords.map((_,i) => <div key={i} className={"vb-dot" + (i < vbLearnIdx ? " done" : i === vbLearnIdx ? " active" : "")}/>)}
              </div>
            </div>

            <div className="vb-word-row">
              <div className="vb-word">{w.word}</div>
              <div className="vb-tone-badge">{w.tone}</div>
            </div>
            <div className="vb-ipa">{w.ipa} <span className="vb-pos">{w.pos}</span></div>
            <div className="vb-def">{w.def}</div>

            <div className="vb-sentence-block">
              <div className="vb-sentence-label">IN USE</div>
              <blockquote className="vb-sentence">"{w.sentence}"</blockquote>
            </div>

            <button className="vb-anchor-toggle" onClick={() => setVbShowAnchor(a => !a)}>
              {vbShowAnchor ? "Hide" : "🧠 Show"} Memory Anchor
            </button>
            {vbShowAnchor && (
              <div className="vb-anchor-block">
                <div className="vb-anchor-label">MEMORY ANCHOR</div>
                <p className="vb-anchor-text">{w.mnemonic}</p>
              </div>
            )}

            <div className="vb-synonyms">
              {w.synonyms.map(s => <span key={s} className="vb-syn">{s}</span>)}
            </div>

            <div className="vb-learn-nav">
              {vbLearnIdx > 0 && (
                <button className="vb-nav-btn secondary" onClick={() => { setVbLearnIdx(i => i - 1); setVbShowAnchor(false); }}>← Back</button>
              )}
              {vbLearnIdx < vbWords.length - 1 ? (
                <button className="vb-nav-btn" onClick={() => { setVbLearnIdx(i => i + 1); setVbShowAnchor(false); }}>Next Word →</button>
              ) : (
                <button className="vb-nav-btn primary-glow" onClick={() => { setVbPhase("quiz"); setVbSelected(null); }}>Start Quiz →</button>
              )}
            </div>
          </div>
        );
      })()}

      {/* ── VB QUIZ ───────────────────────────────────────────────────── */}
      {vbPhase === "quiz" && vbRounds[vbRIdx] && (() => {
        const round = vbRounds[vbRIdx];
        const isCorrect = vbSelected !== null && vbSelected === round.answer;
        const isWrong = vbSelected !== null && vbSelected !== round.answer;
        return (
          <div className="vb-quiz-wrap">
            <div className="vb-quiz-progress-bar">
              <div className="vb-quiz-progress-fill" style={{width:`${((vbRIdx)/vbRounds.length)*100}%`}}/>
            </div>
            <div className="vb-quiz-header">
              <span className="vb-phase-label">{round.type === "def" ? "💬 Define it" : "✏️ Fill the Blank"}</span>
              <span className="vb-quiz-counter">{vbRIdx + 1} / {vbRounds.length}</span>
            </div>

            {round.type === "def" ? (
              <>
                <div className="vb-quiz-word">{round.word.word}</div>
                <p className="vb-quiz-prompt">Which definition best fits this word?</p>
              </>
            ) : (
              <>
                <p className="vb-quiz-prompt">Which word completes this sentence?</p>
                <blockquote className="vb-quiz-blank-sentence">"{round.blankSentence}"</blockquote>
              </>
            )}

            <div className="vb-quiz-options">
              {round.opts.map(opt => {
                let cls = "vb-opt";
                if (vbSelected !== null) {
                  if (opt === round.answer) cls += " vb-opt-correct";
                  else if (opt === vbSelected) cls += " vb-opt-wrong";
                }
                return (
                  <button key={opt} className={cls} onClick={() => handleVbAnswer(opt)} disabled={vbSelected !== null}>
                    {opt}
                    {vbSelected !== null && opt === round.answer && <span className="vb-opt-tick">✓</span>}
                    {vbSelected !== null && opt === vbSelected && opt !== round.answer && <span className="vb-opt-cross">✗</span>}
                  </button>
                );
              })}
            </div>

            {vbSelected !== null && (
              <div className={"vb-quiz-feedback" + (isCorrect ? " correct" : " wrong")}>
                {isCorrect
                  ? <><strong>Correct!</strong> {round.word.mnemonic.split(".")[0]}.</>
                  : <><strong>Not quite.</strong> The answer is: <em>{round.answer}</em></>
                }
              </div>
            )}

            {vbSelected !== null && (
              <button className="vb-next-btn" onClick={handleVbNext}>
                {vbRIdx + 1 < vbRounds.length ? "Next Question →" : "See Results →"}
              </button>
            )}
          </div>
        );
      })()}

      {/* ── VB RESULTS ────────────────────────────────────────────────── */}
      {vbPhase === "results" && (() => {
        const pct = vbScore / vbRounds.length;
        const msg = pct >= 0.9 ? "Vocabulary mastered." : pct >= 0.7 ? "Strong lexical instincts." : pct >= 0.5 ? "Good foundation — keep building." : "Every word starts as a stranger.";
        return (
          <div className="vb-results">
            <div className="vb-results-emblem">🔭</div>
            <h2 className="vb-results-title">Session Complete</h2>
            <p className="vb-results-msg">{msg}</p>
            <div className="vb-results-score">
              <div className="vb-score-num">{vbScore}<span className="vb-score-den">/{vbRounds.length}</span></div>
              <div className="vb-score-label">Questions Correct</div>
            </div>
            <div className="vb-results-xp">+{vbXpGained} XP earned</div>
            <div className="vb-results-words">
              <div className="vb-results-words-label">Today's Words</div>
              {vbWords.map(w => (
                <div key={w.word} className="vb-results-word-row">
                  <span className="vb-results-word-name">{w.word}</span>
                  <span className="vb-results-word-def">{w.def}</span>
                  <span className="vb-tone-badge small">{w.tone}</span>
                </div>
              ))}
            </div>
            <div className="vb-results-nav">
              <button className="vb-start-btn" onClick={() => { setupVbWords(); setVbPhase("learn"); }}>Play Again</button>
              <button className="vb-nav-btn secondary" onClick={() => setGameMode(null)}>Home</button>
            </div>
          </div>
        );
      })()}

      </>)} {/* end gameMode === "lexicon" */}

      {/* ─── KIDS MODE ─────────────────────────────────────────────────── */}

      {gameMode === "kids" && (
        <div className="ey-mode-screen kids-screen">
          <div className="ey-kids-banner">🌈 ✨ 🦄 ⭐ 🌈</div>
          <h2 className="ey-mode-screen-title" style={{color:"var(--kids-bright)"}}>Kids Corner!</h2>
          <p className="ey-mode-screen-body" style={{fontSize:"1rem"}}>
            A world of words is waiting! Discover amazing facts about everyday words, play fun quizzes, and become a word wizard!
          </p>
          <div className="ey-mode-screen-features">
            <div className="ey-feature-card kids-card">
              <div className="ey-feature-icon">🎮</div>
              <div className="ey-feature-name">Fun Quizzes</div>
              <div className="ey-feature-desc">Answer with emoji clues and picture hints!</div>
            </div>
            <div className="ey-feature-card kids-card">
              <div className="ey-feature-icon">⭐</div>
              <div className="ey-feature-name">Star Rewards</div>
              <div className="ey-feature-desc">Collect stars and unlock fun badges</div>
            </div>
            <div className="ey-feature-card kids-card">
              <div className="ey-feature-icon">📖</div>
              <div className="ey-feature-name">Word Stories</div>
              <div className="ey-feature-desc">Every word has a cool story — find out where they came from!</div>
            </div>
          </div>
          <div className="ey-mode-coming kids-coming">
            <div className="ey-coming-badge" style={{background:"var(--kids-badge)"}}>Coming Soon! 🎉</div>
            <p>We're building something amazing for young word explorers. Check back soon!</p>
            <button className="ey-mode-switch-btn kids-btn" onClick={() => setGameMode("etymology")}>Try Etymology Mode →</button>
          </div>
        </div>
      )}

      {/* ─── ETYMOLOGY MODE (existing game) ──────────────────────────── */}
      {gameMode === "etymology" && (<>

      {/* WELCOME */}
      {phase === "welcome" && (
        <div className="ey-welcome">
          <div className="ey-hero">Uncover the <em>hidden stories</em> buried inside everyday words</div>
          <div className="ey-feat-grid">
            <div className="ey-feat-card"><div className="ey-feat-icon">🏛️</div><div className="ey-feat-title">5 Words Daily</div><div className="ey-feat-desc">Deep etymological breakdowns with roots, timelines, and family trees</div></div>
            <div className="ey-feat-card"><div className="ey-feat-icon">🧠</div><div className="ey-feat-title">6 Quiz Types</div><div className="ey-feat-desc">Root meanings, origins, word families, etymologies, reverse matching, and Fun Fact Detective</div></div>
            <div className="ey-feat-card"><div className="ey-feat-icon">⚡</div><div className="ey-feat-title">Speed Round</div><div className="ey-feat-desc">30-second lightning round for bonus XP after the main quiz</div></div>
            <div className="ey-feat-card"><div className="ey-feat-icon">♾️</div><div className="ey-feat-title">Play More</div><div className="ey-feat-desc">Finished today's set? Keep going with fresh words — no daily cap</div></div>
          </div>
          <button className="ey-start-btn" onClick={handleStart}>
            <span className="ey-start-icon">📜</span> Begin Today's Etymology
          </button>
        </div>
      )}

      {/* LEARN PHASE */}
      {phase === "learn" && words[learnIdx] && (() => {
        const w = words[learnIdx];
        return (
          <div className="ey-learn" key={`learn-${learnIdx}`}>
            <div className="ey-prog-bar">{words.map((_,i) => <div key={i} className={`ey-prog-dot ${i===learnIdx?"active":i<learnIdx?"done":""}`} />)}</div>
            <div className="ey-phase-label"><span>Learn</span> Word {learnIdx+1} of {words.length}{isBonusRound ? <span style={{marginLeft:8,color:"var(--amber)"}}>♾️ Bonus</span> : null}</div>

            <div className="ey-word-card">
              <div className="ey-word-top">
                <div className="ey-word-main">{w.word}</div>
                <button className="ey-speak-btn" onClick={()=>speak(w.word)}>🔊</button>
              </div>
              <div className="ey-word-meta">{w.pos} · {w.ipa} · {langIcon(w.origin)} {w.origin} · {w.year}</div>
              <div className="ey-word-def">{w.def}</div>

              <div className="ey-ety-section">
                <div className="ey-ety-label">Etymology</div>
                <div className="ey-ety-story">{w.etymology}</div>
              </div>

              <div className="ey-ety-section">
                <div className="ey-ety-label">Root Breakdown</div>
                <div className="ey-roots-grid">
                  {w.roots.map((r,i) => (
                    <div key={i} className="ey-root-chip">
                      <div className="ey-root-part">{r.part}</div>
                      <div className="ey-root-meaning">"{r.meaning}"</div>
                      <div className="ey-root-lang">{langIcon(r.lang)} {r.lang}</div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="ey-ety-section">
                <div className="ey-ety-label">Word Evolution</div>
                <div className="ey-evo">{w.evolution.map((s,i) => <div key={i} className={`ey-evo-step ${i===w.evolution.length-1?"final":""}`}>{s}</div>)}</div>
              </div>

              <div className="ey-ety-section">
                <div className="ey-ety-label">Word Relatives</div>
                <div className="ey-rel-list">{w.relatives.map((r,i) => <span key={i} className="ey-rel-tag">{r}</span>)}</div>
              </div>

              <div className="ey-funfact">
                <div className="ey-ff-title">💡 Did You Know?</div>
                <div className="ey-ff-text">{w.funFact}</div>
              </div>
            </div>

            <button className="ey-continue-btn" onClick={handleLearnNext}>
              {learnIdx < words.length - 1 ? "Next Word →" : "Start the Quiz →"}
            </button>
          </div>
        );
      })()}

      {/* QUIZ PHASE */}
      {phase === "quiz" && speedPhase === "pre" && (
        <div className="ey-speed-intro" key="speed-intro">
          <div className="ey-speed-icon">⚡</div>
          <div className="ey-speed-title">SPEED ROUND</div>
          <div className="ey-speed-desc">30 seconds. 10 rapid-fire questions. Bonus XP for every correct answer.</div>
          <div className="ey-speed-stakes">
            <div className="ey-speed-stake">+{XP_SPEED_BONUS} XP per correct</div>
            <div className="ey-speed-stake">Combos still active 🔥</div>
          </div>
          <button className="ey-start-btn" onClick={startSpeedRound}>
            <span className="ey-start-icon">⚡</span> GO!
          </button>
        </div>
      )}

      {phase === "quiz" && speedPhase === "done" && (
        <div className="ey-speed-done" key="speed-done">
          <div className="ey-speed-icon">⚡</div>
          <div className="ey-speed-title">TIME'S UP!</div>
          <div className="ey-speed-result">{speedScore} / {speedTotal} in speed round</div>
          <button className="ey-start-btn" onClick={finishGame}>
            <span className="ey-start-icon">📊</span> See Final Results
          </button>
        </div>
      )}

      {phase === "quiz" && (speedPhase === "off" || speedPhase === "active") && rounds[rIdx] && (() => {
        const round = rounds[rIdx];
        const isSpeed = speedPhase === "active";
        return (
          <div className="ey-quiz" key={`quiz-${rIdx}-${speedPhase}`}>
            {/* Timer bar for speed round */}
            {isSpeed && (
              <div className="ey-timer-wrap">
                <div className="ey-timer-bar" style={{ width: `${(speedTimer/30)*100}%`, background: speedTimer <= 5 ? "var(--err)" : "var(--gold)" }} />
                <div className={`ey-timer-text ${speedTimer <= 5 ? "ey-timer-danger" : ""}`}>{speedTimer}s</div>
              </div>
            )}

            {!isSpeed && <div className="ey-prog-bar">{rounds.map((_,i) => <div key={i} className={`ey-prog-dot ${i===rIdx?"active":i<rIdx?"done":""}`} />)}</div>}

            <div className="ey-quiz-header">
              <div className="ey-quiz-counter">{isSpeed ? "⚡ Speed" : "Quiz"} <span>{rIdx+1}</span> / <span>{rounds.length}</span></div>
              {combo >= 2 && <div className="ey-combo-badge">🔥 {combo}x</div>}
            </div>

            <div className="ey-quiz-type">{roundLabel(round.type)}</div>
            <div className={`ey-quiz-q${round.type==="funfact_match"?" funfact":""}`}>{round.q}</div>
            <div className="ey-quiz-sub">{round.sub}</div>

            <div className="ey-choices">
              {round.choices.map((c, i) => {
                let cls = "ey-choice";
                if (selected !== null) {
                  if (c === round.answer) cls += " correct";
                  else if (c === selected) cls += " wrong";
                }
                return (
                  <button key={i} className={cls} onClick={() => handleAnswer(c)} disabled={selected !== null}>
                    {!isSpeed && selected === null && <span className="ey-choice-key">{i+1}</span>}
                    {c}
                  </button>
                );
              })}
            </div>

            {showExplain && !isSpeed && (
              <div className="ey-explanation">
                <div className="ey-explain-text">{round.explain}</div>
              </div>
            )}

            {showExplain && (
              <button className="ey-next-btn" onClick={handleNext}>
                {isSpeed ? "Next →" : rIdx < rounds.length - 1 ? "Next Question →" : "Speed Round ⚡"}
              </button>
            )}
          </div>
        );
      })()}

      {/* RESULTS */}
      {phase === "results" && (() => {
        // Pull from saved state (accurate) or live state for freshly-finished game
        const dQScore  = st?.todayQuizScore  ?? (quizTotal > 0 ? quizScore : score);
        const dQTotal  = st?.todayQuizTotal  ?? (quizTotal > 0 ? quizTotal : rounds.length);
        const dSScore  = st?.todaySpeedScore ?? speedScore;
        const dSTotal  = st?.todaySpeedTotal ?? speedTotal;
        const dXP      = st?.todayXP ?? xpGained;
        const quizPct  = dQTotal > 0 ? Math.round(dQScore / dQTotal * 100) : 0;
        const speedPct = dSTotal > 0 ? Math.round(dSScore / dSTotal * 100) : null;
        return (
          <div className="ey-results">
            {/* Hero accuracy */}
            <div className="ey-res-score">{quizPct}%</div>
            <div className="ey-res-label">quiz accuracy · {dQScore} of {dQTotal} correct</div>
            <div className="ey-res-msg">{getMsg()}</div>

            {/* Stat row */}
            <div className="ey-res-stat-grid">
              <div className="ey-res-stat-card">
                <div className="ey-res-stat-val">+{dXP}</div>
                <div className="ey-res-stat-lbl">XP earned</div>
              </div>
              {speedPct !== null && (
                <div className="ey-res-stat-card">
                  <div className="ey-res-stat-val">{speedPct}%</div>
                  <div className="ey-res-stat-lbl">speed round · {dSScore}/{dSTotal}</div>
                </div>
              )}
              {maxCombo >= 3 && (
                <div className="ey-res-stat-card">
                  <div className="ey-res-stat-val">×{maxCombo}</div>
                  <div className="ey-res-stat-lbl">best combo</div>
                </div>
              )}
              <div className="ey-res-stat-card">
                <div className="ey-res-stat-val">{st?.totalWords || 0}</div>
                <div className="ey-res-stat-lbl">total words</div>
              </div>
            </div>

            {/* Perfect score badge */}
            {dQTotal > 0 && dQScore === dQTotal && (
              <div className="ey-perfect-badge">⭐ Perfect Round — +{XP_PERFECT_BONUS} bonus XP</div>
            )}

            {/* Streak badge */}
            {(st?.streak || 0) > 0 && (
              <div className="ey-res-streak">🔥 {st.streak}-day streak{st.streak >= 3 ? " — on fire!" : ""}</div>
            )}

            {/* XP / Level card */}
            <div className="ey-xp-level-card">
              <div className="ey-xlc-top">
                <span className="ey-xlc-level">Level {level}</span>
                <span className="ey-xlc-title">{getTitle(level)}</span>
              </div>
              <div className="ey-xp-bar-bg large">
                <div className="ey-xp-bar-fill" style={{ width: `${xpPct}%` }} />
              </div>
              <div className="ey-xlc-xp">{xp} / {xpNeeded} XP · {xpNeeded - xp} to level {level + 1}</div>
            </div>

            <div className="ey-review-section">
              <div className="ey-review-title">Today's Etymologies</div>
              {words.map((w, i) => (
                <div key={i} className="ey-review-card">
                  <div className="ey-review-top">
                    <div className="ey-review-word">
                      <span>{w.word}</span>
                      <button className="ey-speak-btn sm" onClick={()=>speak(w.word)}>🔊</button>
                    </div>
                    <div className="ey-review-origin">{langIcon(w.origin)} {w.origin} · {w.year}</div>
                  </div>
                  <div className="ey-review-ety">{w.etymology}</div>
                  <div className="ey-review-roots">{w.roots.map((r,j) => <span key={j} className="ey-review-root"><b>{r.part}</b> = "{r.meaning}"</span>)}</div>
                </div>
              ))}
            </div>

            <div className="ey-done-card">
              <div className="ey-done-text">{isBonusRound ? "Keep the streak going — more words await!" : "Come back tomorrow for 5 new etymologies"}</div>
              <div className="ey-done-sub" style={{marginBottom:16}}>{isBonusRound ? `Bonus round complete · ${bonusRoundNum} extra set${bonusRoundNum>1?"s":""} played` : "New words unlock at midnight · Or play more right now!"}</div>
              <div style={{display:"flex",gap:10,marginBottom:12}}>
                <button className="ey-start-btn" style={{flex:1}} onClick={handlePlayMore}>
                  <span className="ey-start-icon">♾️</span> Play More
                </button>
                <button className="ey-share-btn"
                  onClick={() => {
                    const dQScore = st?.todayQuizScore ?? score;
                    const dQTotal = st?.todayQuizTotal ?? rounds.length;
                    const pct = Math.round(dQScore/dQTotal*100);
                    const txt = `WordSpark Etymology — ${pct}% quiz accuracy · Level ${level} ${getTitle(level)} · ${st?.streak||0}-day streak 🔥`;
                    navigator.clipboard?.writeText(txt).then(() => setScoreShared(true));
                    setTimeout(() => setScoreShared(false), 2500);
                  }}>
                  {scoreShared ? "✓ Copied!" : "Share"}
                </button>
              </div>
            </div>
          </div>
        );
      })()}
      {/* PROFILE SCREEN */}
      {phase === "profile" && (() => {
        const learnedWords = (st?.seenIdx || []).map(i => WORDS[i]).filter(Boolean);
        const sortedWords = [...learnedWords].sort((a,b) => {
          if (profileSortBy === "alpha") return a.word.localeCompare(b.word);
          if (profileSortBy === "origin") return a.origin.localeCompare(b.origin) || a.word.localeCompare(b.word);
          if (profileSortBy === "pos") return a.pos.localeCompare(b.pos) || a.word.localeCompare(b.word);
          return 0; // recent = seenIdx order (already reversed)
        });
        const filtered = profileWordFilter
          ? sortedWords.filter(w =>
              w.word.toLowerCase().includes(profileWordFilter.toLowerCase()) ||
              w.def.toLowerCase().includes(profileWordFilter.toLowerCase()) ||
              w.origin.toLowerCase().includes(profileWordFilter.toLowerCase()) ||
              w.etymology.toLowerCase().includes(profileWordFilter.toLowerCase()))
          : sortedWords;

        // Derive meaningful stats
        const lastAccuracy = st?.todayQuizScore != null && st?.todayQuizTotal
          ? Math.round(st.todayQuizScore / st.todayQuizTotal * 100)
          : null;
        const totalXPEarned = (st?.level > 1)
          ? Array.from({length:(st?.level||1)-1},(_,i)=>xpForLevel(i+1)).reduce((a,b)=>a+b,0) + (st?.xp||0)
          : (st?.xp||0);

        return (
          <div className="ey-profile" key="profile">
            {/* Level Glyph */}
            <div className="ey-profile-glyph-wrap">
              <LevelGlyph level={level} xpPct={xpPct} size={200} />
            </div>

            <div className="ey-profile-title-row">
              <div className="ey-profile-name">{getTitle(level)}</div>
              <div className="ey-profile-level-badge">Level {level}</div>
            </div>

            {/* XP progress */}
            <div className="ey-profile-xp-section">
              <div className="ey-xp-bar-bg" style={{height:8,borderRadius:4,overflow:"hidden",marginBottom:6}}>
                <div className="ey-xp-bar-fill" style={{width:`${xpPct}%`}} />
              </div>
              <div style={{display:"flex",justifyContent:"space-between",fontSize:".7rem",color:"var(--tx3)"}}>
                <span>{xp} / {xpNeeded} XP</span>
                <span>{xpNeeded - xp} to Level {level+1}</span>
              </div>
            </div>

            {/* Stats grid — 6 stats that are all genuinely meaningful */}
            <div className="ey-profile-stat-grid">
              <div className="ey-profile-stat">
                <div className="ey-profile-stat-val">{st?.streak || 0}</div>
                <div className="ey-profile-stat-lbl">Day Streak</div>
              </div>
              <div className="ey-profile-stat">
                <div className="ey-profile-stat-val">{st?.bestStreak || 0}</div>
                <div className="ey-profile-stat-lbl">Best Streak</div>
              </div>
              <div className="ey-profile-stat">
                <div className="ey-profile-stat-val">{learnedWords.length}</div>
                <div className="ey-profile-stat-lbl">Words Studied</div>
              </div>
              <div className="ey-profile-stat">
                <div className="ey-profile-stat-val">{Math.floor((st?.totalWords||0)/5)}</div>
                <div className="ey-profile-stat-lbl">Sessions</div>
              </div>
              <div className="ey-profile-stat">
                <div className="ey-profile-stat-val">{learnedWords.length > 0 ? [...new Set(learnedWords.map(w=>w.origin))].length : 0}</div>
                <div className="ey-profile-stat-lbl">Origins Found</div>
              </div>
              <div className="ey-profile-stat">
                <div className="ey-profile-stat-val">{totalXPEarned.toLocaleString()}</div>
                <div className="ey-profile-stat-lbl">Total XP</div>
              </div>
            </div>

            {/* Origin breakdown */}
            {learnedWords.length > 0 && (() => {
              const originCounts = {};
              learnedWords.forEach(w => { originCounts[w.origin] = (originCounts[w.origin]||0) + 1; });
              const topOrigins = Object.entries(originCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
              return (
                <div className="ey-profile-origins">
                  {topOrigins.map(([orig, count]) => (
                    <div key={orig} className="ey-profile-origin-row">
                      <span className="ey-profile-origin-lang">{langIcon(orig)} {orig.split(" ")[0]}</span>
                      <div className="ey-profile-origin-bar-wrap">
                        <div className="ey-profile-origin-bar" style={{width:`${Math.round(count/learnedWords.length*100)}%`}} />
                      </div>
                      <span className="ey-profile-origin-count">{count}</span>
                    </div>
                  ))}
                </div>
              );
            })()}

            {/* Lexicon */}
            <div className="ey-profile-lexicon">
              <div className="ey-profile-lex-header">
                <span className="ey-review-title" style={{display:"block",marginBottom:0}}>
                  Lexicon · {learnedWords.length} word{learnedWords.length!==1?"s":""}
                </span>
                {learnedWords.length > 0 && (
                  <span style={{fontSize:".65rem",color:"var(--tx3)"}}>tap to expand</span>
                )}
              </div>
              {learnedWords.length > 1 && (
                <div className="ey-profile-sort-row">
                  {[["recent","Recent"],["alpha","A–Z"],["origin","Origin"],["pos","Type"]].map(([key,label]) => (
                    <button key={key} className={`ey-profile-sort-btn${profileSortBy===key?" active":""}`}
                      onClick={() => setProfileSortBy(key)}>{label}</button>
                  ))}
                </div>
              )}
              {learnedWords.length === 0 ? (
                <div className="ey-profile-empty">Complete your first session to build your lexicon.</div>
              ) : (
                <>
                  <input className="ey-profile-search"
                    placeholder="Search words, origins, definitions…"
                    value={profileWordFilter}
                    onChange={e => setProfileWordFilter(e.target.value)} />
                  <div className="ey-profile-lex-list">
                    {filtered.length === 0 && (
                      <div className="ey-profile-empty">No matches found.</div>
                    )}
                    {filtered.map((w, i) => {
                      const isOpen = expandedLexWord === w.word;
                      return (
                        <div key={i}
                          className={`ey-profile-lex-card ${isOpen ? "open" : ""}`}
                          onClick={() => setExpandedLexWord(isOpen ? null : w.word)}>
                          {/* Collapsed header — always visible */}
                          <div className="ey-profile-lex-top">
                            <div className="ey-profile-lex-word">
                              <span>{w.word}</span>
                              <button className="ey-speak-btn sm"
                                onClick={e=>{e.stopPropagation();speak(w.word);}}>🔊</button>
                            </div>
                            <div style={{display:"flex",alignItems:"center",gap:8}}>
                              <div className="ey-review-origin">{langIcon(w.origin)} {w.origin}</div>
                              <span className="ey-lex-chevron">{isOpen ? "▲" : "▼"}</span>
                            </div>
                          </div>
                          <div style={{fontSize:".78rem",color:"var(--tx2)",fontStyle:"italic",lineHeight:1.4,marginTop:2}}>
                            {w.def}
                          </div>

                          {/* Expanded full detail */}
                          {isOpen && (
                            <div className="ey-lex-expanded" onClick={e=>e.stopPropagation()}>
                              {/* Meta row */}
                              <div className="ey-lex-meta-row">
                                <span className="ey-lex-meta-chip">{w.pos}</span>
                                <span className="ey-lex-meta-chip">{w.ipa}</span>
                                <span className="ey-lex-meta-chip">{w.year}</span>
                              </div>

                              {/* Etymology */}
                              <div className="ey-lex-section-label">Etymology</div>
                              <div className="ey-ety-story" style={{fontSize:".9rem",marginBottom:12}}>{w.etymology}</div>

                              {/* Root breakdown */}
                              <div className="ey-lex-section-label">Root Breakdown</div>
                              <div className="ey-roots-grid" style={{marginBottom:12}}>
                                {w.roots.map((r,j) => (
                                  <div key={j} className="ey-root-chip">
                                    <div className="ey-root-part">{r.part}</div>
                                    <div className="ey-root-meaning">"{r.meaning}"</div>
                                    <div className="ey-root-lang">{langIcon(r.lang)} {r.lang}</div>
                                  </div>
                                ))}
                              </div>

                              {/* Evolution */}
                              <div className="ey-lex-section-label">Word Evolution</div>
                              <div className="ey-evo" style={{marginBottom:12}}>
                                {w.evolution.map((s,j) => (
                                  <div key={j} className={`ey-evo-step ${j===w.evolution.length-1?"final":""}`}>{s}</div>
                                ))}
                              </div>

                              {/* Relatives */}
                              {w.relatives.length > 0 && (
                                <>
                                  <div className="ey-lex-section-label">Word Relatives</div>
                                  <div className="ey-rel-list" style={{marginBottom:12}}>
                                    {w.relatives.map((r,j) => <span key={j} className="ey-rel-tag">{r}</span>)}
                                  </div>
                                </>
                              )}

                              {/* Fun Fact */}
                              <div className="ey-funfact">
                                <div className="ey-ff-title">💡 Did You Know?</div>
                                <div className="ey-ff-text">{w.funFact}</div>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </>
              )}
            </div>
          </div>
        );
      })()}

      </>)} {/* end gameMode === "etymology" */}
    </div>
  );
}

/* ═══════════════════════════════════════════════════════════════════════════
   STYLES
   ═══════════════════════════════════════════════════════════════════════════ */
const CSS = `
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Outfit:wght@300;400;500;600;700;800&display=swap');

:root {
  --bg:#0f0e0c;--bg2:#1a1814;--sf:#1e1b17;--sf2:#2a2520;--sf3:#332d27;
  --bd:rgba(196,164,106,.12);--bd2:rgba(196,164,106,.22);
  --gold:#c4a46a;--gold2:#d4b87a;--goldDim:rgba(196,164,106,.6);--amber:#e8a849;
  --warmWhite:#f0e6d3;--cream:#d4c5a9;
  --tx:#e8dcc8;--tx2:#9a8e7a;--tx3:#6b6052;
  --ok:#7eb87e;--err:#c75d5d;--errBg:rgba(199,93,93,.1);--okBg:rgba(126,184,126,.1);
  /* Lexicon/Vocab mode */
  --lex-accent:#4db8cc;--lex-dark:#0a1a20;--lex-sf:#0f2530;
  /* Kids mode */
  --kids-bright:#f5a623;--kids-badge:linear-gradient(135deg,#f5a623,#e05a2a);
}
@keyframes splashPulse{0%,100%{opacity:.7}50%{opacity:1}}
@keyframes splashSpin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes splashSpin2{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
*{margin:0;padding:0;box-sizing:border-box}
body,#root{background:var(--bg);min-height:100vh;font-family:'Outfit',sans-serif;color:var(--tx);-webkit-font-smoothing:antialiased}

.ey-app{max-width:540px;margin:0 auto;padding:16px 16px 40px;min-height:100vh;position:relative;overflow:visible}
.ey-app::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 0%,rgba(196,164,106,.06) 0%,transparent 60%),radial-gradient(ellipse at 80% 100%,rgba(196,164,106,.04) 0%,transparent 60%);pointer-events:none;z-index:0;animation:eyBreath 18s ease-in-out infinite}
@keyframes eyBreath{0%,100%{opacity:.7}50%{opacity:1}}

.ey-shake{animation:eyShake .4s ease}
@keyframes eyShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}

/* ─── HEADER ─── */
.ey-header{position:relative;margin-bottom:20px}
.ey-header-top{display:flex;justify-content:space-between;align-items:flex-start}
.ey-logo{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;color:var(--gold);line-height:1}
.ey-logo-sub{font-family:'Cormorant Garamond',serif;font-size:.75rem;font-style:italic;color:var(--tx2);letter-spacing:3px;text-transform:uppercase}
.ey-sound-btn{background:var(--sf);border:1px solid var(--bd);border-radius:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;color:var(--tx2);transition:border-color .2s,background .2s;flex-shrink:0;padding:0}
.ey-sound-btn.active{border-color:var(--bd2);background:var(--sf2)}
.ey-profile-btn{border-color:rgba(196,164,106,.35);color:var(--gold)}
.ey-profile-btn:hover{border-color:var(--gold);background:rgba(196,164,106,.12);box-shadow:0 0 12px rgba(196,164,106,.2)}
.ey-profile-btn.active{border-color:var(--gold);background:rgba(196,164,106,.15)}
.ey-home-btn{border-color:rgba(196,164,106,.20);color:var(--tx2)}
.ey-home-btn:hover{border-color:rgba(196,164,106,.45);color:var(--gold);background:rgba(196,164,106,.08)}

/* ─── VOLUME PANEL ─── */
.ey-vol-panel{position:fixed;top:56px;right:12px;background:var(--bg2);border:1px solid var(--bd2);border-radius:14px;padding:14px 16px;z-index:9999;min-width:250px;box-shadow:0 8px 40px rgba(0,0,0,.85);animation:eyIn .2s ease}
.ey-vol-label{font-size:.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--tx3);margin-bottom:8px;text-align:center}
.ey-vol-slider-wrap{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.ey-vol-icon{font-size:.75rem;flex-shrink:0}
.ey-vol-slider{flex:1;-webkit-appearance:none;appearance:none;height:4px;border-radius:2px;outline:none;cursor:pointer}
.ey-vol-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--gold);box-shadow:0 0 6px rgba(196,164,106,.4);cursor:pointer}
.ey-vol-slider::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--gold);border:none;cursor:pointer}
.ey-vol-mute-btn{width:100%;padding:7px;background:rgba(196,164,106,.08);border:1px solid var(--bd);border-radius:8px;color:var(--tx2);font-family:'Outfit',sans-serif;font-size:.75rem;cursor:pointer;transition:background .15s}
.ey-vol-mute-btn:hover{background:rgba(196,164,106,.18)}
.ey-theme-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-top:4px}
.ey-theme-tile{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 4px;background:rgba(196,164,106,.25);border:1px solid var(--bd);border-radius:10px;cursor:pointer;transition:background .15s,border-color .15s;text-align:center;font-family:inherit}
.ey-theme-tile:hover{background:rgba(196,164,106,.38);border-color:var(--bd2)}
.ey-theme-tile.active{background:rgba(196,164,106,.45);border-color:rgba(196,164,106,.70);box-shadow:0 0 8px rgba(196,164,106,.2)}
.ey-theme-sym{font-size:1rem;line-height:1;color:var(--amber)}
.ey-theme-name{font-family:'Cormorant Garamond',serif;font-size:.78rem;font-weight:600;color:var(--gold);line-height:1.1}
.ey-theme-sub{font-size:.52rem;color:var(--warmWhite);letter-spacing:.5px;line-height:1}

.ey-xp-bar-wrap{margin-top:12px}
.ey-xp-bar-bg{height:6px;background:var(--sf2);border-radius:3px;overflow:hidden;position:relative}
.ey-xp-bar-bg.large{height:10px;border-radius:5px}
.ey-xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--amber));border-radius:3px;transition:width .6s ease}
.ey-xp-info{display:flex;align-items:center;gap:8px;margin-top:4px;font-size:.7rem}
.ey-level-badge{background:linear-gradient(135deg,var(--gold),var(--amber));color:var(--bg);padding:2px 8px;border-radius:4px;font-weight:700;font-size:.65rem}
.ey-xp-text{color:var(--tx2)}
.ey-title{color:var(--goldDim);font-style:italic;margin-left:auto}

.ey-stats-row{display:flex;justify-content:center;gap:28px;margin-top:10px}
.ey-stat{text-align:center}
.ey-stat-val{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:700;color:var(--gold)}
.ey-stat-lbl{font-size:.6rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--tx3)}

/* ─── WELCOME ─── */
.ey-welcome{position:relative;z-index:1;animation:eyIn .6s ease}
.ey-hero{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:400;line-height:1.6;color:var(--cream);margin-bottom:24px;font-style:italic;text-align:center}
.ey-hero em{color:var(--gold);font-style:normal;font-weight:600}

.ey-feat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px}
.ey-feat-card{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:16px 14px;text-align:center}
.ey-feat-icon{font-size:1.6rem;margin-bottom:6px}
.ey-feat-title{font-size:.8rem;font-weight:700;color:var(--tx);margin-bottom:4px}
.ey-feat-desc{font-size:.7rem;color:var(--tx2);line-height:1.4}

.ey-start-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--gold),var(--amber));border:none;border-radius:14px;color:var(--bg);font-family:'Outfit',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px}
.ey-start-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(196,164,106,.3)}
.ey-start-icon{font-size:1.2rem}

/* ─── LEARN ─── */
.ey-learn{position:relative;z-index:1;animation:eyIn .5s ease}
.ey-prog-bar{display:flex;gap:3px;margin-bottom:16px}
.ey-prog-dot{flex:1;height:3px;border-radius:2px;background:var(--sf2);transition:background .3s}
.ey-prog-dot.active{background:var(--gold)}
.ey-prog-dot.done{background:var(--ok)}

.ey-phase-label{font-size:.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--tx3);margin-bottom:12px}
.ey-phase-label span{color:var(--gold);font-weight:700}

.ey-word-card{background:var(--sf);border:1px solid var(--bd);border-radius:16px;padding:24px 20px;margin-bottom:12px}
.ey-word-top{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:4px}
.ey-word-main{font-family:'Cormorant Garamond',serif;font-size:2.1rem;font-weight:700;color:var(--gold);line-height:1.1}
.ey-speak-btn{background:rgba(196,164,106,.1);border:1px solid rgba(196,164,106,.2);border-radius:8px;padding:6px 10px;cursor:pointer;font-size:.95rem;transition:all .2s;color:var(--gold);flex-shrink:0}
.ey-speak-btn.sm{padding:3px 7px;font-size:.8rem}
.ey-speak-btn:hover{background:rgba(196,164,106,.2)}
.ey-word-meta{font-size:.78rem;color:var(--tx2);font-style:italic;margin-bottom:12px}
.ey-word-def{font-size:.95rem;color:var(--tx);line-height:1.5;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--bd)}

.ey-ety-section{margin-bottom:14px}
.ey-ety-label{font-size:.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--tx3);margin-bottom:6px}
.ey-ety-story{font-family:'Cormorant Garamond',serif;font-size:1rem;font-style:italic;color:var(--cream);line-height:1.6}

.ey-roots-grid{display:flex;flex-wrap:wrap;gap:8px}
.ey-root-chip{background:rgba(196,164,106,.07);border:1px solid rgba(196,164,106,.14);border-radius:10px;padding:10px 14px;flex:1;min-width:110px}
.ey-root-part{font-family:'Cormorant Garamond',serif;font-size:1.1rem;font-weight:700;color:var(--gold2)}
.ey-root-meaning{font-size:.75rem;color:var(--tx2)}
.ey-root-lang{font-size:.62rem;color:var(--tx3);margin-top:2px}

.ey-evo{display:flex;flex-direction:column;position:relative;padding-left:20px}
.ey-evo::before{content:'';position:absolute;left:6px;top:8px;bottom:8px;width:1px;background:linear-gradient(to bottom,var(--gold),rgba(196,164,106,.2))}
.ey-evo-step{position:relative;padding:5px 0 5px 16px;font-size:.82rem;color:var(--tx2)}
.ey-evo-step::before{content:'';position:absolute;left:-17px;top:50%;transform:translateY(-50%);width:7px;height:7px;border-radius:50%;background:var(--bg);border:1.5px solid var(--gold)}
.ey-evo-step.final{color:var(--gold);font-weight:600}
.ey-evo-step.final::before{background:var(--gold)}

.ey-rel-list{display:flex;flex-wrap:wrap;gap:6px}
.ey-rel-tag{background:rgba(196,164,106,.06);border:1px solid rgba(196,164,106,.12);border-radius:20px;padding:4px 12px;font-size:.75rem;color:var(--cream)}

.ey-funfact{background:rgba(232,168,73,.06);border:1px solid rgba(232,168,73,.12);border-radius:12px;padding:14px 16px;margin-top:12px}
.ey-ff-title{font-size:.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--amber);margin-bottom:4px;font-weight:700}
.ey-ff-text{font-size:.82rem;color:var(--cream);line-height:1.6}

.ey-continue-btn{width:100%;padding:14px;background:rgba(196,164,106,.1);border:1.5px solid rgba(196,164,106,.25);border-radius:12px;color:var(--gold);font-family:'Outfit',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .2s}
.ey-continue-btn:hover{background:rgba(196,164,106,.18);transform:translateY(-2px)}

/* ─── QUIZ ─── */
.ey-quiz{position:relative;z-index:1;animation:eyIn .4s ease}
.ey-quiz-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.ey-quiz-counter{font-size:.7rem;text-transform:uppercase;letter-spacing:2px;color:var(--tx3)}
.ey-quiz-counter span{color:var(--gold)}
.ey-combo-badge{background:linear-gradient(135deg,#ff6b6b,#ffd93d);color:#000;padding:4px 12px;border-radius:20px;font-size:.72rem;font-weight:800;animation:eyPulse .6s infinite}
.ey-quiz-type{display:inline-flex;align-items:center;gap:6px;background:rgba(196,164,106,.08);border:1px solid rgba(196,164,106,.15);border-radius:20px;padding:4px 12px;font-size:.68rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--goldDim);margin-bottom:14px}
.ey-quiz-q{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:600;color:var(--warmWhite);line-height:1.4;margin-bottom:4px}
.ey-quiz-q.funfact{font-size:1.05rem;font-style:italic;color:var(--cream);background:rgba(232,168,73,.06);border:1px solid rgba(232,168,73,.12);border-radius:12px;padding:14px 16px;margin-bottom:4px}
.ey-quiz-sub{font-size:.8rem;color:var(--tx2);font-style:italic;margin-bottom:18px}

.ey-choices{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
.ey-choice{width:100%;text-align:left;padding:13px 16px;background:var(--sf);border:1.5px solid var(--bd);border-radius:12px;color:var(--tx);font-family:'Outfit',sans-serif;font-size:.85rem;line-height:1.4;cursor:pointer;transition:all .15s}
.ey-choice:hover:not(:disabled){border-color:var(--bd2);background:var(--sf2)}
.ey-choice.correct{border-color:var(--ok);background:var(--okBg);color:var(--ok);transform:scale(1.02)}
.ey-choice.wrong{border-color:var(--err);background:var(--errBg);color:var(--err);opacity:.7}
.ey-choice:disabled{cursor:default}

.ey-explanation{background:rgba(196,164,106,.06);border:1px solid rgba(196,164,106,.12);border-radius:12px;padding:12px 16px;margin-bottom:12px;animation:eyIn .3s ease}
.ey-explain-text{font-size:.82rem;color:var(--cream);line-height:1.5}

.ey-next-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--gold),var(--amber));border:none;border-radius:12px;color:var(--bg);font-family:'Outfit',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .2s}
.ey-next-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(196,164,106,.2)}

/* ─── SPEED ROUND ─── */
.ey-timer-wrap{position:relative;margin-bottom:16px}
.ey-timer-bar{height:6px;border-radius:3px;transition:width 1s linear}
.ey-timer-text{position:absolute;right:0;top:-18px;font-size:.8rem;font-weight:700;color:var(--gold)}
.ey-timer-danger{color:var(--err) !important;animation:eyPulse .5s infinite}

.ey-speed-intro,.ey-speed-done{text-align:center;position:relative;z-index:1;animation:eyIn .5s ease;padding-top:30px}
.ey-speed-icon{font-size:3.5rem;margin-bottom:8px;animation:eyBounce 1s infinite}
.ey-speed-title{font-family:'Outfit',sans-serif;font-size:2rem;font-weight:800;letter-spacing:3px;background:linear-gradient(135deg,#ffd93d,#ff6b6b,#ffd93d);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:12px}
.ey-speed-desc{color:var(--tx2);font-size:.9rem;margin-bottom:20px;line-height:1.5}
.ey-speed-stakes{display:flex;justify-content:center;gap:16px;margin-bottom:28px}
.ey-speed-stake{background:var(--sf);border:1px solid var(--bd);border-radius:10px;padding:10px 16px;font-size:.8rem;color:var(--cream)}
.ey-speed-result{font-family:'Cormorant Garamond',serif;font-size:2rem;color:var(--gold);margin-bottom:24px}

@keyframes eyBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}

/* ─── RESULTS ─── */
.ey-results{position:relative;z-index:1;animation:eyIn .6s ease;text-align:center}
.ey-res-score{font-family:'Cormorant Garamond',serif;font-size:4rem;font-weight:700;color:var(--gold);line-height:1}
.ey-res-label{font-size:.82rem;color:var(--tx2);margin-bottom:8px}
.ey-res-msg{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:500;font-style:italic;color:var(--cream);margin-bottom:20px}

.ey-res-stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:14px}
.ey-res-stat-card{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:12px 10px;text-align:center}
.ey-res-stat-val{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:700;color:var(--gold);line-height:1.1}
.ey-res-stat-lbl{font-size:.62rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--tx3);margin-top:3px;line-height:1.3}

.ey-res-streak{background:rgba(232,168,73,.08);border:1px solid rgba(232,168,73,.16);border-radius:100px;display:inline-block;padding:6px 18px;font-size:.78rem;font-weight:600;color:var(--amber);margin-bottom:14px}

.ey-res-badges{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:20px}
.ey-badge{background:var(--sf);border:1px solid var(--bd);border-radius:100px;padding:6px 16px;font-size:.78rem;font-weight:600;color:var(--cream)}
.ey-badge.gold{background:rgba(196,164,106,.12);border-color:rgba(196,164,106,.25);color:var(--gold)}

.ey-xp-level-card{background:var(--sf);border:1px solid var(--bd);border-radius:14px;padding:18px;margin-bottom:24px;text-align:left}
.ey-xlc-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.ey-xlc-level{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:700;color:var(--gold)}
.ey-xlc-title{font-size:.78rem;color:var(--goldDim);font-style:italic}
.ey-xlc-xp{font-size:.72rem;color:var(--tx3);margin-top:6px;text-align:center}

.ey-review-section{text-align:left;margin-bottom:20px}
.ey-review-title{font-size:.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--tx3);margin-bottom:10px;text-align:left}
.ey-review-card{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:14px;margin-bottom:8px}
.ey-review-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;flex-wrap:wrap;gap:6px}
.ey-review-word{display:flex;align-items:center;gap:8px;font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:700;color:var(--gold)}
.ey-review-origin{font-size:.68rem;color:var(--tx3);background:rgba(196,164,106,.06);padding:3px 10px;border-radius:20px;border:1px solid var(--bd);white-space:nowrap}
.ey-review-ety{font-size:.78rem;color:var(--tx2);font-style:italic;line-height:1.5;margin-bottom:6px}
.ey-review-roots{display:flex;flex-wrap:wrap;gap:5px}
.ey-review-root{font-size:.68rem;background:rgba(196,164,106,.06);border:1px solid rgba(196,164,106,.1);border-radius:6px;padding:3px 8px;color:var(--cream)}

.ey-done-card{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:18px;text-align:center}
.ey-done-text{font-family:'Cormorant Garamond',serif;font-size:1rem;color:var(--cream);font-style:italic;margin-bottom:4px}
.ey-done-sub{font-size:.72rem;color:var(--tx3)}

/* ─── FLOATING POPUPS ─── */
.ey-combo-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Outfit',sans-serif;font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#ff6b6b,#ffd93d);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;z-index:100;pointer-events:none;animation:eyPopup .8s ease forwards}
.ey-xp-popup{position:fixed;top:45%;left:50%;transform:translate(-50%,-50%);font-family:'Outfit',sans-serif;font-size:1.2rem;font-weight:700;color:var(--gold);z-index:100;pointer-events:none;animation:eyXpFloat 1s ease forwards;text-shadow:0 0 20px rgba(196,164,106,.5)}

@keyframes eyPopup{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}30%{opacity:1;transform:translate(-50%,-50%) scale(1.3)}100%{opacity:0;transform:translate(-50%,-80%) scale(1)}}
@keyframes eyXpFloat{0%{opacity:0;transform:translate(-50%,-50%)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-120%)}}
@keyframes eyIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes eyPulse{0%,100%{opacity:1}50%{opacity:.5}}

/* ─── KEYBOARD HINTS ─── */
.ey-choice-key{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:4px;background:rgba(196,164,106,.12);border:1px solid rgba(196,164,106,.18);font-size:.62rem;font-weight:700;color:var(--tx3);margin-right:8px;flex-shrink:0;font-family:'Outfit',sans-serif;letter-spacing:0}

/* ─── PERFECT BADGE ─── */
.ey-perfect-badge{background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(255,165,0,.1));border:1px solid rgba(255,215,0,.3);border-radius:100px;display:inline-block;padding:8px 20px;font-size:.82rem;font-weight:700;color:#ffd700;margin-bottom:12px;text-align:center;width:100%;animation:eyIn .5s ease;text-shadow:0 0 12px rgba(255,215,0,.3)}

/* ─── EXPANDED LEX CARD ─── */
.ey-profile-lex-card{cursor:pointer;transition:border-color .2s,background .2s}
.ey-profile-lex-card.open{border-color:var(--bd2);background:var(--sf2)}
.ey-lex-chevron{font-size:.6rem;color:var(--tx3);flex-shrink:0}
.ey-lex-expanded{margin-top:14px;padding-top:14px;border-top:1px solid var(--bd);animation:eyIn .3s ease}
.ey-lex-meta-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.ey-lex-meta-chip{font-size:.68rem;background:rgba(196,164,106,.08);border:1px solid var(--bd);border-radius:6px;padding:3px 10px;color:var(--tx2)}
.ey-lex-section-label{font-size:.58rem;text-transform:uppercase;letter-spacing:2px;color:var(--tx3);margin-bottom:6px}

::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:4px}

/* ─── PROFILE ─── */
.ey-profile{position:relative;z-index:1;animation:eyIn .5s ease;padding-bottom:40px}
.ey-profile-glyph-wrap{display:flex;justify-content:center;margin:4px 0 18px}
.ey-profile-title-row{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:16px}
.ey-profile-name{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:600;color:var(--gold);font-style:italic}
.ey-profile-level-badge{background:linear-gradient(135deg,var(--gold),var(--amber));color:var(--bg);padding:3px 10px;border-radius:6px;font-size:.7rem;font-weight:800;letter-spacing:1px}
.ey-profile-xp-section{margin-bottom:20px;padding:0 2px}
.ey-profile-stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:18px}
.ey-profile-stat{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:14px 10px;text-align:center}
.ey-profile-stat-val{font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:700;color:var(--gold);line-height:1.1}
.ey-profile-stat-lbl{font-size:.58rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--tx3);margin-top:4px;line-height:1.3}

.ey-profile-origins{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:14px 16px;margin-bottom:20px}
.ey-profile-origin-row{display:flex;align-items:center;gap:10px;margin-bottom:7px}
.ey-profile-origin-row:last-child{margin-bottom:0}
.ey-profile-origin-lang{font-size:.7rem;color:var(--tx2);min-width:70px;white-space:nowrap}
.ey-profile-origin-bar-wrap{flex:1;height:4px;background:var(--sf2);border-radius:2px;overflow:hidden}
.ey-profile-origin-bar{height:100%;background:linear-gradient(90deg,var(--gold),var(--amber));border-radius:2px;transition:width .8s ease}
.ey-profile-origin-count{font-size:.7rem;color:var(--tx3);min-width:16px;text-align:right;font-weight:600}

.ey-profile-lexicon{text-align:left}
.ey-profile-lex-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.ey-profile-sort-row{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.ey-profile-sort-btn{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:5px 12px;font-size:.7rem;color:var(--tx2);cursor:pointer;transition:all .15s;font-family:'Outfit',sans-serif}
.ey-profile-sort-btn.active{background:rgba(196,164,106,.12);border-color:rgba(196,164,106,.3);color:var(--gold);font-weight:600}
.ey-profile-search{width:100%;background:var(--sf);border:1px solid var(--bd);border-radius:10px;padding:10px 14px;color:var(--tx);font-family:'Outfit',sans-serif;font-size:.82rem;outline:none;margin-bottom:10px;transition:border-color .2s}
.ey-profile-search:focus{border-color:var(--bd2)}
.ey-profile-search::placeholder{color:var(--tx3)}
.ey-profile-lex-list{display:flex;flex-direction:column;gap:8px}
.ey-profile-lex-card{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:14px;cursor:pointer;transition:border-color .15s,background .15s}
.ey-profile-lex-card:hover{border-color:rgba(196,164,106,.4);background:rgba(196,164,106,.03)}
.ey-profile-lex-card.open{border-color:rgba(196,164,106,.45);background:rgba(196,164,106,.06);box-shadow:0 2px 16px rgba(196,164,106,.08)}
.ey-profile-lex-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;flex-wrap:wrap;gap:6px}
.ey-profile-lex-word{display:flex;align-items:center;gap:8px;font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:700;color:var(--gold)}
.ey-lex-chevron{font-size:.65rem;color:var(--tx3);transition:transform .2s;padding:2px 5px;background:var(--sf2);border-radius:4px}
.ey-profile-lex-card.open .ey-lex-chevron{color:var(--gold);background:rgba(196,164,106,.12)}
.ey-profile-empty{font-size:.82rem;color:var(--tx3);text-align:center;padding:24px 0;font-style:italic}

.ey-lex-expanded{border-top:1px solid var(--bd);margin-top:12px;padding-top:14px;animation:eyIn .25s ease}
.ey-lex-meta-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.ey-lex-meta-chip{background:rgba(196,164,106,.07);border:1px solid rgba(196,164,106,.12);border-radius:6px;padding:2px 8px;font-size:.68rem;color:var(--tx3)}
.ey-lex-section-label{font-size:.6rem;text-transform:uppercase;letter-spacing:2px;color:var(--tx3);margin-bottom:6px;font-weight:600}

.ey-share-btn{background:var(--sf);border:1.5px solid var(--bd);border-radius:14px;color:var(--tx2);font-family:'Outfit',sans-serif;font-size:.82rem;font-weight:600;padding:0 18px;cursor:pointer;transition:all .2s;white-space:nowrap;min-width:82px}
.ey-share-btn:hover{border-color:rgba(196,164,106,.35);color:var(--gold)}

/* ─── SPLASH SCREEN ─── */
.ey-splash{text-align:center;animation:eyIn .6s ease;padding:8px 0 40px}
.ey-splash-emblem{display:flex;justify-content:center;margin:12px 0 20px;filter:drop-shadow(0 0 28px rgba(196,164,106,.22))}
.ey-splash-title{font-family:'Cormorant Garamond',serif;font-size:2.6rem;font-weight:700;color:var(--gold);line-height:1;margin-bottom:8px;letter-spacing:-1px}
.ey-splash-tagline{font-size:.8rem;text-transform:uppercase;letter-spacing:3px;color:var(--tx3);margin-bottom:32px}

/* ─── MODE CARDS ─── */
.ey-mode-grid{display:flex;flex-direction:column;gap:14px}
.ey-mode-card{background:var(--sf);border:1px solid var(--bd);border-radius:18px;padding:22px 20px;text-align:left;cursor:pointer;transition:transform .2s,box-shadow .2s,border-color .2s;width:100%;font-family:'Outfit',sans-serif}
.ey-mode-card:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.4)}
.ey-mode-card.mode-etymology{border-color:rgba(196,164,106,.22)}
.ey-mode-card.mode-etymology:hover{border-color:rgba(196,164,106,.50);box-shadow:0 8px 36px rgba(196,164,106,.12)}
.ey-mode-card.mode-lexicon{border-color:rgba(77,184,204,.18);background:rgba(10,26,32,.7)}
.ey-mode-card.mode-lexicon:hover{border-color:rgba(77,184,204,.45);box-shadow:0 8px 36px rgba(77,184,204,.10)}
.ey-mode-card.mode-kids{border-color:rgba(245,166,35,.18);background:rgba(20,14,8,.7)}
.ey-mode-card.mode-kids:hover{border-color:rgba(245,166,35,.45);box-shadow:0 8px 36px rgba(245,166,35,.10)}
.ey-mode-icon{font-size:1.8rem;margin-bottom:10px;line-height:1}
.ey-mode-name{font-family:'Cormorant Garamond',serif;font-size:1.35rem;font-weight:700;color:var(--gold);margin-bottom:8px;line-height:1}
.mode-lexicon .ey-mode-name{color:var(--lex-accent)}
.mode-kids .ey-mode-name{color:var(--kids-bright)}
.ey-mode-desc{font-size:.82rem;color:var(--tx2);line-height:1.55;margin-bottom:12px}
.ey-mode-tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
.ey-mode-tags span{font-size:.62rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--tx3);background:var(--sf2);border:1px solid var(--bd);border-radius:20px;padding:3px 10px}
.mode-lexicon .ey-mode-tags span{border-color:rgba(77,184,204,.15);color:rgba(77,184,204,.7)}
.mode-kids .ey-mode-tags span{border-color:rgba(245,166,35,.15);color:rgba(245,166,35,.7)}
.ey-mode-cta{font-size:.78rem;font-weight:700;letter-spacing:.5px;color:var(--gold);opacity:.8}
.mode-lexicon .ey-mode-cta{color:var(--lex-accent)}
.mode-kids .ey-mode-cta{color:var(--kids-bright)}

/* ─── MODE SCREEN (lexicon / kids) ─── */
.ey-mode-screen{animation:eyIn .5s ease;padding:8px 0 40px;text-align:center}
.ey-mode-screen-emblem{font-size:3.5rem;margin-bottom:16px;line-height:1}
.ey-mode-screen-title{font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:700;color:var(--gold);margin-bottom:14px}
.ey-mode-screen-body{font-size:.9rem;color:var(--tx2);line-height:1.65;margin-bottom:26px;max-width:380px;margin-left:auto;margin-right:auto}
.ey-mode-screen-features{display:flex;flex-direction:column;gap:10px;margin-bottom:28px;text-align:left}
.ey-feature-card{background:var(--sf);border:1px solid var(--bd);border-radius:14px;padding:16px;display:flex;gap:14px;align-items:flex-start}
.lexicon-screen .ey-feature-card{border-color:rgba(77,184,204,.14);background:rgba(10,26,32,.6)}
.kids-card{border-color:rgba(245,166,35,.15)!important;background:rgba(20,12,4,.6)!important}
.ey-feature-icon{font-size:1.4rem;flex-shrink:0;line-height:1;padding-top:2px}
.ey-feature-name{font-size:.88rem;font-weight:700;color:var(--tx);margin-bottom:4px}
.ey-feature-desc{font-size:.78rem;color:var(--tx2);line-height:1.45}
.ey-mode-coming{background:var(--sf2);border:1px solid var(--bd);border-radius:16px;padding:20px;margin-top:4px}
.kids-coming{border-color:rgba(245,166,35,.18)}
.ey-coming-badge{display:inline-block;font-size:.7rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;background:linear-gradient(135deg,var(--gold),var(--amber));color:var(--bg);padding:4px 14px;border-radius:20px;margin-bottom:12px}
.ey-mode-coming p{font-size:.82rem;color:var(--tx2);margin-bottom:16px;line-height:1.5}
.ey-mode-switch-btn{background:rgba(196,164,106,.10);border:1px solid rgba(196,164,106,.35);border-radius:12px;color:var(--gold);font-family:'Outfit',sans-serif;font-size:.82rem;font-weight:700;padding:10px 20px;cursor:pointer;transition:all .2s}
.ey-mode-switch-btn:hover{background:rgba(196,164,106,.18);border-color:var(--gold)}
.kids-btn{background:rgba(245,166,35,.10)!important;border-color:rgba(245,166,35,.35)!important;color:var(--kids-bright)!important}
.kids-btn:hover{background:rgba(245,166,35,.20)!important;border-color:var(--kids-bright)!important}
.ey-kids-banner{font-size:1.4rem;letter-spacing:8px;margin-bottom:12px;animation:eyPulse 2s ease-in-out infinite}

/* ═══════════════════════════════════════════════════════════════════════════
   VOCAB BUILDER — TEAL / DEEP SEA THEME
   ═══════════════════════════════════════════════════════════════════════════ */
:root{--vb-teal:#2dd4bf;--vb-teal2:#14b8a6;--vb-deep:#0d2b2b;--vb-mid:#0f3535;--vb-bd:rgba(45,212,191,.18);--vb-bd2:rgba(45,212,191,.32);--vb-tx:rgba(224,255,252,.95);--vb-tx2:rgba(170,230,225,.72);--vb-tx3:rgba(120,190,185,.52);--vb-glow:rgba(45,212,191,.18)}

/* Welcome */
.vb-welcome{text-align:center;padding:20px 0 32px;animation:eyIn .5s ease}
.vb-welcome-emblem{font-size:2.8rem;margin-bottom:14px;filter:drop-shadow(0 0 20px rgba(45,212,191,.35))}
.vb-title{font-family:'Cormorant Garamond',serif;font-size:2.2rem;font-weight:700;color:var(--vb-teal);margin-bottom:10px;letter-spacing:-0.5px}
.vb-subtitle{font-size:.88rem;color:var(--vb-tx2);line-height:1.65;max-width:340px;margin:0 auto 22px}
.vb-feature-row{display:flex;justify-content:center;gap:10px;margin-bottom:28px;flex-wrap:wrap}
.vb-feat{background:rgba(45,212,191,.07);border:1px solid var(--vb-bd);border-radius:20px;padding:6px 14px;font-size:.78rem;color:var(--vb-tx2);display:flex;gap:6px;align-items:center}
.vb-feat-icon{font-size:1rem}
.vb-start-btn{background:linear-gradient(135deg,var(--vb-teal2),var(--vb-teal));color:var(--vb-deep);font-family:'Outfit',sans-serif;font-size:.92rem;font-weight:800;padding:14px 32px;border:none;border-radius:14px;cursor:pointer;letter-spacing:.5px;transition:all .2s;box-shadow:0 4px 20px rgba(45,212,191,.3)}
.vb-start-btn:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(45,212,191,.4)}

/* Learn card */
.vb-learn-card{animation:eyIn .4s ease;padding-bottom:24px}
.vb-learn-progress{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.vb-phase-label{font-size:.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--vb-tx3);font-weight:700}
.vb-progress-dots{display:flex;gap:6px;align-items:center}
.vb-dot{width:8px;height:8px;border-radius:50%;background:rgba(45,212,191,.15);border:1px solid var(--vb-bd);transition:all .3s}
.vb-dot.done{background:var(--vb-teal2);border-color:var(--vb-teal2)}
.vb-dot.active{background:var(--vb-teal);border-color:var(--vb-teal);box-shadow:0 0 8px var(--vb-teal);width:10px;height:10px}
.vb-word-row{display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:4px}
.vb-word{font-family:'Cormorant Garamond',serif;font-size:2.4rem;font-weight:700;color:var(--vb-teal);letter-spacing:-0.5px;line-height:1.1}
.vb-tone-badge{font-size:.65rem;text-transform:uppercase;letter-spacing:2px;font-weight:800;color:var(--vb-teal2);background:rgba(45,212,191,.1);border:1px solid var(--vb-bd);border-radius:20px;padding:4px 10px;white-space:nowrap}
.vb-tone-badge.small{font-size:.6rem;padding:3px 8px}
.vb-ipa{font-size:.78rem;color:var(--vb-tx3);margin-bottom:4px;letter-spacing:.5px}
.vb-pos{color:var(--vb-teal2);font-style:italic;margin-left:8px}
.vb-def{font-size:1.05rem;color:var(--vb-tx);line-height:1.55;margin-bottom:18px;font-weight:500}
.vb-sentence-block{background:rgba(45,212,191,.06);border-left:3px solid var(--vb-teal2);border-radius:0 10px 10px 0;padding:14px 16px;margin-bottom:16px}
.vb-sentence-label{font-size:.6rem;text-transform:uppercase;letter-spacing:2.5px;color:var(--vb-teal2);font-weight:800;margin-bottom:8px}
.vb-sentence{margin:0;font-size:.9rem;color:var(--vb-tx2);line-height:1.65;font-style:italic}
.vb-anchor-toggle{background:transparent;border:1px dashed var(--vb-bd2);border-radius:10px;color:var(--vb-tx3);font-size:.78rem;padding:8px 16px;cursor:pointer;width:100%;transition:all .2s;margin-bottom:10px;font-family:'Outfit',sans-serif}
.vb-anchor-toggle:hover{border-color:var(--vb-teal);color:var(--vb-teal)}
.vb-anchor-block{background:rgba(45,212,191,.05);border:1px solid var(--vb-bd);border-radius:12px;padding:14px 16px;margin-bottom:14px;animation:eyIn .3s ease}
.vb-anchor-label{font-size:.6rem;text-transform:uppercase;letter-spacing:2.5px;color:var(--vb-teal);font-weight:800;margin-bottom:6px}
.vb-anchor-text{margin:0;font-size:.85rem;color:var(--vb-tx2);line-height:1.6}
.vb-synonyms{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px}
.vb-syn{font-size:.72rem;color:var(--vb-tx3);background:rgba(45,212,191,.06);border:1px solid var(--vb-bd);border-radius:20px;padding:3px 10px}
.vb-learn-nav{display:flex;gap:10px;justify-content:flex-end}
.vb-nav-btn{background:rgba(45,212,191,.1);border:1px solid var(--vb-bd2);color:var(--vb-teal);font-family:'Outfit',sans-serif;font-size:.84rem;font-weight:700;padding:11px 22px;border-radius:12px;cursor:pointer;transition:all .2s}
.vb-nav-btn:hover{background:rgba(45,212,191,.18);border-color:var(--vb-teal)}
.vb-nav-btn.secondary{background:transparent;border-color:rgba(45,212,191,.2);color:var(--vb-tx3)}
.vb-nav-btn.secondary:hover{border-color:var(--vb-bd2);color:var(--vb-tx2)}
.vb-nav-btn.primary-glow{background:linear-gradient(135deg,var(--vb-teal2),var(--vb-teal));color:var(--vb-deep);border-color:transparent;box-shadow:0 4px 18px rgba(45,212,191,.3)}
.vb-nav-btn.primary-glow:hover{box-shadow:0 6px 24px rgba(45,212,191,.45);transform:translateY(-1px)}

/* Quiz */
.vb-quiz-wrap{animation:eyIn .4s ease;padding-bottom:24px}
.vb-quiz-progress-bar{height:3px;background:rgba(45,212,191,.1);border-radius:3px;margin-bottom:18px;overflow:hidden}
.vb-quiz-progress-fill{height:100%;background:linear-gradient(90deg,var(--vb-teal2),var(--vb-teal));border-radius:3px;transition:width .4s ease}
.vb-quiz-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.vb-quiz-counter{font-size:.75rem;color:var(--vb-tx3);font-weight:700}
.vb-quiz-word{font-family:'Cormorant Garamond',serif;font-size:2.6rem;font-weight:700;color:var(--vb-teal);text-align:center;margin-bottom:8px;letter-spacing:-0.5px}
.vb-quiz-prompt{font-size:.85rem;color:var(--vb-tx2);text-align:center;margin-bottom:18px}
.vb-quiz-blank-sentence{font-size:.9rem;color:var(--vb-tx);line-height:1.65;background:rgba(45,212,191,.06);border-left:3px solid var(--vb-teal2);border-radius:0 10px 10px 0;padding:14px 16px;margin:0 0 18px;font-style:italic}
.vb-quiz-options{display:flex;flex-direction:column;gap:9px;margin-bottom:14px}
.vb-opt{background:rgba(45,212,191,.06);border:1px solid var(--vb-bd);border-radius:12px;color:var(--vb-tx);font-family:'Outfit',sans-serif;font-size:.88rem;padding:13px 18px;cursor:pointer;text-align:left;transition:all .2s;display:flex;justify-content:space-between;align-items:center}
.vb-opt:hover:not(:disabled){background:rgba(45,212,191,.13);border-color:var(--vb-bd2);transform:translateX(3px)}
.vb-opt:disabled{cursor:default}
.vb-opt.vb-opt-correct{background:rgba(45,212,191,.18);border-color:var(--vb-teal);color:var(--vb-teal)}
.vb-opt.vb-opt-wrong{background:rgba(255,80,80,.12);border-color:rgba(255,100,100,.45);color:rgba(255,130,130,.9)}
.vb-opt-tick{color:var(--vb-teal);font-weight:800;font-size:1rem}
.vb-opt-cross{color:rgba(255,120,120,.9);font-weight:800;font-size:1rem}
.vb-quiz-feedback{border-radius:12px;padding:12px 16px;margin-bottom:14px;font-size:.85rem;line-height:1.55;animation:eyIn .3s ease}
.vb-quiz-feedback.correct{background:rgba(45,212,191,.1);border:1px solid rgba(45,212,191,.3);color:var(--vb-tx2)}
.vb-quiz-feedback.wrong{background:rgba(255,80,80,.08);border:1px solid rgba(255,100,100,.25);color:rgba(255,180,180,.85)}
.vb-next-btn{width:100%;background:linear-gradient(135deg,var(--vb-teal2),var(--vb-teal));color:var(--vb-deep);font-family:'Outfit',sans-serif;font-size:.9rem;font-weight:800;padding:13px;border:none;border-radius:12px;cursor:pointer;transition:all .2s;box-shadow:0 4px 16px rgba(45,212,191,.25)}
.vb-next-btn:hover{transform:translateY(-1px);box-shadow:0 6px 22px rgba(45,212,191,.38)}

/* Results */
.vb-results{text-align:center;padding:16px 0 32px;animation:eyIn .5s ease}
.vb-results-emblem{font-size:2.4rem;margin-bottom:12px;filter:drop-shadow(0 0 16px rgba(45,212,191,.4))}
.vb-results-title{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;color:var(--vb-teal);margin-bottom:6px}
.vb-results-msg{font-size:.88rem;color:var(--vb-tx2);margin-bottom:20px;font-style:italic}
.vb-results-score{background:rgba(45,212,191,.08);border:1px solid var(--vb-bd);border-radius:16px;padding:16px 24px;display:inline-block;margin-bottom:12px}
.vb-score-num{font-family:'Cormorant Garamond',serif;font-size:3rem;font-weight:700;color:var(--vb-teal);line-height:1}
.vb-score-den{font-size:1.6rem;color:var(--vb-tx3)}
.vb-score-label{font-size:.72rem;text-transform:uppercase;letter-spacing:2px;color:var(--vb-tx3);margin-top:4px}
.vb-results-xp{font-size:.8rem;color:var(--vb-teal2);font-weight:700;letter-spacing:1px;margin-bottom:22px}
.vb-results-words{text-align:left;background:rgba(45,212,191,.05);border:1px solid var(--vb-bd);border-radius:14px;padding:16px;margin-bottom:22px}
.vb-results-words-label{font-size:.62rem;text-transform:uppercase;letter-spacing:2.5px;color:var(--vb-teal);font-weight:800;margin-bottom:12px}
.vb-results-word-row{display:flex;align-items:baseline;gap:8px;padding:7px 0;border-bottom:1px solid rgba(45,212,191,.08);flex-wrap:wrap}
.vb-results-word-row:last-child{border-bottom:none}
.vb-results-word-name{font-family:'Cormorant Garamond',serif;font-size:1.1rem;font-weight:700;color:var(--vb-teal);flex-shrink:0}
.vb-results-word-def{font-size:.78rem;color:var(--vb-tx2);flex:1;line-height:1.4}
.vb-results-nav{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
`;






const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<WordSparkEtymology />);
  </script>
</body>
</html>
